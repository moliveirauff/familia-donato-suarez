<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìè Matheus: Crescimento - Fam√≠lia Donato Suarez</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #f4f7f6;
      --text: #333;
      --card-bg: #ffffff;
      --primary: #2c3e50;
      --accent: #3498db;
      --border: #e2e8f0;
      --success: #48bb78;
      --warning: #ed8936;
      --danger: #f56565;
    }

    body.dark-mode {
      --bg: #1a1a1a;
      --text: #e0e0e0;
      --card-bg: #2d2d2d;
      --border: #4a5568;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 10px;
      padding-bottom: 60px;
      transition: background 0.3s, color 0.3s;
    }

    #theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0,0,0,0.05);
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    body.dark-mode #theme-toggle {
      background: rgba(255,255,255,0.1);
    }

    .nav-link {
      text-decoration: none;
      color: var(--accent);
      font-size: 0.9rem;
      margin: 10px 0 0 10px;
      display: inline-block;
    }

    h1 {
      text-align: center;
      font-size: 1.8rem;
      margin: 15px 0 5px 0;
      font-weight: 800;
    }

    .subtitle {
      text-align: center;
      font-size: 0.8rem;
      color: #718096;
      margin-bottom: 25px;
    }

    .section {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      margin: 0 10px 20px 10px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border);
    }

    .section-icon {
      font-size: 1.75rem;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .chart-container {
      position: relative;
      margin-bottom: 2rem;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .chart-subtitle {
      font-size: 0.875rem;
      color: #718096;
    }

    .time-filters {
      display: flex;
      gap: 0.5rem;
      background: var(--bg);
      padding: 0.25rem;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .time-filter-btn {
      padding: 0.4rem 0.8rem;
      border: none;
      background: transparent;
      color: #718096;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .time-filter-btn:hover {
      background: rgba(52, 152, 219, 0.1);
      color: var(--accent);
    }

    .time-filter-btn.active {
      background: var(--accent);
      color: white;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: #718096;
    }

    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (min-width: 768px) {
      body {
        max-width: 900px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <button id="theme-toggle" onclick="toggleTheme()">üåô</button>
  <a href="index.html" class="nav-link">‚Üê Voltar para In√≠cio</a>
  <h1>üìè Matheus: Crescimento</h1>
  <div class="subtitle" id="last-update">Carregando...</div>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p style="margin-top: 1rem;">Carregando dados...</p>
  </div>

  <div id="content" style="display: none;">
    <section class="section">
      <div class="section-header">
        <span class="section-icon">üìä</span>
        <h2 class="section-title">Ganho de Peso (M√©dia Semanal)</h2>
      </div>
      
      <div class="chart-container">
        <div class="chart-header">
          <div class="chart-subtitle">Ganho m√©dio de peso por semana (g/dia)</div>
          <div class="time-filters">
            <button class="time-filter-btn" data-period="1">1m</button>
            <button class="time-filter-btn" data-period="3">3m</button>
            <button class="time-filter-btn" data-period="6">6m</button>
            <button class="time-filter-btn active" data-period="all">Total</button>
          </div>
        </div>
        <canvas id="chartGanhoPeso"></canvas>
      </div>
    </section>
  </div>

  <script>
    const BASE_URL = 'https://moliveirauff.github.io/familia-donato-suarez/data';
    let globalData = null;
    let chartInstance = null;
    let currentPeriod = 'all';

    // Theme toggle
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      const icon = document.getElementById('theme-toggle');
      const isDark = document.body.classList.contains('dark-mode');
      icon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark-mode');
      document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
    }

    // Load data
    async function loadData() {
      try {
        const [pesoRef, crianca] = await Promise.all([
          fetch(`${BASE_URL}/peso-referencia.json?v=${Date.now()}`).then(r => r.json()),
          fetch(`${BASE_URL}/matheus-crescimento.json?v=${Date.now()}`).then(r => r.json())
        ]);

        return { pesoRef, crianca };
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        document.getElementById('loading').innerHTML = '<p style="color: var(--danger);">‚ùå Erro ao carregar dados. Tente novamente.</p>';
        throw error;
      }
    }

    // Interpola√ß√£o linear
    function interpolar(idade, curva) {
      for (let i = 0; i < curva.length - 1; i++) {
        if (idade >= curva[i].idade_meses && idade <= curva[i + 1].idade_meses) {
          const p1 = curva[i];
          const p2 = curva[i + 1];
          const t = (idade - p1.idade_meses) / (p2.idade_meses - p1.idade_meses);
          return p1.valor + t * (p2.valor - p1.valor);
        }
      }
      return curva[curva.length - 1].valor;
    }

    // Filter by period
    function filterByPeriod(medicoes, periodMonths) {
      if (periodMonths === 'all') return medicoes;
      
      const maxIdade = Math.max(...medicoes.map(m => m.idade_meses));
      const minIdade = Math.max(0, maxIdade - periodMonths);
      
      return medicoes.filter(m => m.idade_meses >= minIdade);
    }

    // Calcular ganho semanal (m√©dia m√≥vel de 7 dias)
    function calcularGanhoSemanalMovingAvg(medicoes, curvaP50) {
      const ganhosSemanas = [];
      
      // Calcular ganho di√°rio entre cada par de medi√ß√µes
      const ganhosDiarios = [];
      for (let i = 0; i < medicoes.length - 1; i++) {
        const m1 = medicoes[i];
        const m2 = medicoes[i + 1];
        
        if (m1.peso_kg === null || m2.peso_kg === null) continue;
        
        const diasIntervalo = (m2.idade_meses - m1.idade_meses) * 30.44;
        const ganhoReal = ((m2.peso_kg - m1.peso_kg) / diasIntervalo) * 1000; // g/dia
        
        const esperado1 = interpolar(m1.idade_meses, curvaP50);
        const esperado2 = interpolar(m2.idade_meses, curvaP50);
        const ganhoEsperado = ((esperado2 - esperado1) / diasIntervalo) * 1000; // g/dia
        
        ganhosDiarios.push({
          idadeMeses: (m1.idade_meses + m2.idade_meses) / 2,
          data: m2.data,
          ganhoReal: ganhoReal,
          ganhoEsperado: ganhoEsperado,
          diasIntervalo: diasIntervalo
        });
      }
      
      // Agrupar por semanas (grupos de ~7 dias) e calcular m√©dia
      const DIAS_POR_SEMANA = 7;
      let somaGanhoReal = 0;
      let somaGanhoEsperado = 0;
      let somaDias = 0;
      let count = 0;
      let primeiraData = null;
      let ultimaData = null;
      
      for (let i = 0; i < ganhosDiarios.length; i++) {
        const ganho = ganhosDiarios[i];
        
        if (!primeiraData) primeiraData = ganho.data;
        ultimaData = ganho.data;
        
        somaGanhoReal += ganho.ganhoReal;
        somaGanhoEsperado += ganho.ganhoEsperado;
        somaDias += ganho.diasIntervalo;
        count++;
        
        // Quando acumular ~7 dias, criar ponto
        if (somaDias >= DIAS_POR_SEMANA || i === ganhosDiarios.length - 1) {
          const mediaGanhoReal = somaGanhoReal / count;
          const mediaGanhoEsperado = somaGanhoEsperado / count;
          
          ganhosSemanas.push({
            label: new Date(ultimaData).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'}),
            real: mediaGanhoReal,
            esperado: mediaGanhoEsperado,
            numMedicoes: count,
            periodo: `${new Date(primeiraData).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})} - ${new Date(ultimaData).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})}`
          });
          
          // Reset para pr√≥xima semana
          somaGanhoReal = 0;
          somaGanhoEsperado = 0;
          somaDias = 0;
          count = 0;
          primeiraData = null;
          ultimaData = null;
        }
      }
      
      return ganhosSemanas;
    }

    // Render chart
    function renderChart(period = 'all') {
      const { pesoRef, crianca } = globalData;
      const sexo = crianca.metadata.sexo;
      
      const medicoesComPeso = crianca.medicoes.filter(m => m.peso_kg !== null);
      const dadosFiltrados = filterByPeriod(medicoesComPeso, period);
      
      const ganhosSemanas = calcularGanhoSemanalMovingAvg(dadosFiltrados, pesoRef[sexo].p50);
      
      if (chartInstance) chartInstance.destroy();
      
      const ctx = document.getElementById('chartGanhoPeso').getContext('2d');
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ganhosSemanas.map(g => g.label),
          datasets: [
            {
              label: 'Esperado (P50)',
              data: ganhosSemanas.map(g => g.esperado),
              type: 'line',
              borderColor: '#3498db',
              borderWidth: 3,
              borderDash: [5, 5],
              fill: false,
              pointRadius: 4,
              pointHoverRadius: 6
            },
            {
              label: 'Real (m√©dia semanal)',
              data: ganhosSemanas.map(g => g.real),
              backgroundColor: ganhosSemanas.map(g => {
                if (g.real < 0) return '#f56565';
                if (g.real < g.esperado) return '#ed8936';
                return '#48bb78';
              }),
              borderWidth: 1,
              borderColor: '#fff'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1.8,
          plugins: {
            legend: { 
              display: true,
              position: 'top'
            },
            tooltip: {
              callbacks: {
                title: function(context) {
                  const idx = context[0].dataIndex;
                  const ganho = ganhosSemanas[idx];
                  return ganho.periodo;
                },
                label: function(context) {
                  const idx = context.dataIndex;
                  const ganho = ganhosSemanas[idx];
                  if (context.dataset.label.includes('Real')) {
                    return [
                      `Real: ${context.parsed.y.toFixed(1)} g/dia`,
                      `Medi√ß√µes na semana: ${ganho.numMedicoes}`
                    ];
                  }
                  return `${context.dataset.label}: ${context.parsed.y.toFixed(1)} g/dia`;
                }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false }
            },
            y: {
              title: { 
                display: true, 
                text: 'Ganho M√©dio (g/dia)',
                font: { weight: 'bold' }
              },
              beginAtZero: true
            }
          }
        }
      });
    }

    // Time filter event listeners
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('time-filter-btn')) {
        const period = e.target.dataset.period;
        
        document.querySelectorAll('.time-filter-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        e.target.classList.add('active');
        
        currentPeriod = period === 'all' ? 'all' : parseInt(period);
        renderChart(currentPeriod);
      }
    });

    // Init
    async function init() {
      globalData = await loadData();
      
      const ultimaMedicao = globalData.crianca.medicoes[globalData.crianca.medicoes.length - 1];
      document.getElementById('last-update').textContent = 
        `√öltima atualiza√ß√£o: ${new Date(ultimaMedicao.data).toLocaleDateString('pt-BR')} - ${ultimaMedicao.peso_kg} kg`;
      
      renderChart(currentPeriod);
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
    }

    init();
  </script>
</body>
</html>
