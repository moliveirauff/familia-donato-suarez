<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üí∞ Financeiro ‚Äì Fam√≠lia Donato Su√°rez</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #f0f4f8;
      --card: #ffffff;
      --text: #1a202c;
      --text-muted: #718096;
      --border: #e2e8f0;
      --primary: #4f46e5;
      --primary-light: #eef2ff;
      --green: #10b981;
      --green-light: #ecfdf5;
      --red: #ef4444;
      --red-light: #fef2f2;
      --yellow: #f59e0b;
      --shadow: 0 1px 3px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.06);
      --radius: 16px;
    }
    body.dark {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #334155;
      --primary-light: #312e81;
      --green-light: #064e3b;
      --red-light: #450a0a;
      --shadow: 0 1px 3px rgba(0,0,0,.3), 0 4px 16px rgba(0,0,0,.3);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      transition: background .3s, color .3s;
    }
    /* HEADER */
    header {
      background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
      color: white;
      padding: 1.5rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .header-left h1 { font-size: 1.5rem; font-weight: 700; }
    .header-left p { font-size: .875rem; opacity: .8; margin-top: .2rem; }
    .header-right { display: flex; gap: .5rem; align-items: center; }
    .btn {
      padding: .5rem 1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: .875rem;
      font-weight: 600;
      transition: all .2s;
    }
    .btn-ghost { background: rgba(255,255,255,.15); color: white; }
    .btn-ghost:hover { background: rgba(255,255,255,.25); }
    .btn-primary { background: white; color: #4f46e5; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.2); }
    /* MAIN */
    main { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }
    /* FILTERS */
    .filters {
      display: flex;
      gap: .75rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
      align-items: center;
    }
    .filters select, .filters input {
      padding: .5rem .75rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: .875rem;
      cursor: pointer;
    }
    .filters select:focus, .filters input:focus { outline: 2px solid #4f46e5; border-color: transparent; }
    .filters label { font-size: .875rem; color: var(--text-muted); font-weight: 500; }
    /* SUMMARY CARDS */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1.25rem 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    .summary-card { display: flex; align-items: center; gap: 1rem; }
    .summary-icon {
      width: 48px; height: 48px;
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.4rem;
      flex-shrink: 0;
    }
    .summary-icon.green { background: var(--green-light); }
    .summary-icon.red { background: var(--red-light); }
    .summary-icon.blue { background: var(--primary-light); }
    .summary-icon.yellow { background: #fffbeb; }
    .summary-data .label { font-size: .75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: .05em; }
    .summary-data .value { font-size: 1.5rem; font-weight: 700; margin-top: .1rem; }
    .summary-data .value.green { color: var(--green); }
    .summary-data .value.red { color: var(--red); }
    .summary-data .value.blue { color: #4f46e5; }
    /* CHARTS GRID */
    .charts-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 768px) { .charts-grid { grid-template-columns: 1fr; } }
    .card-title {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    .chart-wrap { position: relative; height: 280px; }
    /* BUDGET BARS */
    .budget-list { display: flex; flex-direction: column; gap: .75rem; }
    .budget-item .budget-header {
      display: flex;
      justify-content: space-between;
      font-size: .8rem;
      margin-bottom: .3rem;
    }
    .budget-item .budget-name { font-weight: 600; }
    .budget-item .budget-pct { color: var(--text-muted); }
    .budget-bar-bg {
      height: 6px;
      background: var(--border);
      border-radius: 99px;
      overflow: hidden;
    }
    .budget-bar-fill {
      height: 100%;
      border-radius: 99px;
      transition: width .6s ease;
    }
    /* TRANSACTIONS */
    .trans-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: .5rem;
    }
    .trans-search {
      padding: .4rem .75rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: .875rem;
      width: 200px;
    }
    .trans-table { width: 100%; border-collapse: collapse; }
    .trans-table th {
      text-align: left;
      font-size: .75rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: .05em;
      padding: .5rem .75rem;
      border-bottom: 2px solid var(--border);
    }
    .trans-table td {
      padding: .75rem;
      border-bottom: 1px solid var(--border);
      font-size: .875rem;
      vertical-align: middle;
    }
    .trans-table tr:last-child td { border-bottom: none; }
    .trans-table tr:hover td { background: var(--bg); }
    .cat-badge {
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      padding: .2rem .6rem;
      border-radius: 99px;
      font-size: .75rem;
      font-weight: 600;
      background: var(--primary-light);
      color: var(--primary);
    }
    .amount { font-weight: 700; font-variant-numeric: tabular-nums; }
    .amount.receita { color: var(--green); }
    .amount.despesa { color: var(--red); }
    .pago-badge {
      display: inline-block;
      padding: .15rem .5rem;
      border-radius: 99px;
      font-size: .7rem;
      font-weight: 700;
    }
    .pago-badge.pago { background: var(--green-light); color: var(--green); }
    .pago-badge.pendente { background: #fffbeb; color: var(--yellow); }
    /* PAGINATION */
    .pagination { display: flex; gap: .5rem; justify-content: center; margin-top: 1rem; }
    .page-btn {
      width: 32px; height: 32px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      font-size: .875rem;
      font-weight: 600;
    }
    .page-btn.active { background: #4f46e5; color: white; border-color: #4f46e5; }
    .page-btn:hover:not(.active) { background: var(--bg); }
    /* MODAL */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      display: flex; align-items: center; justify-content: center;
      z-index: 100;
      display: none;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--card);
      border-radius: var(--radius);
      padding: 2rem;
      width: min(480px, 95vw);
      box-shadow: 0 20px 60px rgba(0,0,0,.3);
    }
    .modal h2 { font-size: 1.1rem; font-weight: 700; margin-bottom: 1.5rem; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-size: .8rem; font-weight: 600; color: var(--text-muted); margin-bottom: .3rem; text-transform: uppercase; letter-spacing: .05em; }
    .form-group input, .form-group select {
      width: 100%;
      padding: .6rem .75rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: .9rem;
    }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .type-toggle { display: flex; gap: .5rem; }
    .type-btn {
      flex: 1;
      padding: .6rem;
      border-radius: 8px;
      border: 2px solid var(--border);
      background: transparent;
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
      font-size: .875rem;
      transition: all .2s;
    }
    .type-btn.active.receita { background: var(--green-light); border-color: var(--green); color: var(--green); }
    .type-btn.active.despesa { background: var(--red-light); border-color: var(--red); color: var(--red); }
    .modal-actions { display: flex; gap: .75rem; margin-top: 1.5rem; justify-content: flex-end; }
    .btn-cancel { background: var(--border); color: var(--text); padding: .6rem 1.25rem; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
    .btn-save { background: #4f46e5; color: white; padding: .6rem 1.25rem; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
    .btn-save:hover { background: #4338ca; }
    /* EMPTY */
    .empty { text-align: center; padding: 3rem; color: var(--text-muted); }
    .empty .empty-icon { font-size: 3rem; }
    /* RESPONSIVE */
    @media (max-width: 600px) {
      header { padding: 1rem; }
      main { padding: 1rem; }
      .trans-table th:nth-child(4),
      .trans-table td:nth-child(4),
      .trans-table th:nth-child(5),
      .trans-table td:nth-child(5) { display: none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <h1>üí∞ Dashboard Financeiro</h1>
      <p id="header-subtitle">Fam√≠lia Donato Su√°rez</p>
    </div>
    <div class="header-right">
      <button class="btn btn-ghost" onclick="openModal()">+ Nova Transa√ß√£o</button>
      <button class="btn btn-ghost" id="theme-btn" onclick="toggleTheme()">üåô</button>
    </div>
  </header>

  <main>
    <!-- FILTERS -->
    <div class="filters">
      <label>Per√≠odo:</label>
      <select id="filter-month" onchange="applyFilters()"></select>
      <label>Categoria:</label>
      <select id="filter-cat" onchange="applyFilters()">
        <option value="">Todas</option>
      </select>
      <label>Tipo:</label>
      <select id="filter-type" onchange="applyFilters()">
        <option value="">Todos</option>
        <option value="receita">Receitas</option>
        <option value="despesa">Despesas</option>
      </select>
    </div>

    <!-- SUMMARY -->
    <div class="summary-grid">
      <div class="card summary-card">
        <div class="summary-icon green">üí∞</div>
        <div class="summary-data">
          <div class="label">Receitas</div>
          <div class="value green" id="total-receitas">R$ 0</div>
        </div>
      </div>
      <div class="card summary-card">
        <div class="summary-icon red">üí∏</div>
        <div class="summary-data">
          <div class="label">Despesas</div>
          <div class="value red" id="total-despesas">R$ 0</div>
        </div>
      </div>
      <div class="card summary-card">
        <div class="summary-icon blue">üìä</div>
        <div class="summary-data">
          <div class="label">Saldo</div>
          <div class="value blue" id="saldo">R$ 0</div>
        </div>
      </div>
      <div class="card summary-card">
        <div class="summary-icon yellow">üè¶</div>
        <div class="summary-data">
          <div class="label">Pendente</div>
          <div class="value" id="pendente" style="color:var(--yellow)">R$ 0</div>
        </div>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="charts-grid">
      <div class="card">
        <div class="card-title">üìà Receitas vs Despesas (6 meses)</div>
        <div class="chart-wrap"><canvas id="bar-chart"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">ü•ß Despesas por Categoria</div>
        <div class="chart-wrap"><canvas id="pie-chart"></canvas></div>
      </div>
    </div>

    <!-- BUDGET -->
    <div class="card" style="margin-bottom:1.5rem" id="budget-section">
      <div class="card-title">üéØ Or√ßamento por Categoria (m√™s atual)</div>
      <div class="budget-list" id="budget-list"></div>
    </div>

    <!-- TRANSACTIONS -->
    <div class="card">
      <div class="trans-header">
        <div class="card-title" style="margin:0">üìã Transa√ß√µes</div>
        <input class="trans-search" type="text" placeholder="üîç Buscar..." id="search-input" oninput="applyFilters()">
      </div>
      <div style="overflow-x:auto">
        <table class="trans-table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Descri√ß√£o</th>
              <th>Categoria</th>
              <th>Tipo</th>
              <th>Status</th>
              <th style="text-align:right">Valor</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="trans-body"></tbody>
        </table>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>
  </main>

  <!-- MODAL -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <h2 id="modal-title">‚ûï Nova Transa√ß√£o</h2>
      <div class="type-toggle" style="margin-bottom:1rem">
        <button class="type-btn active receita" id="btn-receita" onclick="setType('receita')">üí∞ Receita</button>
        <button class="type-btn despesa" id="btn-despesa" onclick="setType('despesa')">üí∏ Despesa</button>
      </div>
      <div class="form-group">
        <label>Descri√ß√£o</label>
        <input type="text" id="form-desc" placeholder="Ex: Supermercado">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Valor (R$)</label>
          <input type="number" id="form-valor" placeholder="0,00" step="0.01" min="0">
        </div>
        <div class="form-group">
          <label>Data</label>
          <input type="date" id="form-data">
        </div>
      </div>
      <div class="form-group">
        <label>Categoria</label>
        <select id="form-cat"></select>
      </div>
      <div class="form-group">
        <label>Status</label>
        <select id="form-pago">
          <option value="true">‚úÖ Pago/Recebido</option>
          <option value="false">‚è≥ Pendente</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
        <button class="btn-save" onclick="saveTransaction()">Salvar</button>
      </div>
    </div>
  </div>

<script>
// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let DATA = null;
let filteredTrans = [];
let currentPage = 1;
const PAGE_SIZE = 10;
let barChart = null;
let pieChart = null;
let editingId = null;
let currentType = 'receita';

// ‚îÄ‚îÄ‚îÄ LOAD DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadData() {
  try {
    const r = await fetch('data/financeiro.json?v=' + Date.now());
    DATA = await r.json();
  } catch(e) {
    console.error(e);
    alert('Erro ao carregar dados financeiros.');
    return;
  }
  initFilters();
  applyFilters();
}

// ‚îÄ‚îÄ‚îÄ INIT FILTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initFilters() {
  // months
  const months = [...new Set(DATA.transacoes.map(t => t.data.slice(0,7)))].sort().reverse();
  const sel = document.getElementById('filter-month');
  sel.innerHTML = '<option value="">Todos os meses</option>' +
    months.map(m => `<option value="${m}" ${m === months[0] ? 'selected' : ''}>${fmtMonth(m)}</option>`).join('');

  // categories
  const catSel = document.getElementById('filter-cat');
  const allCats = [...DATA.categorias_despesa, ...DATA.categorias_receita];
  catSel.innerHTML = '<option value="">Todas</option>' +
    allCats.map(c => `<option value="${c.id}">${c.icone} ${c.nome}</option>`).join('');

  // modal form cats (initial)
  updateModalCats('receita');
}

function updateModalCats(type) {
  const cats = type === 'receita' ? DATA.categorias_receita : DATA.categorias_despesa;
  document.getElementById('form-cat').innerHTML =
    cats.map(c => `<option value="${c.id}">${c.icone} ${c.nome}</option>`).join('');
}

// ‚îÄ‚îÄ‚îÄ APPLY FILTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyFilters() {
  const month = document.getElementById('filter-month').value;
  const cat = document.getElementById('filter-cat').value;
  const type = document.getElementById('filter-type').value;
  const search = document.getElementById('search-input').value.toLowerCase();

  filteredTrans = DATA.transacoes.filter(t => {
    if (month && !t.data.startsWith(month)) return false;
    if (cat && t.categoria !== cat) return false;
    if (type && t.tipo !== type) return false;
    if (search && !t.descricao.toLowerCase().includes(search)) return false;
    return true;
  }).sort((a,b) => b.data.localeCompare(a.data));

  currentPage = 1;
  renderSummary();
  renderCharts();
  renderBudget(month || getCurrentMonth());
  renderTransactions();
}

function getCurrentMonth() {
  return new Date().toISOString().slice(0,7);
}

// ‚îÄ‚îÄ‚îÄ SUMMARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSummary() {
  const receitas = filteredTrans.filter(t => t.tipo === 'receita').reduce((s,t) => s + t.valor, 0);
  const despesas = filteredTrans.filter(t => t.tipo === 'despesa').reduce((s,t) => s + t.valor, 0);
  const saldo = receitas - despesas;
  const pendente = filteredTrans.filter(t => !t.pago).reduce((s,t) => s + t.valor, 0);

  document.getElementById('total-receitas').textContent = fmtBRL(receitas);
  document.getElementById('total-despesas').textContent = fmtBRL(despesas);
  const saldoEl = document.getElementById('saldo');
  saldoEl.textContent = fmtBRL(saldo);
  saldoEl.className = 'value ' + (saldo >= 0 ? 'green' : 'red');
  document.getElementById('pendente').textContent = fmtBRL(pendente);
}

// ‚îÄ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCharts() {
  // Bar chart ‚Äì last 6 months
  const months = getLast6Months();
  const receitasByMonth = months.map(m =>
    DATA.transacoes.filter(t => t.data.startsWith(m) && t.tipo === 'receita').reduce((s,t) => s+t.valor, 0)
  );
  const despesasByMonth = months.map(m =>
    DATA.transacoes.filter(t => t.data.startsWith(m) && t.tipo === 'despesa').reduce((s,t) => s+t.valor, 0)
  );

  const isDark = document.body.classList.contains('dark');
  const gridColor = isDark ? 'rgba(255,255,255,.08)' : 'rgba(0,0,0,.06)';
  const textColor = isDark ? '#94a3b8' : '#718096';

  if (barChart) barChart.destroy();
  barChart = new Chart(document.getElementById('bar-chart'), {
    type: 'bar',
    data: {
      labels: months.map(fmtMonth),
      datasets: [
        { label: 'Receitas', data: receitasByMonth, backgroundColor: '#10b981cc', borderRadius: 6 },
        { label: 'Despesas', data: despesasByMonth, backgroundColor: '#ef4444cc', borderRadius: 6 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: textColor } } },
      scales: {
        x: { ticks: { color: textColor }, grid: { color: gridColor } },
        y: { ticks: { color: textColor, callback: v => 'R$' + (v/1000).toFixed(0) + 'k' }, grid: { color: gridColor } }
      }
    }
  });

  // Pie chart ‚Äì despesas by category (filtered)
  const despTrans = filteredTrans.filter(t => t.tipo === 'despesa');
  const byCat = {};
  despTrans.forEach(t => { byCat[t.categoria] = (byCat[t.categoria] || 0) + t.valor; });
  const catIds = Object.keys(byCat);
  const catData = catIds.map(id => ({ id, val: byCat[id], cat: DATA.categorias_despesa.find(c => c.id === id) }));

  if (pieChart) pieChart.destroy();
  if (catData.length === 0) {
    pieChart = null;
    return;
  }
  pieChart = new Chart(document.getElementById('pie-chart'), {
    type: 'doughnut',
    data: {
      labels: catData.map(d => d.cat ? d.cat.icone + ' ' + d.cat.nome : d.id),
      datasets: [{
        data: catData.map(d => d.val),
        backgroundColor: catData.map(d => d.cat ? d.cat.cor : '#a0aec0'),
        borderWidth: 2,
        borderColor: isDark ? '#1e293b' : '#fff'
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      cutout: '60%',
      plugins: {
        legend: { position: 'bottom', labels: { color: textColor, boxWidth: 12, font: { size: 11 } } },
        tooltip: { callbacks: { label: ctx => ` ${fmtBRL(ctx.parsed)}` } }
      }
    }
  });
}

function getLast6Months() {
  const result = [];
  const d = new Date();
  for (let i = 5; i >= 0; i--) {
    const dd = new Date(d.getFullYear(), d.getMonth() - i, 1);
    result.push(dd.toISOString().slice(0,7));
  }
  return result;
}

// ‚îÄ‚îÄ‚îÄ BUDGET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderBudget(month) {
  const list = document.getElementById('budget-list');
  const monthTrans = DATA.transacoes.filter(t => t.data.startsWith(month) && t.tipo === 'despesa');
  const byCat = {};
  monthTrans.forEach(t => { byCat[t.categoria] = (byCat[t.categoria] || 0) + t.valor; });

  list.innerHTML = DATA.categorias_despesa.map(cat => {
    const spent = byCat[cat.id] || 0;
    const pct = cat.orcamento_mensal > 0 ? Math.min((spent / cat.orcamento_mensal) * 100, 100) : 0;
    const color = pct > 90 ? '#ef4444' : pct > 70 ? '#f59e0b' : '#10b981';
    return `
      <div class="budget-item">
        <div class="budget-header">
          <span class="budget-name">${cat.icone} ${cat.nome}</span>
          <span class="budget-pct">${fmtBRL(spent)} / ${fmtBRL(cat.orcamento_mensal)} (${pct.toFixed(0)}%)</span>
        </div>
        <div class="budget-bar-bg">
          <div class="budget-bar-fill" style="width:${pct}%;background:${color}"></div>
        </div>
      </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ TRANSACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTransactions() {
  const body = document.getElementById('trans-body');
  const total = filteredTrans.length;
  const pages = Math.ceil(total / PAGE_SIZE);
  const slice = filteredTrans.slice((currentPage-1)*PAGE_SIZE, currentPage*PAGE_SIZE);

  if (slice.length === 0) {
    body.innerHTML = '<tr><td colspan="7"><div class="empty"><div class="empty-icon">üîç</div><p>Nenhuma transa√ß√£o encontrada.</p></div></td></tr>';
  } else {
    body.innerHTML = slice.map(t => {
      const allCats = [...DATA.categorias_despesa, ...DATA.categorias_receita];
      const cat = allCats.find(c => c.id === t.categoria);
      const catName = cat ? `${cat.icone} ${cat.nome}` : t.categoria;
      const catColor = cat ? cat.cor : '#a0aec0';
      return `
        <tr>
          <td style="white-space:nowrap">${fmtDate(t.data)}</td>
          <td>${t.descricao}</td>
          <td><span class="cat-badge" style="background:${catColor}22;color:${catColor}">${catName}</span></td>
          <td>${t.tipo === 'receita' ? 'üí∞ Receita' : 'üí∏ Despesa'}</td>
          <td><span class="pago-badge ${t.pago ? 'pago' : 'pendente'}">${t.pago ? 'Pago' : 'Pendente'}</span></td>
          <td style="text-align:right"><span class="amount ${t.tipo}">${t.tipo === 'receita' ? '+' : '-'}${fmtBRL(t.valor)}</span></td>
          <td><button style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:1rem" onclick="deleteTransaction('${t.id}')">üóëÔ∏è</button></td>
        </tr>`;
    }).join('');
  }

  // Pagination
  const pag = document.getElementById('pagination');
  pag.innerHTML = '';
  for (let i = 1; i <= pages; i++) {
    const btn = document.createElement('button');
    btn.className = 'page-btn' + (i === currentPage ? ' active' : '');
    btn.textContent = i;
    btn.onclick = () => { currentPage = i; renderTransactions(); };
    pag.appendChild(btn);
  }
}

// ‚îÄ‚îÄ‚îÄ ADD / DELETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal() {
  editingId = null;
  document.getElementById('modal-title').textContent = '‚ûï Nova Transa√ß√£o';
  document.getElementById('form-desc').value = '';
  document.getElementById('form-valor').value = '';
  document.getElementById('form-data').value = new Date().toISOString().slice(0,10);
  document.getElementById('form-pago').value = 'true';
  setType('receita');
  document.getElementById('modal-overlay').classList.add('open');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
}

function setType(type) {
  currentType = type;
  document.getElementById('btn-receita').className = 'type-btn receita' + (type === 'receita' ? ' active' : '');
  document.getElementById('btn-despesa').className = 'type-btn despesa' + (type === 'despesa' ? ' active' : '');
  updateModalCats(type);
}

function saveTransaction() {
  const desc = document.getElementById('form-desc').value.trim();
  const valor = parseFloat(document.getElementById('form-valor').value);
  const data = document.getElementById('form-data').value;
  const cat = document.getElementById('form-cat').value;
  const pago = document.getElementById('form-pago').value === 'true';

  if (!desc || !valor || !data) { alert('Preencha todos os campos obrigat√≥rios.'); return; }

  const newT = {
    id: 't' + Date.now(),
    data, tipo: currentType, categoria: cat, descricao: desc, valor, pago
  };

  DATA.transacoes.push(newT);
  closeModal();
  applyFilters();
  showToast('Transa√ß√£o adicionada! üéâ');
}

function deleteTransaction(id) {
  if (!confirm('Excluir esta transa√ß√£o?')) return;
  DATA.transacoes = DATA.transacoes.filter(t => t.id !== id);
  applyFilters();
  showToast('Transa√ß√£o removida.');
}

// ‚îÄ‚îÄ‚îÄ THEME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTheme() {
  document.body.classList.toggle('dark');
  document.getElementById('theme-btn').textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
  renderCharts();
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtBRL(v) {
  return 'R$ ' + v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function fmtDate(s) {
  const [y,m,d] = s.split('-');
  return `${d}/${m}/${y}`;
}
function fmtMonth(s) {
  const [y,m] = s.split('-');
  const names = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
  return names[parseInt(m)-1] + ' ' + y;
}

function showToast(msg) {
  const t = document.createElement('div');
  t.textContent = msg;
  Object.assign(t.style, {
    position:'fixed', bottom:'1.5rem', right:'1.5rem',
    background:'#4f46e5', color:'white', padding:'.75rem 1.25rem',
    borderRadius:'12px', fontWeight:'600', fontSize:'.875rem',
    boxShadow:'0 4px 20px rgba(0,0,0,.2)', zIndex:'200',
    transition:'opacity .3s'
  });
  document.body.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 2500);
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if (localStorage.getItem('theme') === 'dark') {
  document.body.classList.add('dark');
  document.getElementById('theme-btn').textContent = '‚òÄÔ∏è';
}

document.getElementById('modal-overlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeModal();
});

loadData();
</script>
</body>
</html>
