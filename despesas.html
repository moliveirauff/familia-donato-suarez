<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’¸ Dashboard de Despesas</title>
    <meta name="version" content="v1.13.3">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #f7fafc;
            --text: #2d3748;
            --surface: #ffffff;
            --card-bg: var(--surface);
            --border: #e2e8f0;
            --text-muted: #718096;
            --subtext: var(--text-muted);
            --primary: #667eea;
            --primary-dark: #5568d3;
            --accent: var(--primary);
            --accent-light: #ebf4ff;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --green: #48bb78;
            --yellow: #ed8936;
            --red: #f56565;
            --shadow: 0 1px 3px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.06);
        }
        body.dark-mode {
            --bg: #1a202c;
            --text: #f7fafc;
            --surface: #2d3748;
            --card-bg: var(--surface);
            --border: #4a5568;
            --text-muted: #cbd5e0;
            --subtext: var(--text-muted);
            --primary: #7f9cf5;
            --accent: var(--primary);
            --accent-light: #2a3a6e;
            --green: #68d391;
            --yellow: #f6ad55;
            --red: #fc8181;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s;
            padding: 10px 10px 60px 10px;
        }
        /* â”€â”€ CabeÃ§alho â”€â”€ */
        #theme-toggle {
            position: absolute; top: 12px; right: 12px;
            background: rgba(0,0,0,0.05); border: none; font-size: 1.2rem; cursor: pointer;
            padding: 8px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            z-index: 10; transition: background 0.2s;
        }
        body.dark-mode #theme-toggle { background: rgba(255,255,255,0.1); }
        .nav-link {
            text-decoration: none;
            color: var(--primary);
            font-size: 0.9rem;
            margin: 10px 0 0 4px;
            display: inline-block;
        }
        h1 {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 800;
            margin: 10px 44px 4px 44px; /* lateral margin compensa o toggle absoluto */
            color: var(--text);
        }
        .page-subtitle {
            text-align: center;
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-bottom: 18px;
        }
        /* Period filters */
        .period-bar {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 14px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .period-label { font-size: 0.75rem; font-weight: 700; color: var(--subtext); text-transform: uppercase; margin-right: 4px; }
        .btn-period {
            background: var(--border);
            border: none;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-period:hover { opacity: 0.8; }
        .btn-period.active { background: var(--accent); color: white; }
        /* Cards */
        .card {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .card-header {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .card-controls { display: flex; align-items: center; gap: 8px; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        select.cat-select {
            background: var(--border);
            border: none;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            outline: none;
        }
        /* Budget bars */
        .budget-item { margin-bottom: 14px; }
        .budget-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; font-size: 0.82rem; }
        .budget-cat { font-weight: 700; }
        .budget-vals { color: var(--subtext); font-size: 0.78rem; }
        .budget-track { background: var(--border); border-radius: 99px; height: 10px; overflow: hidden; }
        .budget-fill { height: 100%; border-radius: 99px; transition: width 0.5s ease; }
        .budget-fill.green { background: var(--green); }
        .budget-fill.yellow { background: var(--yellow); }
        .budget-fill.red { background: var(--red); }
        .loading-msg { text-align: center; padding: 40px; color: var(--subtext); font-size: 1rem; }
        @media (min-width: 768px) {
            body { max-width: 960px; margin: 0 auto; padding: 16px 16px 60px 16px; }
            .chart-container { height: 380px; }
            .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            .two-col-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
            h1 { font-size: 1.75rem; }
        }
        /* Mobile: tab nav nÃ£o overflow em telas muito pequenas */
        @media (max-width: 400px) {
            .tab-btn { font-size: 0.75rem; padding: 8px 4px; }
            h1 { font-size: 1.2rem; }
        }
        /* â”€â”€â”€ Tab Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .tab-nav {
            display: flex;
            gap: 4px;
            margin-bottom: 14px;
        }
        .tab-btn {
            flex: 1;
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 9px 8px;
            border-radius: 10px 10px 0 0;
            font-size: 0.83rem;
            font-weight: 700;
            color: var(--subtext);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            white-space: nowrap;
        }
        .tab-btn:hover { color: var(--text); border-color: var(--accent); }
        .tab-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        /* â”€â”€â”€ Aba 2 KPI Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .kpi-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        @media (min-width: 600px) { .kpi-grid { grid-template-columns: repeat(4, 1fr); } }
        /* Editor filter bar: empilha em mobile */
        @media (max-width: 599px) {
            .editor-filters { flex-direction: column !important; }
            .editor-filters > div { width: 100%; }
            .editor-filters select,
            .editor-filters input { width: 100% !important; min-width: unset !important; box-sizing: border-box; }
        }
        .kpi-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .kpi-emoji { font-size: 1.4rem; }
        .kpi-label { font-size: 0.7rem; font-weight: 700; color: var(--subtext); text-transform: uppercase; letter-spacing: 0.03em; }
        .kpi-value { font-size: 1.1rem; font-weight: 800; color: var(--text); }
        .kpi-sub { font-size: 0.72rem; color: var(--subtext); margin-top: 2px; }
        .kpi-sub .pos { color: var(--red); }
        .kpi-sub .neg { color: var(--green); }
    </style>
</head>
<body>
    <button id="theme-toggle" onclick="toggleTheme()">ğŸŒ™</button>
    <a href="index.html" class="nav-link">â† Voltar para InÃ­cio</a>
    <h1>ğŸ’¸ Dashboard de Despesas</h1>
    <p id="last-update" class="page-subtitle" style="display:none; font-size: 0.72rem; margin-top: 4px; opacity: 0.8;"></p>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab(1)">ğŸ“Š Consolidado</button>
        <button class="tab-btn" onclick="switchTab(2)">ğŸ“… AnÃ¡lise Mensal</button>
        <button class="tab-btn" onclick="switchTab(3)">âœï¸ Editor</button>
    </div>

    <!-- Month Selector (Tab 2) -->
    <div id="month-selector" style="display:none; text-align:center; margin-bottom: 16px; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap;">
        <button onclick="changeMonth(-1)" style="background:var(--card-bg); border:1px solid var(--border); border-radius: 50%; width: 36px; height: 36px; cursor: pointer; color: var(--text); font-weight: bold;">&lt;</button>
        <select id="month-dropdown" onchange="onMonthDropdownChange()" style="background:var(--card-bg); border:1px solid var(--border); border-radius:10px; padding:6px 12px; font-size:0.9rem; font-weight:700; color:var(--text); cursor:pointer; outline:none;"></select>
        <button onclick="changeMonth(1)" style="background:var(--card-bg); border:1px solid var(--border); border-radius: 50%; width: 36px; height: 36px; cursor: pointer; color: var(--text); font-weight: bold;">&gt;</button>
    </div>

    <!-- Period Filter -->
    <div class="period-bar" id="period-bar">
        <span class="period-label">PerÃ­odo:</span>
        <button class="btn-period" onclick="setPeriod('ano_atual', this)">Ano Atual</button>
        <button class="btn-period active" onclick="setPeriod('12m', this)">12M</button>
        <button class="btn-period" onclick="setPeriod('24m', this)">24M</button>
        <button class="btn-period" onclick="setPeriod('36m', this)">36M</button>
        <button class="btn-period" onclick="setPeriod('todos', this)">Todos</button>
    </div>

    <div id="loading" class="loading-msg">â³ Carregando dados...</div>

    <!-- â•â•â• ABA 2 â€” MÃªs Atual â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="tab2" style="display:none;">

        <!-- 1: KPI Cards -->
        <div class="kpi-grid" id="kpi-grid"></div>

        <!-- 2: Barras por categoria -->
        <div class="card">
            <div class="card-header"><span id="kpi-bar-title">ğŸ“Š Gastos por Categoria</span></div>
            <div class="chart-container"><canvas id="cT2B"></canvas></div>
        </div>

        <!-- 3: Subcategorias do mÃªs -->
        <div class="card">
            <div class="card-header">
                <span id="kpi-subcat-title">ğŸ“Š Detalhe por Categoria</span>
                <div class="card-controls">
                    <select id="selT2D" class="cat-select" onchange="renderTab2()"></select>
                </div>
            </div>
            <div class="chart-container"><canvas id="cT2D"></canvas></div>
        </div>

        <!-- 4: ComparaÃ§Ã£o com OrÃ§amento -->
        <div class="card">
            <div class="card-header">
                <span>ğŸ¯ ComparaÃ§Ã£o com OrÃ§amento Mensal</span>
            </div>
            <div id="budgetChartTab2"></div>
        </div>

        <!-- 5: Acumulado dia a dia -->
        <div class="card">
            <div class="card-header"><span id="kpi-acc-title">ğŸ“ˆ Gasto Acumulado Dia a Dia</span></div>
            <div class="chart-container"><canvas id="cT2C"></canvas></div>
        </div>

        <!-- 6 + 7: Pizzas Categoria e Subcategoria -->
        <div class="two-col-grid">
            <!-- 6: Pizza por Categoria -->
            <div class="card">
                <div class="card-header">
                    <span>ğŸ¥§ % por Categoria</span>
                </div>
                <div class="chart-container"><canvas id="cT2P1"></canvas></div>
            </div>

            <!-- 7: Pizza por Subcategoria -->
            <div class="card">
                <div class="card-header">
                    <span>ğŸ¥§ % por Subcategoria</span>
                    <div class="card-controls">
                        <select id="selT2P2" class="cat-select" onchange="renderT2P2()"></select>
                    </div>
                </div>
                <div class="chart-container"><canvas id="cT2P2"></canvas></div>
            </div>
        </div>

        <!-- 8: Pizza por Origem -->
        <div class="card">
            <div class="card-header">
                <span>ğŸ¦ Gastos por Origem</span>
            </div>
            <div class="chart-container"><canvas id="cT2P3"></canvas></div>
        </div>

    </div>

    <!-- â•â•â• ABA 3 â€” Editor â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="tab3" style="display:none;">

        <!-- Filter Bar -->
        <div class="card" style="margin-bottom:14px;">
            <div class="editor-filters" style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                <div>
                    <label style="font-size:0.72rem; font-weight:700; color:var(--subtext); display:block; margin-bottom:3px;">ğŸ“… MÃŠS</label>
                    <select id="ed-month" class="cat-select" onchange="onEdCatChange()" style="min-width:130px;">
                        <option value="__all__">Todos os meses</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:0.72rem; font-weight:700; color:var(--subtext); display:block; margin-bottom:3px;">ğŸ—‚ï¸ CATEGORIA</label>
                    <select id="ed-cat" class="cat-select" onchange="onEdCatChange()" style="min-width:140px;">
                        <option value="__all__">Todas</option>
                        <option value="__sem__" style="color:#f87171; font-weight:700;">âš ï¸ Sem Categoria</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:0.72rem; font-weight:700; color:var(--subtext); display:block; margin-bottom:3px;">ğŸ“‚ SUBCATEGORIA</label>
                    <select id="ed-subcat" class="cat-select" onchange="renderEditor()" style="min-width:130px;">
                        <option value="__all__">Todas</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:0.72rem; font-weight:700; color:var(--subtext); display:block; margin-bottom:3px;">ğŸ¦ ORIGEM</label>
                    <select id="ed-orig" class="cat-select" onchange="renderEditor()" style="min-width:120px;">
                        <option value="__all__">Todas</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:0.72rem; font-weight:700; color:var(--subtext); display:block; margin-bottom:3px;">ğŸ” BUSCA</label>
                    <input id="ed-search" type="text" placeholder="DescriÃ§Ã£o..." oninput="renderEditor()"
                        style="background:var(--border); border:none; padding:5px 10px; border-radius:8px; font-size:0.8rem; color:var(--text); outline:none; min-width:150px;">
                </div>
                <div style="display:flex; gap:6px; padding-bottom:1px;">
                    <button onclick="toggleEditorFilter('sem')" id="btn-filter-sem" class="btn-period"
                        style="white-space:nowrap; font-size:0.75rem;">âš ï¸ Sem Cat.</button>
                    <button onclick="toggleEditorFilter('todos')" id="btn-filter-todos" class="btn-period active"
                        style="white-space:nowrap; font-size:0.75rem;">Todos</button>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div id="ed-summary" style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px; padding: 0 4px;"></div>

        <!-- Button Bar -->
        <div style="margin-bottom: 14px; padding: 0 4px;">
            <button onclick="openAddModal()"
                style="background:var(--primary); color:white; border:none; padding:9px 18px; border-radius:8px; font-size:0.85rem; font-weight:700; cursor:pointer; min-height:44px; transition:opacity 0.2s;">
                â• Novo LanÃ§amento
            </button>
        </div>

        <!-- Table -->
        <div class="card" style="padding:0; overflow:hidden;">
            <div style="overflow-x:auto;">
                <table id="ed-table" style="width:100%; border-collapse:collapse; font-size:0.82rem;">
                    <thead>
                        <tr style="background:var(--border); text-align:left;">
                            <th style="padding:10px 10px; font-weight:700; white-space:nowrap;">Data</th>
                            <th style="padding:10px 10px; font-weight:700;">DescriÃ§Ã£o</th>
                            <th style="padding:10px 10px; font-weight:700;">Categoria</th>
                            <th style="padding:10px 10px; font-weight:700;">Subcategoria</th>
                            <th style="padding:10px 10px; font-weight:700; text-align:right; white-space:nowrap;">Valor</th>
                            <th style="padding:10px 10px; font-weight:700;">Origem</th>
                            <th style="padding:10px 10px; font-weight:700; text-align:center;">AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody id="ed-tbody"></tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- â•â•â• MODAL â€” Add/Edit â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="ed-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); z-index:1000; align-items:center; justify-content:center; padding:20px;">
        <div style="background:var(--card-bg); border-radius:16px; padding:22px; width:100%; max-width:480px; border:1px solid var(--border);">
            <h3 id="modal-title" style="font-size:1rem; font-weight:800; margin-bottom:16px;">LanÃ§amento</h3>
            <div style="display:grid; gap:12px;">
                <div>
                    <label style="font-size:0.75rem; font-weight:700; color:var(--subtext); display:block; margin-bottom:3px;">Data *</label>
                    <input id="m-data" type="date" style="width:100%; background:var(--border); border:1px solid var(--border); border-radius:8px; padding:7px 10px; color:var(--text); font-size:0.85rem; outline:none;">
                </div>
                <div>
                    <label style="font-size:0.75rem; font-weight:700; color:var(--subtext); display:block; margin-bottom:3px;">DescriÃ§Ã£o *</label>
                    <input id="m-desc" type="text" placeholder="Ex: Supermercado Extra" style="width:100%; background:var(--border); border:1px solid var(--border); border-radius:8px; padding:7px 10px; color:var(--text); font-size:0.85rem; outline:none;">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>
                        <label style="font-size:0.75rem; font-weight:700; color:var(--subtext); display:block; margin-bottom:3px;">Categoria *</label>
                        <select id="m-cat" style="width:100%; background:var(--border); border:1px solid var(--border); border-radius:8px; padding:7px 10px; color:var(--text); font-size:0.85rem; outline:none;" onchange="updateModalSubcat()">
                            <option value="">-- Selecionar --</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.75rem; font-weight:700; color:var(--subtext); display:block; margin-bottom:3px;">Subcategoria</label>
                        <select id="m-subcat" style="width:100%; background:var(--border); border:1px solid var(--border); border-radius:8px; padding:7px 10px; color:var(--text); font-size:0.85rem; outline:none;">
                            <option value="">-- Selecionar --</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>
                        <label style="font-size:0.75rem; font-weight:700; color:var(--subtext); display:block; margin-bottom:3px;">Valor (R$) *</label>
                        <input id="m-valor" type="number" step="0.01" placeholder="Ex: -150.00" style="width:100%; background:var(--border); border:1px solid var(--border); border-radius:8px; padding:7px 10px; color:var(--text); font-size:0.85rem; outline:none;">
                    </div>
                    <div>
                        <label style="font-size:0.75rem; font-weight:700; color:var(--subtext); display:block; margin-bottom:3px;">Origem</label>
                        <select id="m-orig" style="width:100%; background:var(--border); border:1px solid var(--border); border-radius:8px; padding:7px 10px; color:var(--text); font-size:0.85rem; outline:none;"></select>
                    </div>
                </div>
            </div>
            <div id="modal-error" style="color:#f87171; font-size:0.8rem; margin-top:8px; display:none;"></div>
            <div style="display:flex; gap:10px; margin-top:18px; justify-content:flex-end;">
                <button onclick="closeModal()" style="background:var(--border); border:none; padding:8px 18px; border-radius:8px; font-size:0.85rem; font-weight:600; color:var(--text); cursor:pointer; min-height:44px;">Cancelar</button>
                <button onclick="saveModal()" style="background:var(--primary); color:white; border:none; padding:8px 18px; border-radius:8px; font-size:0.85rem; font-weight:700; cursor:pointer; min-height:44px;">Salvar</button>
            </div>
        </div>
    </div>

    <div id="dashboard" style="display:none;">

        <!-- 1: KPI Cards (Aba 1) -->
        <div class="kpi-grid" id="kpi-grid-aba1"></div>

        <!-- A: Total de Gastos por MÃªs -->
        <div class="card">
            <div class="card-header">
                <span>ğŸ“… Total de Gastos por MÃªs</span>
            </div>
            <div class="chart-container"><canvas id="cA"></canvas></div>
        </div>

        <!-- C: Total por MÃªs com filtros de Categoria e Subcategoria -->
        <div class="card">
            <div class="card-header">
                <span>ğŸ“… Gastos por MÃªs</span>
                <div class="card-controls">
                    <select id="selC" class="cat-select" onchange="onSelCChange()"></select>
                    <select id="selCSub" class="cat-select" onchange="renderC()"></select>
                </div>
            </div>
            <div class="chart-container"><canvas id="cC"></canvas></div>
        </div>

        <div class="grid-2">
            <!-- D: Pizza por Categoria -->
            <div class="card">
                <div class="card-header">
                    <span>ğŸ¥§ % por Categoria</span>
                </div>
                <div class="chart-container"><canvas id="cD"></canvas></div>
            </div>

            <!-- E: Pizza por Subcategoria -->
            <div class="card">
                <div class="card-header">
                    <span>ğŸ¥§ % por Subcategoria</span>
                    <div class="card-controls">
                        <select id="selE" class="cat-select" onchange="renderE()"></select>
                    </div>
                </div>
                <div class="chart-container"><canvas id="cE"></canvas></div>
            </div>
        </div>

        <!-- H: Por Origem -->
        <div class="card">
            <div class="card-header">
                <span>ğŸ¦ Gastos por Origem</span>
            </div>
            <div class="chart-container"><canvas id="cH"></canvas></div>
        </div>

    </div>

    <script>
    // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let allData = [];
    let filteredData = [];
    let categorias = {};
    let subcategoriasPorCat = {}; // { catId: [subcat, ...] }
    let origens = {};
    let orcamento = {};
    let currentPeriod = '12m';

    // Chart instances
    let charts = {};

    // â”€â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        document.getElementById('theme-toggle').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        Chart.defaults.color = isDark ? '#cbd5e0' : '#718096';
        Chart.defaults.borderColor = isDark ? '#4a5568' : '#e2e8f0';
        Object.values(charts).forEach(c => c && c.update());
    }

    // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function brl(v) {
        return 'R$ ' + Math.abs(v).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Retorna a data do Ãºltimo lanÃ§amento em allData como referÃªncia de "hoje"
    function getRefDate() {
        const lastKey = allData.reduce((max, r) => r.data > max ? r.data : max, '');
        return lastKey ? new Date(lastKey + 'T00:00') : new Date();
    }

    function getDateBoundary(period) {
        const refDate = getRefDate();
        refDate.setHours(0,0,0,0);
        if (period === 'todos') return new Date('2000-01-01');
        if (period === 'ano_atual') return new Date(refDate.getFullYear(), 0, 1);
        const monthsMap = { '12m': 12, '24m': 24, '36m': 36 };
        const m = monthsMap[period] || 12;
        // MÃªs de referÃªncia + (M-1) meses anteriores completos (total M meses)
        return new Date(refDate.getFullYear(), refDate.getMonth() - (m - 1), 1);
    }

    function applyFilter(period) {
        const boundary = getDateBoundary(period);
        filteredData = allData.filter(r => {
            const d = new Date(r.data);
            return d >= boundary && r.valor < 0 && r.categoria !== 'receitas';
        });
    }

    // Build sorted month keys from filteredData
    function getMonthKeys() {
        const set = new Set();
        filteredData.forEach(r => {
            const [y, m] = r.data.split('-');
            set.add(`${y}-${m}`);
        });
        const keys = Array.from(set).sort();

        // Regra dia 25: se o Ãºltimo lanÃ§amento for do mÃªs corrente real E o dia atual < 25,
        // excluir o mÃªs corrente do divisor da mÃ©dia (mÃªs incompleto).
        // Se o Ãºltimo lanÃ§amento for de mÃªs anterior ao real, nÃ£o aplicar a exclusÃ£o.
        const realToday = new Date();
        const realTodayKey = `${realToday.getFullYear()}-${String(realToday.getMonth() + 1).padStart(2, '0')}`;
        const refDate = getRefDate();
        const refKey = `${refDate.getFullYear()}-${String(refDate.getMonth() + 1).padStart(2, '0')}`;
        if (refKey === realTodayKey && realToday.getDate() < 25) {
            return keys.filter(k => k !== realTodayKey);
        }
        return keys;
    }

    function monthLabel(key) {
        const [y, m] = key.split('-');
        return `${m}/${y}`;
    }

    const CAT_COLORS = [
        '#2563eb','#16a34a','#dc2626','#ca8a04','#7c3aed',
        '#0891b2','#ea580c','#be185d','#059669','#4b5563'
    ];

    // â”€â”€â”€ Period UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setPeriod(period, btn) {
        currentPeriod = period;
        document.querySelectorAll('.btn-period').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        applyFilter(period);
        renderAll();
    }

    // â”€â”€â”€ KPI Aba 1 (Consolidado) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderKPIsAba1() {
        const container = document.getElementById('kpi-grid-aba1');
        if (!container) return;

        // 1. Total no PerÃ­odo
        const totalPeriodo = filteredData.reduce((s, r) => s + Math.abs(r.valor), 0);

        // 2. MÃ©dia Mensal â€” divisor = monthKeys.length (meses com dados reais no perÃ­odo)
        const monthKeys = getMonthKeys();
        const numMonths = monthKeys.length || 1;
        const mediaMensal = totalPeriodo / numMonths;

        // 3. Maior Categoria
        const catTotals = {};
        filteredData.forEach(r => {
            catTotals[r.categoria] = (catTotals[r.categoria] || 0) + Math.abs(r.valor);
        });
        const sortedCats = Object.entries(catTotals).sort((a,b) => b[1] - a[1]);
        const maiorCatId = sortedCats[0] ? sortedCats[0][0] : '-';
        const maiorCatNome = categorias[maiorCatId] || maiorCatId;

        // 4. MÃªs Mais Caro
        const monthTotals = {};
        filteredData.forEach(r => {
            const [y, m] = r.data.split('-');
            const key = `${y}-${m}`;
            monthTotals[key] = (monthTotals[key] || 0) + Math.abs(r.valor);
        });
        const sortedMonths = Object.entries(monthTotals).sort((a,b) => b[1] - a[1]);
        const mesMaisCaroKey = sortedMonths[0] ? sortedMonths[0][0] : '-';
        const mesMaisCaroLabel = mesMaisCaroKey !== '-' ? monthLabel(mesMaisCaroKey) : '-';

        container.innerHTML = `
            <div class="kpi-card">
                <span class="kpi-emoji">ğŸ’°</span>
                <span class="kpi-label">Total no PerÃ­odo</span>
                <span class="kpi-value">${brl(totalPeriodo)}</span>
                <span class="kpi-sub">Soma lÃ­quida de gastos</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-emoji">ğŸ“…</span>
                <span class="kpi-label">MÃ©dia Mensal</span>
                <span class="kpi-value">${brl(mediaMensal)}</span>
                <span class="kpi-sub">Base: ${numMonths} meses</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-emoji">ğŸ†</span>
                <span class="kpi-label">Maior Categoria</span>
                <span class="kpi-value" style="font-size: 0.95rem;">${maiorCatNome}</span>
                <span class="kpi-sub">Categoria com mais gastos</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-emoji">ğŸ”¥</span>
                <span class="kpi-label">MÃªs Mais Caro</span>
                <span class="kpi-value">${mesMaisCaroLabel}</span>
                <span class="kpi-sub">Pico de gastos no perÃ­odo</span>
            </div>
        `;
    }

    // â”€â”€â”€ Chart A â€” Total de Gastos por MÃªs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderA() {
        const monthly = {};
        filteredData.forEach(r => {
            const [y, m] = r.data.split('-');
            const key = `${y}-${m}`;
            monthly[key] = (monthly[key] || 0) + Math.abs(r.valor);
        });
        const keys = Object.keys(monthly).sort();
        const labels = keys.map(monthLabel);
        const values = keys.map(k => monthly[k]);

        if (charts['cA']) charts['cA'].destroy();
        charts['cA'] = new Chart(document.getElementById('cA'), {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Total (R$)',
                    data: values,
                    backgroundColor: '#2563eb',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => ' ' + brl(ctx.parsed.y) } }
                },
                scales: {
                    y: { ticks: { callback: v => 'R$ ' + (v/1000).toFixed(0) + 'k' } },
                    x: { ticks: { maxRotation: 45, font: { size: 10 } } }
                }
            }
        });
    }

    // â”€â”€â”€ Chart C â€” Total por MÃªs com filtros de Categoria + Subcategoria â”€â”€â”€â”€â”€
    function populateSubcatSelect(catId) {
        const sel = document.getElementById('selCSub');
        sel.innerHTML = '';
        const subs = subcategoriasPorCat[catId] || [];
        const allOpt = document.createElement('option');
        allOpt.value = '__all__';
        allOpt.textContent = 'Todas';
        sel.appendChild(allOpt);
        subs.forEach(sub => {
            const opt = document.createElement('option');
            opt.value = sub;
            opt.textContent = sub;
            sel.appendChild(opt);
        });
    }

    function onSelCChange() {
        const cat = document.getElementById('selC').value;
        populateSubcatSelect(cat);
        renderC();
    }

    function renderC() {
        const cat = document.getElementById('selC').value;
        const sub = document.getElementById('selCSub').value;

        const monthly = {};
        filteredData
            .filter(r => r.categoria === cat && (sub === '__all__' || r.subcategoria === sub))
            .forEach(r => {
                const [y, m] = r.data.split('-');
                const key = `${y}-${m}`;
                monthly[key] = (monthly[key] || 0) + Math.abs(r.valor);
            });
        const keys = Object.keys(monthly).sort();
        const labels = keys.map(monthLabel);
        const values = keys.map(k => monthly[k]);

        if (charts['cC']) charts['cC'].destroy();
        charts['cC'] = new Chart(document.getElementById('cC'), {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'Total (R$)',
                    data: values,
                    backgroundColor: '#7c3aed',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => ' ' + brl(ctx.parsed.y) } }
                },
                scales: {
                    y: { ticks: { callback: v => 'R$ ' + (v/1000).toFixed(0) + 'k' } },
                    x: { ticks: { maxRotation: 45, font: { size: 10 } } }
                }
            }
        });
    }

    // â”€â”€â”€ Chart D â€” Pizza por Categoria â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderD() {
        const totals = {};
        filteredData.forEach(r => {
            totals[r.categoria] = (totals[r.categoria] || 0) + Math.abs(r.valor);
        });
        const sorted = Object.entries(totals).sort((a,b) => b[1]-a[1]);
        const labels = sorted.map(([k]) => categorias[k] || k);
        const values = sorted.map(([,v]) => v);
        const total = values.reduce((a,b)=>a+b,0);
        const colors = sorted.map(([,],i) => CAT_COLORS[i % CAT_COLORS.length]);

        if (charts['cD']) charts['cD'].destroy();
        charts['cD'] = new Chart(document.getElementById('cD'), {
            type: 'pie',
            data: {
                labels,
                datasets: [{ data: values, backgroundColor: colors, borderWidth: 2 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { size: 11 }, padding: 8, boxWidth: 12 }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const pct = ((ctx.parsed / total) * 100).toFixed(1);
                                return ` ${brl(ctx.parsed)} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // â”€â”€â”€ Chart E â€” Pizza por Subcategoria â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderE() {
        const sel = document.getElementById('selE');
        const cat = sel.value;

        const totals = {};
        filteredData.filter(r => r.categoria === cat).forEach(r => {
            totals[r.subcategoria] = (totals[r.subcategoria] || 0) + Math.abs(r.valor);
        });
        const sorted = Object.entries(totals).sort((a,b) => b[1]-a[1]);
        const labels = sorted.map(([k]) => k);
        const values = sorted.map(([,v]) => v);
        const total = values.reduce((a,b)=>a+b,0);

        if (charts['cE']) charts['cE'].destroy();
        charts['cE'] = new Chart(document.getElementById('cE'), {
            type: 'pie',
            data: {
                labels,
                datasets: [{ data: values, backgroundColor: CAT_COLORS, borderWidth: 2 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 8, boxWidth: 12 } },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const pct = ((ctx.parsed / total) * 100).toFixed(1);
                                return ` ${brl(ctx.parsed)} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // â”€â”€â”€ Chart H â€” Por Origem â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderH() {
        const totals = {};
        filteredData.forEach(r => {
            const name = origens[r.origem] || r.origem;
            totals[name] = (totals[name] || 0) + Math.abs(r.valor);
        });
        const sorted = Object.entries(totals).sort((a,b) => b[1]-a[1]);
        const labels = sorted.map(([k]) => k);
        const values = sorted.map(([,v]) => v);
        const total = values.reduce((a,b)=>a+b,0);

        if (charts['cH']) charts['cH'].destroy();
        charts['cH'] = new Chart(document.getElementById('cH'), {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{ data: values, backgroundColor: CAT_COLORS, borderWidth: 2 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 8, boxWidth: 12 } },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const pct = ((ctx.parsed / total) * 100).toFixed(1);
                                return ` ${brl(ctx.parsed)} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // â”€â”€â”€ Render All â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderAll() {
        renderKPIsAba1();
        renderA();
        renderC();
        renderD();
        renderE();
        renderH();
    }

    // â”€â”€â”€ Tab Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let currentTab = 1;
    let selectedMonth = null; // { year, month, key }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach((b, i) => {
            b.classList.toggle('active', i + 1 === tab);
        });
        document.getElementById('period-bar').style.display = tab === 1 ? '' : 'none';
        document.getElementById('month-selector').style.display = tab === 2 ? 'flex' : 'none';
        
        document.getElementById('tab2').style.display = tab === 2 ? 'block' : 'none';
        document.getElementById('dashboard').style.display = tab === 1 ? 'block' : 'none';
        document.getElementById('tab3').style.display = tab === 3 ? 'block' : 'none';
        
        if (tab === 2 && allData.length > 0) {
            if (!selectedMonth) selectedMonth = getInitialMonth();
            renderTab2();
        }
        if (tab === 3 && allData.length > 0) {
            renderEditor();
        }
    }

    function getInitialMonth() {
        const refDate = getRefDate();
        const refKey = `${refDate.getFullYear()}-${String(refDate.getMonth() + 1).padStart(2, '0')}`;
        const despesas = allData.filter(r => r.valor < 0 && r.categoria !== 'receitas');
        const hasCur = despesas.some(r => r.data.startsWith(refKey));
        if (hasCur) return { year: refDate.getFullYear(), month: refDate.getMonth() + 1, key: refKey };
        
        const keys = [...new Set(despesas.map(r => r.data.substring(0, 7)))].sort();
        const last = keys[keys.length - 1];
        if (!last) return { year: refDate.getFullYear(), month: refDate.getMonth() + 1, key: refKey };
        const [y, m] = last.split('-').map(Number);
        return { year: y, month: m, key: last };
    }

    function changeMonth(offset) {
        if (!selectedMonth) return;
        const d = new Date(selectedMonth.year, selectedMonth.month - 1 + offset, 1);
        const y = d.getFullYear();
        const m = d.getMonth() + 1;
        const key = `${y}-${String(m).padStart(2, '0')}`;
        selectedMonth = { year: y, month: m, key };
        const dd = document.getElementById('month-dropdown');
        if (dd) dd.value = key;
        renderTab2();
    }

    function onMonthDropdownChange() {
        const dd = document.getElementById('month-dropdown');
        if (!dd || !dd.value) return;
        const [y, m] = dd.value.split('-').map(Number);
        selectedMonth = { year: y, month: m, key: dd.value };
        renderTab2();
    }

    function populateMonthDropdown() {
        const dd = document.getElementById('month-dropdown');
        if (!dd) return;
        const despesas = allData.filter(r => r.valor < 0 && r.categoria !== 'receitas');
        const keys = [...new Set(despesas.map(r => r.data.substring(0, 7)))].sort().reverse();
        dd.innerHTML = '';
        keys.forEach(k => {
            const [y, m] = k.split('-');
            const label = new Date(parseInt(y), parseInt(m)-1, 1).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            const opt = document.createElement('option');
            opt.value = k;
            opt.textContent = label.charAt(0).toUpperCase() + label.slice(1);
            dd.appendChild(opt);
        });
        if (selectedMonth) dd.value = selectedMonth.key;
    }

    // â”€â”€â”€ Aba 2 helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getDaysInMonth(year, month) {
        return new Date(year, month, 0).getDate();
    }

    function renderTab2() {
        if (!selectedMonth) return;
        const { year, month, key } = selectedMonth;
        const daysInMonth = getDaysInMonth(year, month);
        const refDate = getRefDate();
        
        let currentDay;
        const todayKey = `${refDate.getFullYear()}-${String(refDate.getMonth() + 1).padStart(2, '0')}`;
        if (key === todayKey) {
            currentDay = refDate.getDate();
        } else if (key < todayKey) {
            currentDay = daysInMonth;
        } else {
            currentDay = 0;
        }

        const despesas = allData.filter(r => r.valor < 0 && r.categoria !== 'receitas');
        const curMonthData = despesas.filter(r => r.data.startsWith(key));
        const curTotal = curMonthData.reduce((s, r) => s + Math.abs(r.valor), 0);

        const monthRef = new Date(year, month - 1, 1);
        const last12Keys = [];
        for (let i = 1; i <= 12; i++) {
            const d = new Date(monthRef);
            d.setMonth(d.getMonth() - i);
            last12Keys.push(`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`);
        }
        const last12Totals = last12Keys.map(k => {
            return despesas.filter(r => r.data.startsWith(k)).reduce((s, r) => s + Math.abs(r.valor), 0);
        });
        const total12 = last12Totals.reduce((a, b) => a + b, 0);
        const avg12 = total12 / 12;

        const kpiGrid = document.getElementById('kpi-grid');
        const lastMonthTotal = last12Totals[0] || 0;
        const vsLastMonth = lastMonthTotal > 0 ? ((curTotal / lastMonthTotal - 1) * 100) : 0;
        const vsLastCls = vsLastMonth > 0 ? 'pos' : 'neg';

        const vsAvg = avg12 > 0 ? ((curTotal / avg12 - 1) * 100) : 0;
        const vsAvgCls = vsAvg > 0 ? 'pos' : 'neg';

        const projection = currentDay > 0 ? (curTotal / currentDay * daysInMonth) : 0;
        const vsOrcProjection = (orcamento && Object.values(orcamento).reduce((a,b)=>a+b,0)) || 0;
        const vsOrcPct = vsOrcProjection > 0 ? ((projection / vsOrcProjection - 1) * 100) : 0;
        const vsOrcCls = vsOrcPct > 0 ? 'pos' : 'neg';

        kpiGrid.innerHTML = `
            <div class="kpi-card">
                <span class="kpi-emoji">ğŸ’°</span>
                <span class="kpi-label">Total no MÃªs</span>
                <span class="kpi-value">${brl(curTotal)}</span>
                <span class="kpi-sub"><span class="${vsLastCls}">${vsLastMonth > 0 ? '+' : ''}${vsLastMonth.toFixed(1)}%</span> vs mÃªs ant.</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-emoji">ğŸ“Š</span>
                <span class="kpi-label">MÃ©dia 12M</span>
                <span class="kpi-value">${brl(avg12)}</span>
                <span class="kpi-sub"><span class="${vsAvgCls}">${vsAvg > 0 ? '+' : ''}${vsAvg.toFixed(1)}%</span> vs mÃ©dia</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-emoji">ğŸ”®</span>
                <span class="kpi-label">ProjeÃ§Ã£o</span>
                <span class="kpi-value">${brl(projection)}</span>
                <span class="kpi-sub"><span class="${vsOrcCls}">${vsOrcPct > 0 ? '+' : ''}${vsOrcPct.toFixed(1)}%</span> vs orÃ§am.</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-emoji">ğŸ“…</span>
                <span class="kpi-label">Dias Restantes</span>
                <span class="kpi-value">${Math.max(0, daysInMonth - currentDay)}</span>
                <span class="kpi-sub">de ${daysInMonth} dias</span>
            </div>
        `;

        const catTotals = {};
        curMonthData.forEach(r => {
            catTotals[r.categoria] = (catTotals[r.categoria] || 0) + Math.abs(r.valor);
        });
        const catSorted = Object.entries(catTotals).sort((a, b) => b[1] - a[1]);
        const barLabels = catSorted.map(([k]) => categorias[k] || k);
        const barValues = catSorted.map(([, v]) => v);
        const barColors = catSorted.map((_, i) => CAT_COLORS[i % CAT_COLORS.length]);

        if (charts['cT2B']) charts['cT2B'].destroy();
        charts['cT2B'] = new Chart(document.getElementById('cT2B'), {
            type: 'bar',
            data: {
                labels: barLabels,
                datasets: [{ label: 'Total (R$)', data: barValues, backgroundColor: barColors, borderRadius: 6 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => ' ' + brl(ctx.parsed.y) } }
                },
                scales: {
                    y: { ticks: { callback: v => 'R$ ' + (v / 1000).toFixed(0) + 'k' } },
                    x: { ticks: { font: { size: 11 } } }
                }
            }
        });

        const selT2D = document.getElementById('selT2D');
        const selCat = selT2D.value || 'alimentacao';
        const subTotals = {};
        curMonthData.filter(r => r.categoria === selCat).forEach(r => {
            const sub = r.subcategoria || 'NÃ£o definida';
            subTotals[sub] = (subTotals[sub] || 0) + Math.abs(r.valor);
        });
        const subSorted = Object.entries(subTotals).sort((a,b) => b[1] - a[1]);
        const subLabels = subSorted.map(([k]) => k);
        const subValues = subSorted.map(([,v]) => v);

        if (charts['cT2D']) charts['cT2D'].destroy();
        charts['cT2D'] = new Chart(document.getElementById('cT2D'), {
            type: 'bar',
            data: {
                labels: subLabels,
                datasets: [{ label: 'Total (R$)', data: subValues, backgroundColor: '#7c3aed', borderRadius: 6 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => ' ' + brl(ctx.parsed.y) } }
                },
                scales: {
                    y: { ticks: { callback: v => 'R$ ' + (v / 1000).toFixed(0) + 'k' } },
                    x: { ticks: { font: { size: 11 } } }
                }
            }
        });

        const budgetContainer = document.getElementById('budgetChartTab2');
        budgetContainer.innerHTML = '';
        const orcCats = Object.keys(orcamento);
        orcCats.forEach(catId => {
            const orcValue = orcamento[catId];
            const realValue = catTotals[catId] || 0;
            const pct = orcValue > 0 ? (realValue / orcValue * 100) : 0;
            const clampedPct = Math.min(pct, 100);
            const cls = pct < 80 ? 'green' : pct <= 100 ? 'yellow' : 'red';
            const catName = categorias[catId] || catId;
            budgetContainer.innerHTML += `
            <div class="budget-item">
                <div class="budget-row">
                    <span class="budget-cat">${catName}</span>
                    <span class="budget-vals">${brl(realValue)} / ${brl(orcValue)} Â· <strong style="color:var(--${cls})">${pct.toFixed(0)}%</strong></span>
                </div>
                <div class="budget-track">
                    <div class="budget-fill ${cls}" style="width:${clampedPct}%"></div>
                </div>
            </div>`;
        });

        const dailyMap = {};
        curMonthData.forEach(r => {
            const day = parseInt(r.data.split('-')[2]);
            dailyMap[day] = (dailyMap[day] || 0) + Math.abs(r.valor);
        });

        const histCurves = [];
        const monthsToLookBack = 6;
        for (let i = 1; i <= monthsToLookBack; i++) {
            const d = new Date(year, month - 1, 1);
            d.setMonth(d.getMonth() - i);
            const k = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            const mData = despesas.filter(r => r.data.startsWith(k));
            const mDaily = new Array(32).fill(0);
            mData.forEach(r => {
                const day = parseInt(r.data.split('-')[2]);
                mDaily[day] += Math.abs(r.valor);
            });
            const mAcc = [];
            let mRunning = 0;
            for (let day = 1; day <= 31; day++) {
                mRunning += mDaily[day] || 0;
                mAcc.push(mRunning);
            }
            histCurves.push(mAcc);
        }

        const dayLabels = [];
        const realAcc = [];
        const historicalAcc = [];
        let runningReal = 0;
        for (let d = 1; d <= daysInMonth; d++) {
            dayLabels.push(`Dia ${d}`);
            if (d <= (key < todayKey ? daysInMonth : (key === todayKey ? refDate.getDate() : 0))) {
                runningReal += (dailyMap[d] || 0);
                realAcc.push(runningReal);
            } else { realAcc.push(null); }
            let sumHist = 0;
            histCurves.forEach(c => { sumHist += c[d-1] || 0; });
            historicalAcc.push(sumHist / histCurves.length);
        }

        if (charts['cT2C']) charts['cT2C'].destroy();
        charts['cT2C'] = new Chart(document.getElementById('cT2C'), {
            type: 'line',
            data: {
                labels: dayLabels,
                datasets: [
                    { label: 'Gasto Real Acumulado', data: realAcc, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.1)', fill: true, tension: 0.3, pointRadius: 2, spanGaps: false },
                    { label: `Curva de ReferÃªncia (MÃ©dia ${monthsToLookBack} meses)`, data: historicalAcc, borderColor: '#ca8a04', borderDash: [6, 4], fill: false, tension: 0.2, pointRadius: 0 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 8, boxWidth: 12 } },
                    tooltip: { callbacks: { label: ctx => ' ' + brl(ctx.parsed.y) } }
                },
                scales: {
                    y: { ticks: { callback: v => 'R$ ' + (v / 1000).toFixed(0) + 'k' } },
                    x: { ticks: { maxRotation: 45, font: { size: 9 }, maxTicksLimit: 15 } }
                }
            }
        });

        // â”€â”€â”€ Pizzas mensais â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window._curMonthDataForPizzas = curMonthData;
        renderT2P1(curMonthData);
        renderT2P2(curMonthData);
        renderT2P3(curMonthData);
    }

    // â”€â”€â”€ Chart T2P1 â€” Pizza por Categoria (Mensal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderT2P1(monthData) {
        const totals = {};
        monthData.forEach(r => {
            totals[r.categoria] = (totals[r.categoria] || 0) + Math.abs(r.valor);
        });
        const sorted = Object.entries(totals).sort((a,b) => b[1]-a[1]);
        const labels = sorted.map(([k]) => categorias[k] || k);
        const values = sorted.map(([,v]) => v);
        const total = values.reduce((a,b)=>a+b,0);
        const colors = sorted.map(([,],i) => CAT_COLORS[i % CAT_COLORS.length]);

        if (charts['cT2P1']) charts['cT2P1'].destroy();
        charts['cT2P1'] = new Chart(document.getElementById('cT2P1'), {
            type: 'pie',
            data: { labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 2 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 8, boxWidth: 12 } },
                    tooltip: { callbacks: { label: ctx => { const pct = ((ctx.parsed / total)*100).toFixed(1); return ` ${brl(ctx.parsed)} (${pct}%)`; } } }
                }
            }
        });
    }

    // â”€â”€â”€ Chart T2P2 â€” Pizza por Subcategoria (Mensal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderT2P2(monthData) {
        const sel = document.getElementById('selT2P2');
        if (!sel) return;
        const cat = sel.value;
        const data = monthData || window._curMonthDataForPizzas || [];

        const totals = {};
        data.filter(r => r.categoria === cat).forEach(r => {
            const sub = r.subcategoria || 'NÃ£o definida';
            totals[sub] = (totals[sub] || 0) + Math.abs(r.valor);
        });
        const sorted = Object.entries(totals).sort((a,b) => b[1]-a[1]);
        const labels = sorted.map(([k]) => k);
        const values = sorted.map(([,v]) => v);
        const total = values.reduce((a,b)=>a+b,0);

        if (charts['cT2P2']) charts['cT2P2'].destroy();
        charts['cT2P2'] = new Chart(document.getElementById('cT2P2'), {
            type: 'pie',
            data: { labels, datasets: [{ data: values, backgroundColor: CAT_COLORS, borderWidth: 2 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 8, boxWidth: 12 } },
                    tooltip: { callbacks: { label: ctx => { const pct = ((ctx.parsed / total)*100).toFixed(1); return ` ${brl(ctx.parsed)} (${pct}%)`; } } }
                }
            }
        });
    }

    // â”€â”€â”€ Chart T2P3 â€” Pizza por Origem (Mensal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderT2P3(monthData) {
        const totals = {};
        monthData.forEach(r => {
            const name = origens[r.origem] || r.origem;
            totals[name] = (totals[name] || 0) + Math.abs(r.valor);
        });
        const sorted = Object.entries(totals).sort((a,b) => b[1]-a[1]);
        const labels = sorted.map(([k]) => k);
        const values = sorted.map(([,v]) => v);
        const total = values.reduce((a,b)=>a+b,0);

        if (charts['cT2P3']) charts['cT2P3'].destroy();
        charts['cT2P3'] = new Chart(document.getElementById('cT2P3'), {
            type: 'doughnut',
            data: { labels, datasets: [{ data: values, backgroundColor: CAT_COLORS, borderWidth: 2 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 8, boxWidth: 12 } },
                    tooltip: { callbacks: { label: ctx => { const pct = ((ctx.parsed / total)*100).toFixed(1); return ` ${brl(ctx.parsed)} (${pct}%)`; } } }
                }
            }
        });
    }

    // â”€â”€â”€ Tab 3: Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let editorFilterMode = 'todos'; 
    let editingIndex = null; 

    function toggleEditorFilter(mode) {
        editorFilterMode = mode;
        document.getElementById('btn-filter-sem').classList.toggle('active', mode === 'sem');
        document.getElementById('btn-filter-todos').classList.toggle('active', mode === 'todos');
        document.getElementById('ed-cat').value = (mode === 'sem') ? '__sem__' : '__all__';
        document.getElementById('ed-subcat').innerHTML = '<option value="__all__">Todas</option>';
        renderEditor();
    }

    function onEdCatChange() {
        const catVal = document.getElementById('ed-cat').value;
        const subSel = document.getElementById('ed-subcat');
        subSel.innerHTML = '<option value="__all__">Todas</option>';
        if (catVal !== '__all__' && catVal !== '__sem__') {
            const subs = subcategoriasPorCat[catVal] || [];
            subs.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.textContent = s;
                subSel.appendChild(opt);
            });
        }
        renderEditor();
    }

    function getEditorFiltered() {
        const monthVal = document.getElementById('ed-month').value;
        const catVal = document.getElementById('ed-cat').value;
        const subcatVal = document.getElementById('ed-subcat').value;
        const origVal = document.getElementById('ed-orig').value;
        const search = (document.getElementById('ed-search').value || '').toLowerCase().trim();

        return allData.map((r, i) => ({ ...r, __idx: i }))
            .filter(r => {
                if (r.categoria === 'receitas') return false;
                if (monthVal !== '__all__' && !r.data.startsWith(monthVal)) return false;
                if (catVal === '__sem__') {
                    if (r.categoria && r.categoria !== '' && r.categoria !== null) return false;
                } else if (catVal !== '__all__') {
                    if (r.categoria !== catVal) return false;
                }
                if (subcatVal !== '__all__' && r.subcategoria !== subcatVal) return false;
                if (origVal !== '__all__' && r.origem !== origVal) return false;
                if (search && !(r.descricao || '').toLowerCase().includes(search)) return false;
                return true;
            })
            .sort((a, b) => b.data.localeCompare(a.data)); 
    }

    function fmtDate(dateStr) {
        if (!dateStr) return '';
        const [y, m, d] = dateStr.split('-');
        return `${d}/${m}/${String(y).slice(-2)}`;
    }

    function renderEditor() {
        const rows = getEditorFiltered();
        const tbody = document.getElementById('ed-tbody');
        if (!tbody) return;
        const total = rows.reduce((s, r) => s + (r.valor || 0), 0);
        const semCat = rows.filter(r => !r.categoria || r.categoria === '').length;
        const summary = document.getElementById('ed-summary');
        if (summary) {
            summary.innerHTML = `<strong>${rows.length}</strong> lanÃ§amento(s) Â· Total: <strong>${total < 0 ? '-' : ''}${brl(Math.abs(total))}</strong>` +
                (semCat > 0 ? ` Â· <span style="color:#f87171; font-weight:700;">âš ï¸ ${semCat} sem categoria</span>` : '');
        }

        tbody.innerHTML = rows.map((r) => {
            const catName = r.categoria ? (categorias[r.categoria] || r.categoria) : '<span style="color:#f87171; font-weight:700;">âš ï¸ Sem categoria</span>';
            const orig = r.origem ? (origens[r.origem] || r.origem) : '';
            const valColor = r.valor < 0 ? 'var(--red)' : 'var(--green)';
            const valSign = r.valor < 0 ? '-' : '+';
            return `<tr style="border-top:1px solid var(--border);" class="ed-row" data-idx="${r.__idx}">
                <td style="padding:9px 10px; white-space:nowrap; color:var(--subtext);">${fmtDate(r.data)}</td>
                <td style="padding:9px 10px; max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${(r.descricao||'').replace(/"/g,'&quot;')}">${r.descricao || ''}</td>
                <td style="padding:9px 10px;">${catName}</td>
                <td style="padding:9px 10px; color:var(--subtext);">${r.subcategoria || ''}</td>
                <td style="padding:9px 10px; text-align:right; font-weight:700; color:${valColor}; white-space:nowrap;">${valSign}${brl(Math.abs(r.valor||0))}</td>
                <td style="padding:9px 10px; color:var(--subtext);">${orig}</td>
                <td style="padding:9px 10px; text-align:center; white-space:nowrap;">
                    <button onclick="openEditModal(${r.__idx})" style="background:var(--accent); color:white; border:none; padding:4px 10px; border-radius:6px; font-size:0.75rem; font-weight:700; cursor:pointer; margin-right:4px;">âœï¸</button>
                    <button onclick="deleteEntry(${r.__idx})" style="background:#dc2626; color:white; border:none; padding:4px 10px; border-radius:6px; font-size:0.75rem; font-weight:700; cursor:pointer;">ğŸ—‘ï¸</button>
                </td>
            </tr>`;
        }).join('');
    }

    function populateEditorMonthDropdown() {
        const sel = document.getElementById('ed-month');
        if (!sel) return;
        const allKeys = [...new Set(allData.map(r => r.data.substring(0, 7)))].sort().reverse();
        sel.innerHTML = '<option value="__all__">Todos os meses</option>';
        allKeys.forEach(k => {
            const [y, m] = k.split('-');
            const label = new Date(parseInt(y), parseInt(m)-1, 1).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            const opt = document.createElement('option');
            opt.value = k;
            opt.textContent = label.charAt(0).toUpperCase() + label.slice(1);
            sel.appendChild(opt);
        });
    }

    function populateEditorCatDropdown() {
        const sel = document.getElementById('ed-cat');
        if (!sel) return;
        const existingOpts = Array.from(sel.options).slice(0, 2);
        sel.innerHTML = '';
        existingOpts.forEach(o => sel.appendChild(o));
        Object.entries(categorias).forEach(([id, nome]) => {
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = nome;
            sel.appendChild(opt);
        });
    }

    function populateEditorOrigDropdown() {
        const sel = document.getElementById('ed-orig');
        if (!sel) return;
        sel.innerHTML = '<option value="__all__">Todas</option>';
        Object.entries(origens).forEach(([id, nome]) => {
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = nome;
            sel.appendChild(opt);
        });
    }

    function openAddModal() {
        editingIndex = null;
        document.getElementById('modal-title').textContent = 'â• Novo LanÃ§amento';
        document.getElementById('m-data').value = new Date().toISOString().slice(0, 10);
        document.getElementById('m-desc').value = '';
        document.getElementById('m-cat').value = '';
        document.getElementById('m-subcat').innerHTML = '<option value="">-- Selecionar --</option>';
        document.getElementById('m-valor').value = '';
        document.getElementById('m-orig').value = '';
        document.getElementById('modal-error').style.display = 'none';
        document.getElementById('ed-modal').style.display = 'flex';
    }

    function openEditModal(idx) {
        editingIndex = idx;
        const r = allData[idx];
        document.getElementById('modal-title').textContent = 'âœï¸ Editar LanÃ§amento';
        document.getElementById('m-data').value = r.data || '';
        document.getElementById('m-desc').value = r.descricao || '';
        document.getElementById('m-cat').value = r.categoria || '';
        updateModalSubcat();
        document.getElementById('m-subcat').value = r.subcategoria || '';
        document.getElementById('m-valor').value = r.valor !== undefined ? r.valor : '';
        document.getElementById('m-orig').value = r.origem || '';
        document.getElementById('modal-error').style.display = 'none';
        document.getElementById('ed-modal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('ed-modal').style.display = 'none'; }

    function updateModalSubcat() {
        const catId = document.getElementById('m-cat').value;
        const sel = document.getElementById('m-subcat');
        sel.innerHTML = '<option value="">-- Selecionar --</option>';
        const subs = subcategoriasPorCat[catId] || [];
        subs.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s;
            opt.textContent = s;
            sel.appendChild(opt);
        });
    }

    function saveModal() {
        const errEl = document.getElementById('modal-error');
        const data = document.getElementById('m-data').value;
        const desc = document.getElementById('m-desc').value.trim();
        const cat = document.getElementById('m-cat').value;
        const subcat = document.getElementById('m-subcat').value;
        const valorStr = document.getElementById('m-valor').value;
        const orig = document.getElementById('m-orig').value;

        if (!data || !desc || !valorStr) {
            errEl.textContent = 'âš ï¸ Preencha Data, DescriÃ§Ã£o e Valor.';
            errEl.style.display = 'block';
            return;
        }
        const valor = parseFloat(valorStr);
        if (isNaN(valor)) {
            errEl.textContent = 'âš ï¸ Valor invÃ¡lido.';
            errEl.style.display = 'block';
            return;
        }
        const entry = { descricao: desc, data, categoria: cat, subcategoria: subcat, valor, origem: orig };
        if (editingIndex === null) { allData.push(entry); } 
        else { allData[editingIndex] = entry; }
        closeModal();
        renderEditor();
    }

    function deleteEntry(idx) {
        if (!confirm('Excluir este lanÃ§amento?')) return;
        allData.splice(idx, 1);
        renderEditor();
    }

    function populateModalSelects() {
        const mCat = document.getElementById('m-cat');
        Object.entries(categorias).forEach(([id, nome]) => {
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = nome;
            mCat.appendChild(opt);
        });
        const mOrig = document.getElementById('m-orig');
        mOrig.innerHTML = '<option value="">-- Selecionar --</option>';
        Object.entries(origens).forEach(([id, nome]) => {
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = nome;
            mOrig.appendChild(opt);
        });
    }

    // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function init() {
        const saved = localStorage.getItem('theme');
        if (saved === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-toggle').textContent = 'â˜€ï¸';
            Chart.defaults.color = '#cbd5e0';
            Chart.defaults.borderColor = '#4a5568';
        }

        try {
            const [lancData, catData, origData, orcData] = await Promise.all([
                fetch('./data/lancamentos.json?v=' + Date.now()).then(r => r.json()),
                fetch('./data/categorias.json?v=' + Date.now()).then(r => r.json()),
                fetch('./data/origens.json?v=' + Date.now()).then(r => r.json()),
                fetch('./data/orcamento.json?v=' + Date.now()).then(r => r.json())
            ]);

            catData.categorias.forEach(c => {
                if (c.tipo === 'despesa') categorias[c.id] = c.nome;
            });
            origData.origens.forEach(o => { origens[o.id] = o.nome; });
            orcamento = orcData.orcamento_mensal;
            allData = Array.isArray(lancData) ? lancData : (lancData.lancamentos || []);

            const lastDate = allData.reduce((max, r) => r.data > max ? r.data : max, '');
            if (lastDate) {
                const [y, m, d] = lastDate.split('-');
                document.getElementById('last-update').textContent = `Ãšltima atualizaÃ§Ã£o: ${d}/${m}/${y}`;
                document.getElementById('last-update').style.display = 'block';
            }

            allData.forEach(r => {
                if (r.categoria && r.subcategoria) {
                    if (!subcategoriasPorCat[r.categoria]) subcategoriasPorCat[r.categoria] = new Set();
                    subcategoriasPorCat[r.categoria].add(r.subcategoria);
                }
            });
            Object.keys(subcategoriasPorCat).forEach(k => {
                subcategoriasPorCat[k] = Array.from(subcategoriasPorCat[k]).sort();
            });

            const despesaCats = catData.categorias.filter(c => c.tipo === 'despesa');
            const selC = document.getElementById('selC');
            despesaCats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id; opt.textContent = c.nome;
                if (c.id === 'alimentacao') opt.selected = true;
                selC.appendChild(opt);
            });
            populateSubcatSelect(selC.value);

            const selE = document.getElementById('selE');
            despesaCats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id; opt.textContent = c.nome;
                if (c.id === 'alimentacao') opt.selected = true;
                selE.appendChild(opt);
            });

            const selT2D = document.getElementById('selT2D');
            despesaCats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id; opt.textContent = c.nome;
                if (c.id === 'alimentacao') opt.selected = true;
                selT2D.appendChild(opt);
            });

            const selT2P2 = document.getElementById('selT2P2');
            despesaCats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id; opt.textContent = c.nome;
                if (c.id === 'alimentacao') opt.selected = true;
                selT2P2.appendChild(opt);
            });

            selectedMonth = getInitialMonth();
            populateMonthDropdown();
            populateEditorMonthDropdown();
            populateEditorCatDropdown();
            populateEditorOrigDropdown();
            populateModalSelects();

            applyFilter(currentPeriod);
            renderAll();

            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

        } catch(err) {
            document.getElementById('loading').innerHTML = 'âŒ Erro ao carregar dados. <br><small>' + err.message + '</small>';
            console.error(err);
        }
    }
    init();
    </script>
</body>
</html>
