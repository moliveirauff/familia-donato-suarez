<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∏ Dashboard de Despesas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #f3f4f6;
            --text: #1f2937;
            --card-bg: #ffffff;
            --border: #e5e7eb;
            --subtext: #6b7280;
            --accent: #2563eb;
            --accent-light: #eff6ff;
            --green: #16a34a;
            --yellow: #ca8a04;
            --red: #dc2626;
        }
        body.dark-mode {
            --bg: #111827;
            --text: #f3f4f6;
            --card-bg: #1f2937;
            --border: #374151;
            --subtext: #9ca3af;
            --accent: #3b82f6;
            --accent-light: #1e3a5f;
            --green: #4ade80;
            --yellow: #fbbf24;
            --red: #f87171;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s;
            padding: 10px;
            padding-bottom: 60px;
        }
        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding: 10px 4px;
            flex-wrap: wrap;
            gap: 8px;
        }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .back-link {
            text-decoration: none;
            color: var(--accent);
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
        }
        .back-link:hover { text-decoration: underline; }
        h1 { font-size: 1.2rem; font-weight: 800; }
        #theme-toggle {
            background: none;
            border: 1px solid var(--border);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 8px;
            color: var(--text);
            transition: background 0.2s;
        }
        #theme-toggle:hover { background: var(--border); }
        /* Period filters */
        .period-bar {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 14px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .period-label { font-size: 0.75rem; font-weight: 700; color: var(--subtext); text-transform: uppercase; margin-right: 4px; }
        .btn-period {
            background: var(--border);
            border: none;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-period:hover { opacity: 0.8; }
        .btn-period.active { background: var(--accent); color: white; }
        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.07);
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .card-header {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .card-controls { display: flex; align-items: center; gap: 8px; }
        .btn-fullscreen {
            background: var(--border);
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            color: var(--text);
            transition: background 0.2s;
        }
        .btn-fullscreen:hover { background: var(--accent); color: white; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        select.cat-select {
            background: var(--border);
            border: none;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            outline: none;
        }
        /* Budget bars */
        .budget-item { margin-bottom: 14px; }
        .budget-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; font-size: 0.82rem; }
        .budget-cat { font-weight: 700; }
        .budget-vals { color: var(--subtext); font-size: 0.78rem; }
        .budget-track { background: var(--border); border-radius: 99px; height: 10px; overflow: hidden; }
        .budget-fill { height: 100%; border-radius: 99px; transition: width 0.5s ease; }
        .budget-fill.green { background: var(--green); }
        .budget-fill.yellow { background: var(--yellow); }
        .budget-fill.red { background: var(--red); }
        /* Top10 table */
        .table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.82rem; min-width: 500px; }
        th {
            text-align: left;
            padding: 8px 10px;
            border-bottom: 2px solid var(--border);
            color: var(--subtext);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.72rem;
        }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
        tr:last-child td { border-bottom: none; }
        .val-cell { font-weight: 700; color: var(--red); white-space: nowrap; }
        .loading-msg { text-align: center; padding: 40px; color: var(--subtext); font-size: 1rem; }
        /* Fullscreen overlay */
        .fs-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 1000;
            padding: 20px;
            flex-direction: column;
        }
        .fs-overlay.active { display: flex; }
        .fs-close {
            align-self: flex-end;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 14px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-bottom: 12px;
        }
        .fs-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 16px; }
        .fs-chart { flex: 1; position: relative; }
        @media (min-width: 768px) {
            body { max-width: 960px; margin: 0 auto; }
            .chart-container { height: 380px; }
            .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <a href="index.html" class="back-link">‚Üê In√≠cio</a>
            <h1>üí∏ Dashboard de Despesas</h1>
        </div>
        <button id="theme-toggle" onclick="toggleTheme()">üåô</button>
    </div>

    <!-- Period Filter -->
    <div class="period-bar">
        <span class="period-label">Per√≠odo:</span>
        <button class="btn-period" onclick="setPeriod('ano_atual', this)">Ano Atual</button>
        <button class="btn-period active" onclick="setPeriod('12m', this)">12M</button>
        <button class="btn-period" onclick="setPeriod('24m', this)">24M</button>
        <button class="btn-period" onclick="setPeriod('36m', this)">36M</button>
        <button class="btn-period" onclick="setPeriod('todos', this)">Todos</button>
    </div>

    <div id="loading" class="loading-msg">‚è≥ Carregando dados...</div>

    <div id="dashboard" style="display:none;">

        <!-- B: Barras por Categoria -->
        <div class="card">
            <div class="card-header">
                <span>üìä Gastos por Categoria</span>
                <button class="btn-fullscreen" onclick="openFullscreen('fsB')">‚õ∂ Tela Cheia</button>
            </div>
            <div class="chart-container"><canvas id="cB"></canvas></div>
        </div>

        <!-- C: Barras por Subcategoria -->
        <div class="card">
            <div class="card-header">
                <span>üìä Gastos por Subcategoria</span>
                <div class="card-controls">
                    <select id="selC" class="cat-select" onchange="renderC()"></select>
                    <button class="btn-fullscreen" onclick="openFullscreen('fsC')">‚õ∂ Tela Cheia</button>
                </div>
            </div>
            <div class="chart-container"><canvas id="cC"></canvas></div>
        </div>

        <div class="grid-2">
            <!-- D: Pizza por Categoria -->
            <div class="card">
                <div class="card-header">
                    <span>ü•ß % por Categoria</span>
                    <button class="btn-fullscreen" onclick="openFullscreen('fsD')">‚õ∂ Tela Cheia</button>
                </div>
                <div class="chart-container"><canvas id="cD"></canvas></div>
            </div>

            <!-- E: Pizza por Subcategoria -->
            <div class="card">
                <div class="card-header">
                    <span>ü•ß % por Subcategoria</span>
                    <div class="card-controls">
                        <select id="selE" class="cat-select" onchange="renderE()"></select>
                        <button class="btn-fullscreen" onclick="openFullscreen('fsE')">‚õ∂ Tela Cheia</button>
                    </div>
                </div>
                <div class="chart-container"><canvas id="cE"></canvas></div>
            </div>
        </div>

        <!-- F: Categoria vs Or√ßamento -->
        <div class="card">
            <div class="card-header">
                <span>üéØ Categoria vs Or√ßamento Mensal</span>
            </div>
            <div id="budgetChart"></div>
        </div>

        <!-- G: Evolu√ß√£o Mensal -->
        <div class="card">
            <div class="card-header">
                <span>üìà Evolu√ß√£o Mensal de Despesas</span>
                <button class="btn-fullscreen" onclick="openFullscreen('fsG')">‚õ∂ Tela Cheia</button>
            </div>
            <div class="chart-container"><canvas id="cG"></canvas></div>
        </div>

        <!-- H: Por Origem -->
        <div class="card">
            <div class="card-header">
                <span>üè¶ Gastos por Origem</span>
                <button class="btn-fullscreen" onclick="openFullscreen('fsH')">‚õ∂ Tela Cheia</button>
            </div>
            <div class="chart-container"><canvas id="cH"></canvas></div>
        </div>

        <!-- I: Top 10 -->
        <div class="card">
            <div class="card-header"><span>üîù Top 10 Maiores Lan√ßamentos</span></div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Descri√ß√£o</th>
                            <th>Data</th>
                            <th>Categoria</th>
                            <th>Subcategoria</th>
                            <th>Valor</th>
                            <th>Origem</th>
                        </tr>
                    </thead>
                    <tbody id="top10body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Fullscreen overlays -->
    <div id="fsB" class="fs-overlay">
        <button class="fs-close" onclick="closeFullscreen('fsB')">‚úï Fechar</button>
        <div class="fs-title">üìä Gastos por Categoria</div>
        <div class="fs-chart"><canvas id="cBfs"></canvas></div>
    </div>
    <div id="fsC" class="fs-overlay">
        <button class="fs-close" onclick="closeFullscreen('fsC')">‚úï Fechar</button>
        <div class="fs-title" id="fsCTitle">üìä Gastos por Subcategoria</div>
        <div class="fs-chart"><canvas id="cCfs"></canvas></div>
    </div>
    <div id="fsD" class="fs-overlay">
        <button class="fs-close" onclick="closeFullscreen('fsD')">‚úï Fechar</button>
        <div class="fs-title">ü•ß % por Categoria</div>
        <div class="fs-chart"><canvas id="cDfs"></canvas></div>
    </div>
    <div id="fsE" class="fs-overlay">
        <button class="fs-close" onclick="closeFullscreen('fsE')">‚úï Fechar</button>
        <div class="fs-title" id="fsETitle">ü•ß % por Subcategoria</div>
        <div class="fs-chart"><canvas id="cEfs"></canvas></div>
    </div>
    <div id="fsG" class="fs-overlay">
        <button class="fs-close" onclick="closeFullscreen('fsG')">‚úï Fechar</button>
        <div class="fs-title">üìà Evolu√ß√£o Mensal de Despesas</div>
        <div class="fs-chart"><canvas id="cGfs"></canvas></div>
    </div>
    <div id="fsH" class="fs-overlay">
        <button class="fs-close" onclick="closeFullscreen('fsH')">‚úï Fechar</button>
        <div class="fs-title">üè¶ Gastos por Origem</div>
        <div class="fs-chart"><canvas id="cHfs"></canvas></div>
    </div>

    <script>
    // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let allData = [];
    let filteredData = [];
    let categorias = {};
    let origens = {};
    let orcamento = {};
    let currentPeriod = '12m';

    // Chart instances
    let charts = {};

    // ‚îÄ‚îÄ‚îÄ Theme ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        document.getElementById('theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        Chart.defaults.color = isDark ? '#9ca3af' : '#6b7280';
        Chart.defaults.borderColor = isDark ? '#374151' : '#e5e7eb';
        Object.values(charts).forEach(c => c && c.update());
    }

    // ‚îÄ‚îÄ‚îÄ Fullscreen ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const fsChartMap = {
        fsB: { src: 'cB', fs: 'cBfs', type: 'bar' },
        fsC: { src: 'cC', fs: 'cCfs', type: 'bar' },
        fsD: { src: 'cD', fs: 'cDfs', type: 'pie' },
        fsE: { src: 'cE', fs: 'cEfs', type: 'pie' },
        fsG: { src: 'cG', fs: 'cGfs', type: 'line' },
        fsH: { src: 'cH', fs: 'cHfs', type: 'doughnut' }
    };

    function openFullscreen(id) {
        const overlay = document.getElementById(id);
        overlay.classList.add('active');
        const info = fsChartMap[id];
        if (!info) return;
        const srcChart = charts[info.src];
        if (!srcChart) return;
        const fsCanvas = document.getElementById(info.fs);
        if (charts[info.fs]) { charts[info.fs].destroy(); }
        charts[info.fs] = new Chart(fsCanvas, {
            type: srcChart.config.type,
            data: JSON.parse(JSON.stringify(srcChart.config.data)),
            options: { ...srcChart.config.options, responsive: true, maintainAspectRatio: false }
        });
    }

    function closeFullscreen(id) {
        document.getElementById(id).classList.remove('active');
        const info = fsChartMap[id];
        if (info && charts[info.fs]) {
            charts[info.fs].destroy();
            charts[info.fs] = null;
        }
    }

    // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function brl(v) {
        return 'R$ ' + Math.abs(v).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function getDateBoundary(period) {
        const today = new Date();
        today.setHours(0,0,0,0);
        if (period === 'todos') return new Date('2000-01-01');
        if (period === 'ano_atual') return new Date(today.getFullYear(), 0, 1);
        const months = { '12m': 12, '24m': 24, '36m': 36 };
        const m = months[period] || 12;
        const d = new Date(today);
        d.setMonth(d.getMonth() - m);
        return d;
    }

    function applyFilter(period) {
        const boundary = getDateBoundary(period);
        filteredData = allData.filter(r => {
            const d = new Date(r.data);
            return d >= boundary && r.valor < 0 && r.categoria !== 'receitas';
        });
    }

    const CAT_COLORS = [
        '#2563eb','#16a34a','#dc2626','#ca8a04','#7c3aed',
        '#0891b2','#ea580c','#be185d','#059669','#4b5563'
    ];

    function getCatColors(cats) {
        const map = {};
        cats.forEach((c, i) => { map[c] = CAT_COLORS[i % CAT_COLORS.length]; });
        return map;
    }

    // ‚îÄ‚îÄ‚îÄ Period UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setPeriod(period, btn) {
        currentPeriod = period;
        document.querySelectorAll('.btn-period').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        applyFilter(period);
        renderAll();
    }

    // ‚îÄ‚îÄ‚îÄ Chart B ‚Äî Barras por Categoria ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderB() {
        const totals = {};
        filteredData.forEach(r => {
            totals[r.categoria] = (totals[r.categoria] || 0) + Math.abs(r.valor);
        });
        const sorted = Object.entries(totals).sort((a,b) => b[1] - a[1]);
        const labels = sorted.map(([k]) => categorias[k] || k);
        const values = sorted.map(([,v]) => v);
        const colors = sorted.map(([,], i) => CAT_COLORS[i % CAT_COLORS.length]);

        if (charts['cB']) charts['cB'].destroy();
        charts['cB'] = new Chart(document.getElementById('cB'), {
            type: 'bar',
            data: {
                labels,
                datasets: [{ label: 'Total (R$)', data: values, backgroundColor: colors, borderRadius: 6 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => ' ' + brl(ctx.parsed.y) } }
                },
                scales: {
                    y: { ticks: { callback: v => 'R$ ' + (v/1000).toFixed(0) + 'k' } }
                }
            }
        });
    }

    // ‚îÄ‚îÄ‚îÄ Chart C ‚Äî Barras por Subcategoria ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderC() {
        const sel = document.getElementById('selC');
        const cat = sel.value;
        document.getElementById('fsCTitle').textContent = 'üìä Subcategorias ‚Äî ' + (categorias[cat] || cat);

        const totals = {};
        filteredData.filter(r => r.categoria === cat).forEach(r => {
            totals[r.subcategoria] = (totals[r.subcategoria] || 0) + Math.abs(r.valor);
        });
        const sorted = Object.entries(totals).sort((a,b) => b[1]-a[1]);
        const labels = sorted.map(([k]) => k);
        const values = sorted.map(([,v]) => v);

        if (charts['cC']) charts['cC'].destroy();
        charts['cC'] = new Chart(document.getElementById('cC'), {
            type: 'bar',
            data: {
                labels,
                datasets: [{ label: 'Total (R$)', data: values, backgroundColor: '#2563eb', borderRadius: 6 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => ' ' + brl(ctx.parsed.y) } }
                },
                scales: {
                    y: { ticks: { callback: v => 'R$ ' + (v/1000).toFixed(0) + 'k' } }
                }
            }
        });
    }

    // ‚îÄ‚îÄ‚îÄ Chart D ‚Äî Pizza por Categoria ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderD() {
        const totals = {};
        filteredData.forEach(r => {
            totals[r.categoria] = (totals[r.categoria] || 0) + Math.abs(r.valor);
        });
        const sorted = Object.entries(totals).sort((a,b) => b[1]-a[1]);
        const labels = sorted.map(([k]) => categorias[k] || k);
        const values = sorted.map(([,v]) => v);
        const total = values.reduce((a,b)=>a+b,0);
        const colors = sorted.map(([,],i) => CAT_COLORS[i % CAT_COLORS.length]);

        if (charts['cD']) charts['cD'].destroy();
        charts['cD'] = new Chart(document.getElementById('cD'), {
            type: 'pie',
            data: {
                labels,
                datasets: [{ data: values, backgroundColor: colors, borderWidth: 2 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { size: 11 }, padding: 8, boxWidth: 12 }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const pct = ((ctx.parsed / total) * 100).toFixed(1);
                                return ` ${brl(ctx.parsed)} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // ‚îÄ‚îÄ‚îÄ Chart E ‚Äî Pizza por Subcategoria ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderE() {
        const sel = document.getElementById('selE');
        const cat = sel.value;
        document.getElementById('fsETitle').textContent = 'ü•ß Subcategorias ‚Äî ' + (categorias[cat] || cat);

        const totals = {};
        filteredData.filter(r => r.categoria === cat).forEach(r => {
            totals[r.subcategoria] = (totals[r.subcategoria] || 0) + Math.abs(r.valor);
        });
        const sorted = Object.entries(totals).sort((a,b) => b[1]-a[1]);
        const labels = sorted.map(([k]) => k);
        const values = sorted.map(([,v]) => v);
        const total = values.reduce((a,b)=>a+b,0);

        if (charts['cE']) charts['cE'].destroy();
        charts['cE'] = new Chart(document.getElementById('cE'), {
            type: 'pie',
            data: {
                labels,
                datasets: [{ data: values, backgroundColor: CAT_COLORS, borderWidth: 2 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 8, boxWidth: 12 } },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const pct = ((ctx.parsed / total) * 100).toFixed(1);
                                return ` ${brl(ctx.parsed)} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // ‚îÄ‚îÄ‚îÄ Block F ‚Äî Categoria vs Or√ßamento ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderF() {
        // Calculate months in period
        const boundary = getDateBoundary(currentPeriod);
        const today = new Date();
        let months;
        if (currentPeriod === 'todos') {
            const dates = filteredData.map(r => new Date(r.data));
            if (dates.length === 0) { months = 1; }
            else {
                const minD = new Date(Math.min(...dates));
                months = Math.max(1, (today.getFullYear() - minD.getFullYear()) * 12 + today.getMonth() - minD.getMonth() + 1);
            }
        } else if (currentPeriod === 'ano_atual') {
            months = Math.max(1, today.getMonth() + 1);
        } else {
            months = parseInt(currentPeriod) || 12;
        }

        const totals = {};
        filteredData.forEach(r => {
            totals[r.categoria] = (totals[r.categoria] || 0) + Math.abs(r.valor);
        });

        const container = document.getElementById('budgetChart');
        container.innerHTML = '';

        const orcCats = Object.keys(orcamento);
        orcCats.forEach(catId => {
            const orc = orcamento[catId];
            const real = totals[catId] || 0;
            const orcTotal = orc * months;
            const pct = orcTotal > 0 ? (real / orcTotal * 100) : 0;
            const clampedPct = Math.min(pct, 100);
            const cls = pct < 80 ? 'green' : pct <= 100 ? 'yellow' : 'red';
            const catName = categorias[catId] || catId;
            const avgMes = months > 0 ? real / months : 0;

            container.innerHTML += `
            <div class="budget-item">
                <div class="budget-row">
                    <span class="budget-cat">${catName}</span>
                    <span class="budget-vals">${brl(avgMes)}/m√™s ¬∑ Or√ßamento: ${brl(orc)}/m√™s ¬∑ <strong style="color:var(--${cls})">${pct.toFixed(0)}%</strong></span>
                </div>
                <div class="budget-track">
                    <div class="budget-fill ${cls}" style="width:${clampedPct}%"></div>
                </div>
            </div>`;
        });
    }

    // ‚îÄ‚îÄ‚îÄ Chart G ‚Äî Evolu√ß√£o Mensal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderG() {
        const monthly = {};
        filteredData.forEach(r => {
            const [y, m] = r.data.split('-');
            const key = `${y}-${m}`;
            monthly[key] = (monthly[key] || 0) + Math.abs(r.valor);
        });
        const sorted = Object.keys(monthly).sort();
        const labels = sorted.map(k => {
            const [y, m] = k.split('-');
            return `${m}/${y}`;
        });
        const values = sorted.map(k => monthly[k]);

        if (charts['cG']) charts['cG'].destroy();
        charts['cG'] = new Chart(document.getElementById('cG'), {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Total Despesas',
                    data: values,
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37,99,235,0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => ' ' + brl(ctx.parsed.y) } }
                },
                scales: {
                    y: { ticks: { callback: v => 'R$ ' + (v/1000).toFixed(0) + 'k' } },
                    x: { ticks: { maxRotation: 45, font: { size: 10 } } }
                }
            }
        });
    }

    // ‚îÄ‚îÄ‚îÄ Chart H ‚Äî Por Origem ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderH() {
        const totals = {};
        filteredData.forEach(r => {
            const name = origens[r.origem] || r.origem;
            totals[name] = (totals[name] || 0) + Math.abs(r.valor);
        });
        const sorted = Object.entries(totals).sort((a,b) => b[1]-a[1]);
        const labels = sorted.map(([k]) => k);
        const values = sorted.map(([,v]) => v);
        const total = values.reduce((a,b)=>a+b,0);

        if (charts['cH']) charts['cH'].destroy();
        charts['cH'] = new Chart(document.getElementById('cH'), {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{ data: values, backgroundColor: CAT_COLORS, borderWidth: 2 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { size: 11 }, padding: 8, boxWidth: 12 } },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const pct = ((ctx.parsed / total) * 100).toFixed(1);
                                return ` ${brl(ctx.parsed)} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // ‚îÄ‚îÄ‚îÄ Block I ‚Äî Top 10 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderI() {
        const top10 = [...filteredData]
            .sort((a,b) => a.valor - b.valor) // mais negativos = maiores gastos
            .slice(0, 10);

        const tbody = document.getElementById('top10body');
        tbody.innerHTML = '';
        top10.forEach(r => {
            const d = r.data.split('-').reverse().join('/');
            tbody.innerHTML += `
            <tr>
                <td>${r.descricao}</td>
                <td>${d}</td>
                <td>${categorias[r.categoria] || r.categoria}</td>
                <td>${r.subcategoria}</td>
                <td class="val-cell">${brl(r.valor)}</td>
                <td>${origens[r.origem] || r.origem}</td>
            </tr>`;
        });
    }

    // ‚îÄ‚îÄ‚îÄ Render All ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderAll() {
        renderB();
        renderC();
        renderD();
        renderE();
        renderF();
        renderG();
        renderH();
        renderI();
    }

    // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function init() {
        // Theme
        const saved = localStorage.getItem('theme');
        if (saved === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
            Chart.defaults.color = '#9ca3af';
            Chart.defaults.borderColor = '#374151';
        }

        try {
            const [lancData, catData, origData, orcData] = await Promise.all([
                fetch('./data/lancamentos.json?v=' + Date.now()).then(r => r.json()),
                fetch('./data/categorias.json?v=' + Date.now()).then(r => r.json()),
                fetch('./data/origens.json?v=' + Date.now()).then(r => r.json()),
                fetch('./data/orcamento.json?v=' + Date.now()).then(r => r.json())
            ]);

            // Build lookup maps
            catData.categorias.forEach(c => {
                if (c.tipo === 'despesa') categorias[c.id] = c.nome;
            });
            origData.origens.forEach(o => { origens[o.id] = o.nome; });
            orcamento = orcData.orcamento_mensal;

            allData = lancData;

            // Populate category selects
            const despesaCats = catData.categorias.filter(c => c.tipo === 'despesa');
            ['selC', 'selE'].forEach(selId => {
                const sel = document.getElementById(selId);
                despesaCats.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.nome;
                    if (c.id === 'alimentacao') opt.selected = true;
                    sel.appendChild(opt);
                });
            });

            applyFilter(currentPeriod);
            renderAll();

            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

        } catch(err) {
            document.getElementById('loading').innerHTML = '‚ùå Erro ao carregar dados. <br><small>' + err.message + '</small>';
            console.error(err);
        }
    }

    init();
    </script>
</body>
</html>
