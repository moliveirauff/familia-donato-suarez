<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä Dashboard de Dividendos</title>
  <meta name="version" content="v1.3">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    :root {
      --bg: #f7fafc;
      --text: #2d3748;
      --surface: #ffffff;
      --card-bg: var(--surface);
      --border: #e2e8f0;
      --text-muted: #718096;
      --subtext: var(--text-muted);
      --primary: #667eea;
      --accent: var(--primary);
      --success: #48bb78;
      --warning: #ed8936;
      --shadow: 0 1px 3px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.06);
    }
    body.dark-mode {
      --bg: #1a202c;
      --text: #f7fafc;
      --surface: #2d3748;
      --card-bg: var(--surface);
      --border: #4a5568;
      --text-muted: #cbd5e0;
      --subtext: var(--text-muted);
      --primary: #7f9cf5;
      --accent: var(--primary);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
      padding: 10px 10px 60px 10px;
    }

    /* Header */
    #theme-toggle {
      position: absolute; top: 12px; right: 12px;
      background: rgba(0,0,0,0.05); border: none; font-size: 1.2rem; cursor: pointer;
      padding: 8px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      z-index: 10; transition: background 0.2s;
    }
    body.dark-mode #theme-toggle { background: rgba(255,255,255,0.1); }
    .nav-link {
      text-decoration: none;
      color: var(--primary);
      font-size: 0.9rem;
      margin: 10px 0 0 4px;
      display: inline-block;
    }
    h1 {
      text-align: center;
      font-size: 1.5rem;
      font-weight: 800;
      margin: 10px 44px 4px 44px;
      color: var(--text);
    }
    .page-subtitle {
      text-align: center;
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 18px;
    }

    /* KPIs */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .kpi-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 8px;
      text-align: center;
      box-shadow: var(--shadow);
    }
    .kpi-label {
      font-size: 0.6rem;
      font-weight: 800;
      color: var(--subtext);
      text-transform: uppercase;
      margin-bottom: 4px;
      display: block;
      letter-spacing: 0.05em;
    }
    .kpi-value {
      font-size: 1.05rem;
      font-weight: 800;
      color: var(--text);
      line-height: 1.2;
    }
    .kpi-sub {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 2px;
      font-weight: 600;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      transition: background-color 0.3s, border-color 0.3s;
    }
    .card-header {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .card-title { display: flex; align-items: center; gap: 6px; }

    /* Chart */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    /* Controls */
    .controls { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    select.filter-select {
      background: var(--border);
      border: none;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      outline: none;
    }
    .filter-btn {
      background: var(--border);
      border: none;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-btn:hover { opacity: 0.8; }
    .filter-btn.active { background: var(--accent); color: white; }

    /* Loading */
    #loading {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      color: white;
      font-weight: bold;
      backdrop-filter: blur(4px);
    }
    .hidden { display: none !important; }

    /* Desktop */
    @media (min-width: 768px) {
      body { max-width: 960px; margin: 0 auto; padding: 16px 16px 60px 16px; }
      h1 { font-size: 1.75rem; }
      .kpi-grid { grid-template-columns: repeat(4, 1fr); gap: 12px; }
      .chart-container { height: 380px; }
      .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    }
  </style>
</head>
<body>

<div id="loading">Carregando dados...</div>

<button id="theme-toggle" onclick="toggleTheme()">üåô</button>
<a href="index.html" class="nav-link">‚Üê Voltar</a>
<h1>üìä Dividendos &amp; Proventos</h1>
<p class="page-subtitle">Hist√≥rico completo de dividendos, JCP e rendimentos</p>

<main>
  <!-- KPIs -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <span class="kpi-label">üí∞ Total</span>
      <span class="kpi-value" id="kpiTotal">‚Äî</span>
      <span class="kpi-sub" id="kpiTotalSub">Acumulado</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">üìÖ YTD</span>
      <span class="kpi-value" id="kpiYTD">‚Äî</span>
      <span class="kpi-sub" id="kpiYTDLabel">Ano atual</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">üìà M√©dia</span>
      <span class="kpi-value" id="kpiAvg">‚Äî</span>
      <span class="kpi-sub">√öltimos 12M</span>
    </div>
    <div class="kpi-card">
      <span class="kpi-label">üéØ DY Geral</span>
      <span class="kpi-value" id="kpiDY">‚Äî</span>
      <span class="kpi-sub">Dividend Yield 12M</span>
    </div>
  </div>

  <!-- Chart: Anual -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span>üìä</span> Evolu√ß√£o Anual</div>
      <div class="controls">
        <select id="filterClass" class="filter-select" onchange="updateCharts()">
          <option value="all">Todas as Classes</option>
        </select>
      </div>
    </div>
    <div class="chart-container">
      <canvas id="chartAnual"></canvas>
    </div>
  </div>

  <!-- Grid 2 cols: Mensal + Donut -->
  <div class="grid-2">
    <!-- Chart: Mensal -->
    <div class="card">
      <div class="card-header">
        <div class="card-title"><span>üóìÔ∏è</span> Evolu√ß√£o Mensal</div>
      </div>
      <div class="controls" style="margin-bottom: 14px;">
        <button class="filter-btn active" onclick="setMonthRange(12, this)">12M</button>
        <button class="filter-btn" onclick="setMonthRange(24, this)">24M</button>
        <button class="filter-btn" onclick="setMonthRange(36, this)">36M</button>
        <button class="filter-btn" onclick="setMonthRange(999, this)">Todos</button>
      </div>
      <div class="chart-container">
        <canvas id="chartMensal"></canvas>
      </div>
    </div>

    <!-- Chart: Donut -->
    <div class="card">
      <div class="card-header">
        <div class="card-title"><span>ü•ß</span> Composi√ß√£o</div>
      </div>
      <div class="controls" style="margin-bottom: 14px;">
        <button class="filter-btn active" onclick="setDonutRange(12, this)">12M</button>
        <button class="filter-btn" onclick="setDonutRange(24, this)">24M</button>
        <button class="filter-btn" onclick="setDonutRange(36, this)">36M</button>
        <button class="filter-btn" onclick="setDonutRange(999, this)">Todos</button>
      </div>
      <div class="chart-container">
        <canvas id="chartDonut"></canvas>
      </div>
    </div>
  </div>

  <!-- Chart: DY por Categoria -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span>üéØ</span> Dividend Yield por Categoria (12M)</div>
    </div>
    <div class="chart-container">
      <canvas id="chartDYCategoria"></canvas>
    </div>
  </div>

  <!-- Chart: Top Pagadores -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span>üèÜ</span> Top Pagadores (12M)</div>
    </div>
    <div class="chart-container">
      <canvas id="chartTop"></canvas>
    </div>
  </div>

  <!-- Chart: DY por Ativo (com scroll) -->
  <div class="card">
    <div class="card-header">
      <div class="card-title"><span>üìà</span> Dividend Yield por Ativo (12M)</div>
    </div>
    <div style="position: relative; height: 800px; overflow-y: auto;">
      <canvas id="chartDYAtivo"></canvas>
    </div>
  </div>
</main>

<script>
// Desabilitar datalabels globalmente (ativar apenas onde necess√°rio)
Chart.defaults.set('plugins.datalabels', {
  display: false
});

// === CONFIG ===
const COLORS = {
  '1_renda_fixa_soberana': '#3498db',
  '2_credito_privado': '#2ecc71', 
  '3_acoes_brasil': '#e74c3c',
  '4_ativos_reais': '#f39c12',
  '5_internacional': '#9b59b6',
  '6_criptoativos': '#1abc9c',
  '7_alternativos_estratega': '#e67e22',
  'default': '#95a5a6'
};

const LABELS = {
  '1_renda_fixa_soberana': 'Renda Fixa',
  '2_credito_privado': 'Cr√©dito',
  '3_acoes_brasil': 'A√ß√µes BR',
  '4_ativos_reais': 'FIIs/Im√≥veis',
  '5_internacional': 'Exterior',
  '6_criptoativos': 'Cripto',
  '7_alternativos_estratega': 'Alternativos'
};

// === STATE ===
let rawData = [];
let monthLimit = 12;
let donutLimit = 12;
let charts = {};
let portfolioValue = {}; // { ativo: valor_atual }
let tickerClassMap = {};
let dyData = {}; // { ativo: { divs12m, value, dy, class } }

// === INIT ===
async function init() {
  try {
    const [divReq, ativosReq, movReq, cotReq] = await Promise.all([
      fetch('data/dividendos_historico.json'),
      fetch('data/ativos_financeiros.json'),
      fetch('data/movimentacoes_financeiras.json'),
      fetch('data/invest_cotacoes_mensais.json')
    ]);
    
    const divData = await divReq.json();
    const ativosData = await ativosReq.json();
    const movData = await movReq.json();
    const cotData = await cotReq.json();
    
    // Mapear Ticker -> Classe
    ativosData.ativos.forEach(a => {
      const t = a.nome.split('_')[0];
      tickerClassMap[t] = a.macro_classe;
    });

    // Processar Dividendos
    rawData = divData.movimentacoes.map(m => {
      const ticker = m.ativo.split('_')[0];
      return {
        date: new Date(m.data),
        year: m.data.substring(0, 4),
        month: m.data.substring(0, 7),
        val: m.valor_total || 0,
        class: tickerClassMap[ticker] || 'Outros',
        ticker: ticker,
        ativo: m.ativo
      };
    }).sort((a,b) => a.date - b.date);

    // Calcular Saldo Atual de Cada Ativo
    const saldos = {}; // { ativo: quantidade }
    movData.movimentacoes.forEach(m => {
      const ativo = m.ativo;
      if (!saldos[ativo]) saldos[ativo] = 0;
      
      if (m.tipo === 'APORTE' || m.tipo === 'PROVENTO_DIVIDENDO' || m.tipo === 'PROVENTO_JCP') {
        saldos[ativo] += m.quantidade || 0;
      } else if (m.tipo === 'RESGATE' || m.tipo === 'VENDA') {
        saldos[ativo] -= m.quantidade || 0;
      }
    });

    // Pegar Cota√ß√£o Mais Recente (jan/2026 ou fev/2026)
    const recentMonths = ['fev/2026', 'jan/2026', 'dez/2025', 'nov/2025'];
    
    Object.keys(saldos).forEach(ativo => {
      const qty = saldos[ativo];
      if (qty <= 0) return; // Skip ativos zerados
      
      // Buscar cota√ß√£o mais recente
      let price = 0;
      for (const month of recentMonths) {
        if (cotData[ativo] && cotData[ativo][month]) {
          price = cotData[ativo][month];
          break;
        }
      }
      
      portfolioValue[ativo] = qty * price;
    });

    // Calcular DY por Ativo (√∫ltimos 12 meses)
    const oneYearAgo = new Date();
    oneYearAgo.setMonth(oneYearAgo.getMonth() - 12);
    
    const divs12m = {}; // { ativo: total_dividendos }
    rawData.filter(d => d.date >= oneYearAgo).forEach(d => {
      if (!divs12m[d.ativo]) divs12m[d.ativo] = 0;
      divs12m[d.ativo] += d.val;
    });

    Object.keys(portfolioValue).forEach(ativo => {
      const ticker = ativo.split('_')[0];
      const value = portfolioValue[ativo];
      const divs = divs12m[ativo] || 0;
      const dy = value > 0 ? (divs / value) * 100 : 0;
      
      dyData[ativo] = {
        ticker,
        divs12m: divs,
        value,
        dy,
        class: tickerClassMap[ticker] || 'Outros'
      };
    });

    // Popular Filtro de Classes
    const uniqueClasses = [...new Set(rawData.map(d => d.class))].sort();
    const select = document.getElementById('filterClass');
    uniqueClasses.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = LABELS[c] || c;
      select.appendChild(opt);
    });

    renderAll();
    document.getElementById('loading').classList.add('hidden');

  } catch (e) {
    alert('Erro ao carregar dados: ' + e.message);
    console.error(e);
  }
}

function renderAll() {
  updateKPIs();
  renderAnual();
  renderMensal();
  renderDonut();
  renderDYCategoria();
  renderTop();
  renderDYAtivo();
}

// === KPIS ===
function updateKPIs() {
  const total = rawData.reduce((s, d) => s + d.val, 0);
  const now = new Date();
  const currentYear = now.getFullYear().toString();
  
  const ytd = rawData.filter(d => d.year === currentYear).reduce((s, d) => s + d.val, 0);
  
  const oneYearAgo = new Date();
  oneYearAgo.setMonth(now.getMonth() - 12);
  const l12mTotal = rawData.filter(d => d.date >= oneYearAgo).reduce((s, d) => s + d.val, 0);
  
  // DY Geral
  const totalValue = Object.values(portfolioValue).reduce((s, v) => s + v, 0);
  const dyGeral = totalValue > 0 ? (l12mTotal / totalValue) * 100 : 0;
  
  // CAGR: ano completo anterior vs 5 anos atr√°s
  const lastFullYear = currentYear - 1;
  const startYear = lastFullYear - 4;
  
  const endVal = rawData.filter(d => d.year == lastFullYear).reduce((s,d) => s+d.val, 0);
  const startVal = rawData.filter(d => d.year == startYear).reduce((s,d) => s+d.val, 0);
  
  let cagr = 0;
  if (startVal > 0 && endVal > 0) {
    cagr = (Math.pow(endVal / startVal, 1/4) - 1) * 100;
  }

  setTxt('kpiTotal', fmt(total));
  setTxt('kpiYTD', fmt(ytd));
  setTxt('kpiAvg', fmt(l12mTotal / 12));
  setTxt('kpiDY', dyGeral.toFixed(2) + '%');
  setTxt('kpiYTDLabel', `Em ${currentYear}`);
}

// === CHARTS ===
function renderAnual() {
  const ctx = getCtx('chartAnual');
  const years = [...new Set(rawData.map(d => d.year))].sort();
  const classes = [...new Set(rawData.map(d => d.class))];
  
  const selectedClass = document.getElementById('filterClass').value;
  const activeClasses = selectedClass === 'all' ? classes : [selectedClass];

  const datasets = activeClasses.map(c => ({
    label: LABELS[c] || c,
    data: years.map(y => rawData.filter(d => d.year === y && d.class === c).reduce((s,d) => s+d.val, 0)),
    backgroundColor: COLORS[c] || getColorHash(c),
    borderRadius: 4
  }));

  if (charts.anual) charts.anual.destroy();
  charts.anual = new Chart(ctx, {
    type: 'bar',
    data: { labels: years, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { stacked: true, grid: { display: false } },
        y: { stacked: true, ticks: { callback: v => compactFmt(v) } }
      },
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } },
        tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ' + fmt(ctx.raw) } }
      }
    }
  });
}

function renderMensal() {
  const ctx = getCtx('chartMensal');
  
  const monthlyData = {};
  rawData.forEach(d => {
    if (!monthlyData[d.month]) monthlyData[d.month] = {};
    if (!monthlyData[d.month][d.class]) monthlyData[d.month][d.class] = 0;
    monthlyData[d.month][d.class] += d.val;
  });

  let months = Object.keys(monthlyData).sort();
  if (monthLimit !== 999) {
    months = months.slice(-monthLimit);
  }

  const classes = [...new Set(rawData.map(d => d.class))];
  const datasets = classes.map(c => ({
    label: LABELS[c] || c,
    data: months.map(m => monthlyData[m][c] || 0),
    backgroundColor: COLORS[c] || getColorHash(c),
    stack: 'Stack 0',
    barPercentage: 0.8,
    categoryPercentage: 0.9
  }));

  const MONTH_NAMES = ['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];
  const labels = months.map(ym => {
    const [y, m] = ym.split('-');
    return `${MONTH_NAMES[parseInt(m) - 1]}/${y.slice(2)}`;
  });

  if (charts.mensal) charts.mensal.destroy();
  charts.mensal = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: { stacked: true, grid: { display: false } },
        y: { stacked: true, ticks: { callback: v => compactFmt(v) } }
      },
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } }
      }
    }
  });
}

function renderDonut() {
  const ctx = getCtx('chartDonut');
  
  let filteredData = rawData;
  if (donutLimit !== 999) {
    const now = new Date();
    const limitDate = new Date();
    limitDate.setMonth(now.getMonth() - donutLimit);
    filteredData = rawData.filter(d => d.date >= limitDate);
  }
  
  const classes = [...new Set(filteredData.map(d => d.class))];
  const data = classes.map(c => filteredData.filter(d => d.class === c).reduce((s,d)=>s+d.val, 0));

  if (charts.donut) charts.donut.destroy();
  charts.donut = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: classes.map(c => LABELS[c] || c),
      datasets: [{
        data: data,
        backgroundColor: classes.map(c => COLORS[c] || getColorHash(c)),
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '65%',
      plugins: {
        legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } }
      }
    }
  });
}

function renderDYCategoria() {
  const ctx = getCtx('chartDYCategoria');
  
  // Agrupar por categoria
  const catData = {};
  Object.values(dyData).forEach(d => {
    if (!catData[d.class]) {
      catData[d.class] = { divs: 0, value: 0 };
    }
    catData[d.class].divs += d.divs12m;
    catData[d.class].value += d.value;
  });

  // Filtrar categorias vazias (sem valor)
  const classes = Object.keys(catData).filter(c => catData[c].value > 0).sort();
  const dyValues = classes.map(c => {
    const dy = catData[c].value > 0 ? (catData[c].divs / catData[c].value) * 100 : 0;
    return dy;
  });

  // DY Geral
  const totalDivs = Object.values(catData).reduce((s, v) => s + v.divs, 0);
  const totalValue = Object.values(catData).reduce((s, v) => s + v.value, 0);
  const dyGeral = totalValue > 0 ? (totalDivs / totalValue) * 100 : 0;

  if (charts.dyCategoria) charts.dyCategoria.destroy();
  charts.dyCategoria = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [...classes.map(c => LABELS[c] || c), 'GERAL'],
      datasets: [{
        label: 'DY (%)',
        data: [...dyValues, dyGeral],
        backgroundColor: [...classes.map(c => COLORS[c] || '#95a5a6'), '#34495e'],
        borderRadius: 4,
        datalabels: {
          display: true,
          anchor: 'end',
          align: 'top',
          formatter: (value) => value.toFixed(2) + '%',
          font: { weight: 'bold', size: 10 },
          color: '#2d3748'
        }
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { 
          beginAtZero: true,
          ticks: { callback: v => v.toFixed(1) + '%' }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `DY: ${ctx.raw.toFixed(2)}%`
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

function renderTop() {
  const ctx = getCtx('chartTop');
  const oneYearAgo = new Date();
  oneYearAgo.setMonth(new Date().getMonth() - 12);
  
  const grouped = {}; // { ticker: { total, class } }
  rawData.filter(d => d.date >= oneYearAgo).forEach(d => {
    if (!grouped[d.ticker]) {
      grouped[d.ticker] = { total: 0, class: d.class };
    }
    grouped[d.ticker].total += d.val;
  });

  const sorted = Object.entries(grouped)
    .sort((a,b) => b[1].total - a[1].total)
    .slice(0, 10);
  
  if (charts.top) charts.top.destroy();
  charts.top = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(s => s[0]),
      datasets: [{
        label: 'Total 12M',
        data: sorted.map(s => s[1].total),
        backgroundColor: sorted.map(s => COLORS[s[1].class] || '#667eea'),
        borderRadius: 4,
        datalabels: {
          display: true,
          anchor: 'end',
          align: 'right',
          formatter: (value) => compactFmt(value),
          font: { weight: 'bold', size: 10 },
          color: '#2d3748'
        }
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          display: true,
          position: 'bottom',
          labels: {
            generateLabels: () => {
              const classes = [...new Set(sorted.map(s => s[1].class))];
              return classes.map(c => ({
                text: LABELS[c] || c,
                fillStyle: COLORS[c] || '#95a5a6',
                hidden: false
              }));
            },
            boxWidth: 12,
            font: { size: 10 }
          }
        },
        tooltip: {
          callbacks: {
            label: ctx => fmt(ctx.raw)
          }
        }
      },
      scales: {
        x: { ticks: { callback: v => compactFmt(v) } }
      }
    },
    plugins: [ChartDataLabels]
  });
}

function renderDYAtivo() {
  const ctx = getCtx('chartDYAtivo');
  
  // Ranquear por DY - TODOS os ativos com dividendos
  const sorted = Object.entries(dyData)
    .filter(([ativo, d]) => d.divs12m > 0) // Filtrar apenas ativos que pagaram dividendos
    .sort((a, b) => b[1].dy - a[1].dy);
  
  // Altura din√¢mica baseada no n√∫mero de ativos
  const chartHeight = Math.max(800, sorted.length * 25);
  const canvas = document.getElementById('chartDYAtivo');
  canvas.height = chartHeight;
  
  if (charts.dyAtivo) charts.dyAtivo.destroy();
  charts.dyAtivo = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.map(([ativo, d]) => d.ticker),
      datasets: [{
        label: 'DY (%)',
        data: sorted.map(([ativo, d]) => d.dy),
        backgroundColor: sorted.map(([ativo, d]) => COLORS[d.class] || '#95a5a6'),
        borderRadius: 4,
        datalabels: {
          display: true,
          anchor: 'end',
          align: 'right',
          formatter: (value) => value.toFixed(2) + '%',
          font: { weight: 'bold', size: 9 },
          color: '#2d3748'
        }
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          display: true,
          position: 'bottom',
          labels: {
            generateLabels: () => {
              const classes = [...new Set(sorted.map(s => s[1].class))];
              return classes.map(c => ({
                text: LABELS[c] || c,
                fillStyle: COLORS[c] || '#95a5a6',
                hidden: false
              }));
            },
            boxWidth: 12,
            font: { size: 10 }
          }
        },
        tooltip: {
          callbacks: {
            label: ctx => `DY: ${ctx.raw.toFixed(2)}%`
          }
        }
      },
      scales: {
        x: { 
          ticks: { callback: v => v.toFixed(1) + '%' }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

// === UTILS ===
function setMonthRange(n, btn) {
  monthLimit = n;
  const parent = btn.parentElement;
  parent.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderMensal();
}

function setDonutRange(n, btn) {
  donutLimit = n;
  const parent = btn.parentElement;
  parent.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderDonut();
}

function updateCharts() {
  renderAnual();
}

function fmt(n) { return n.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
function compactFmt(n) { return Intl.NumberFormat('pt-BR', { notation: "compact", compactDisplay: "short" }).format(n); }
function setTxt(id, t) { document.getElementById(id).textContent = t; }
function getCtx(id) { return document.getElementById(id).getContext('2d'); }

function getColorHash(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
  return '#' + '00000'.substring(0, 6 - c.length) + c;
}

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const isDark = document.body.classList.contains('dark-mode');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
  document.getElementById('theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
}

if (localStorage.getItem('theme') === 'dark') toggleTheme();

init();
</script>
</body>
</html>
