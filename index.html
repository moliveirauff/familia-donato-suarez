<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçº Controle de Mamadeiras</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 10px; padding-bottom: 40px; }
        h1 { text-align: center; color: #1f2937; font-size: 20px; margin: 15px 0; font-weight: 700; }
        .update-time { text-align: center; font-size: 11px; color: #6b7280; margin-bottom: 20px; }
        
        /* Cards */
        .card { background: white; border-radius: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 20px; border: 1px solid #e5e7eb; }
        .card-header { font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 15px; border-bottom: 1px solid #f3f4f6; padding-bottom: 8px; }
        
        /* Stats Row */
        .stat-row { display: flex; justify-content: space-around; align-items: center; }
        .stat-item { text-align: center; }
        .stat-val { font-size: 24px; font-weight: 800; color: #2563eb; }
        .stat-lbl { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #9ca3af; margin-top: 2px; }

        /* Chart Containers - Fix Height for Mobile */
        .chart-container { position: relative; height: 300px; width: 100%; }
        
        @media (min-width: 768px) {
            body { max-width: 800px; margin: 0 auto; }
            .chart-container { height: 350px; }
        }
    </style>
</head>
<body>

    <h1>üçº Controle do Matheus</h1>
    <div class="update-time">Dados at√©: 30/01/2026</div>

    <!-- KPIs -->
    <div class="card">
        <div class="stat-row">
            <div class="stat-item">
                <div class="stat-val" id="kpi-vol">--</div>
                <div class="stat-lbl">Total (30/01)</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="kpi-avg">--</div>
                <div class="stat-lbl">M√©dia/Mamada</div>
            </div>
            <div class="stat-item">
                <div class="stat-val" id="kpi-count">--</div>
                <div class="stat-lbl">Mamadas</div>
            </div>
        </div>
    </div>

    <!-- Gr√°fico 1 -->
    <div class="card">
        <div class="card-header">üìä Volume Total por Dia (ml)</div>
        <div class="chart-container">
            <canvas id="chartTotal"></canvas>
        </div>
    </div>

    <!-- Gr√°fico 2 -->
    <div class="card">
        <div class="card-header">üìâ M√©dia (Barra) vs Frequ√™ncia (Linha)</div>
        <div class="chart-container">
            <canvas id="chartAvg"></canvas>
        </div>
    </div>

    <!-- Gr√°fico 3 -->
    <div class="card">
        <div class="card-header">üïê Distribui√ß√£o (√öltimos 14 dias)</div>
        <div class="chart-container">
            <canvas id="chartScatter"></canvas>
        </div>
    </div>

    <script>
        // --- DADOS BRUTOS (Inseridos pelo Bot) ---
        const rawData = [
            {d: "2026-01-17", t: "00:45", v: 135}, {d: "2026-01-17", t: "02:50", v: 50}, {d: "2026-01-17", t: "06:30", v: 100}, {d: "2026-01-17", t: "10:40", v: 100}, {d: "2026-01-17", t: "13:40", v: 115}, {d: "2026-01-17", t: "17:00", v: 110}, {d: "2026-01-17", t: "20:30", v: 105},
            {d: "2026-01-18", t: "02:20", v: 150}, {d: "2026-01-18", t: "06:13", v: 70}, {d: "2026-01-18", t: "10:15", v: 140}, {d: "2026-01-18", t: "14:10", v: 150}, {d: "2026-01-18", t: "17:50", v: 120}, {d: "2026-01-18", t: "21:30", v: 135},
            {d: "2026-01-19", t: "02:35", v: 140}, {d: "2026-01-19", t: "07:00", v: 90}, {d: "2026-01-19", t: "10:00", v: 120}, {d: "2026-01-19", t: "13:38", v: 120}, {d: "2026-01-19", t: "16:40", v: 120}, {d: "2026-01-19", t: "20:05", v: 70}, {d: "2026-01-19", t: "22:35", v: 140},
            {d: "2026-01-20", t: "03:05", v: 100}, {d: "2026-01-20", t: "05:00", v: 30}, {d: "2026-01-20", t: "08:00", v: 80}, {d: "2026-01-20", t: "11:30", v: 135}, {d: "2026-01-20", t: "14:15", v: 80}, {d: "2026-01-20", t: "16:45", v: 60}, {d: "2026-01-20", t: "20:20", v: 150}, {d: "2026-01-20", t: "23:05", v: 90},
            {d: "2026-01-21", t: "01:40", v: 80}, {d: "2026-01-21", t: "03:40", v: 40}, {d: "2026-01-21", t: "07:20", v: 60}, {d: "2026-01-21", t: "10:15", v: 120}, {d: "2026-01-21", t: "13:18", v: 70}, {d: "2026-01-21", t: "16:25", v: 70}, {d: "2026-01-21", t: "19:35", v: 140},
            {d: "2026-01-22", t: "00:00", v: 140}, {d: "2026-01-22", t: "04:30", v: 100}, {d: "2026-01-22", t: "08:30", v: 100}, {d: "2026-01-22", t: "11:20", v: 90}, {d: "2026-01-22", t: "14:30", v: 80}, {d: "2026-01-22", t: "17:20", v: 100}, {d: "2026-01-22", t: "20:30", v: 150},
            {d: "2026-01-23", t: "01:10", v: 150}, {d: "2026-01-23", t: "05:00", v: 60}, {d: "2026-01-23", t: "07:15", v: 100}, {d: "2026-01-23", t: "11:50", v: 100}, {d: "2026-01-23", t: "14:15", v: 140}, {d: "2026-01-23", t: "16:50", v: 130}, {d: "2026-01-23", t: "19:45", v: 150},
            {d: "2026-01-24", t: "00:05", v: 140}, {d: "2026-01-24", t: "04:20", v: 110}, {d: "2026-01-24", t: "07:05", v: 40}, {d: "2026-01-24", t: "09:00", v: 140}, {d: "2026-01-24", t: "12:15", v: 130}, {d: "2026-01-24", t: "16:15", v: 130}, {d: "2026-01-24", t: "19:30", v: 120},
            {d: "2026-01-25", t: "00:40", v: 145}, {d: "2026-01-25", t: "03:40", v: 70}, {d: "2026-01-25", t: "06:00", v: 60}, {d: "2026-01-25", t: "08:50", v: 50}, {d: "2026-01-25", t: "11:00", v: 100}, {d: "2026-01-25", t: "14:20", v: 110}, {d: "2026-01-25", t: "17:30", v: 110}, {d: "2026-01-25", t: "20:30", v: 140},
            {d: "2026-01-26", t: "02:30", v: 140}, {d: "2026-01-26", t: "08:00", v: 135}, {d: "2026-01-26", t: "11:00", v: 90}, {d: "2026-01-26", t: "14:00", v: 60}, {d: "2026-01-26", t: "17:00", v: 110}, {d: "2026-01-26", t: "20:10", v: 150},
            {d: "2026-01-27", t: "00:50", v: 140}, {d: "2026-01-27", t: "04:35", v: 140}, {d: "2026-01-27", t: "08:20", v: 60}, {d: "2026-01-27", t: "11:30", v: 100}, {d: "2026-01-27", t: "14:20", v: 140}, {d: "2026-01-27", t: "17:30", v: 110}, {d: "2026-01-27", t: "20:30", v: 60},
            {d: "2026-01-28", t: "01:30", v: 100}, {d: "2026-01-28", t: "04:15", v: 110}, {d: "2026-01-28", t: "09:00", v: 100}, {d: "2026-01-28", t: "12:30", v: 110}, {d: "2026-01-28", t: "15:30", v: 80}, {d: "2026-01-28", t: "17:30", v: 100}, {d: "2026-01-28", t: "20:30", v: 60},
            {d: "2026-01-29", t: "00:40", v: 140}, {d: "2026-01-29", t: "04:40", v: 100}, {d: "2026-01-29", t: "09:30", v: 100}, {d: "2026-01-29", t: "12:45", v: 100}, {d: "2026-01-29", t: "17:20", v: 130}, {d: "2026-01-29", t: "23:40", v: 120},
            {d: "2026-01-30", t: "04:20", v: 120}, {d: "2026-01-30", t: "10:00", v: 110}, {d: "2026-01-30", t: "13:20", v: 100}, {d: "2026-01-30", t: "16:40", v: 60}, {d: "2026-01-30", t: "19:50", v: 140}
        ];

        // --- L√ìGICA DE PROCESSAMENTO ---
        const today = new Date();
        const cutoffDate = new Date();
        cutoffDate.setDate(today.getDate() - 14); // 14 dias atr√°s

        const dailyData = {};
        const scatterPoints = [];

        rawData.forEach(r => {
            // Scatter (Todos os pontos dos ultimos 14 dias)
            const dateObj = new Date(r.d + "T" + r.t);
            
            // Agrupamento Di√°rio
            if (!dailyData[r.d]) dailyData[r.d] = { vol: 0, count: 0, date: new Date(r.d) };
            dailyData[r.d].vol += r.v;
            dailyData[r.d].count++;

            // Se for recente, adiciona ao scatter
            if (dateObj >= cutoffDate) {
                scatterPoints.push({ x: dateObj, y: r.v });
            }
        });

        // Separar Recentes vs Antigos
        const chartLabels = [];
        const chartVol = [];
        const chartAvg = [];
        const chartCount = [];

        const sortedDays = Object.keys(dailyData).sort();
        
        // Estrutura para agrupar semanas antigas
        const weeklyBuckets = {};

        sortedDays.forEach(dayStr => {
            const dayData = dailyData[dayStr];
            
            if (dayData.date >= cutoffDate) {
                // √â recente: Mostrar Dia a Dia
                const label = dayData.date.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
                chartLabels.push(label);
                chartVol.push(dayData.vol);
                chartCount.push(dayData.count);
                chartAvg.push(Math.round(dayData.vol / dayData.count));
            } else {
                // √â antigo: Agrupar por Semana (Segunda-feira)
                // Acha a segunda-feira daquela semana
                const d = new Date(dayData.date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day == 0 ? -6 : 1); // adjust when day is sunday
                const monday = new Date(d.setDate(diff));
                const mondayStr = monday.toISOString().split('T')[0];

                if (!weeklyBuckets[mondayStr]) weeklyBuckets[mondayStr] = { volSum: 0, countSum: 0, days: 0 };
                weeklyBuckets[mondayStr].volSum += dayData.vol;
                weeklyBuckets[mondayStr].countSum += dayData.count;
                weeklyBuckets[mondayStr].days++;
            }
        });

        // Adicionar Semanas Antigas no IN√çCIO dos arrays (se houver)
        // (Neste dataset n√£o haver√°, mas a l√≥gica est√° pronta)
        Object.keys(weeklyBuckets).sort().forEach(weekStart => {
            const w = weeklyBuckets[weekStart];
            const startFormat = new Date(weekStart).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
            
            // M√©dia Di√°ria daquela semana
            chartLabels.unshift(`Sem. ${startFormat}`);
            chartVol.unshift(Math.round(w.volSum / w.days)); // Volume m√©dio di√°rio na semana
            chartCount.unshift(Math.round(w.countSum / w.days)); // M√©dia de mamadas/dia
            chartAvg.unshift(Math.round(w.volSum / w.countSum)); // M√©dia por mamada real
        });

        // Atualizar KPIs do √∫ltimo dia
        const lastDay = sortedDays[sortedDays.length - 1];
        document.getElementById('kpi-vol').innerText = dailyData[lastDay].vol + " ml";
        document.getElementById('kpi-avg').innerText = Math.round(dailyData[lastDay].vol / dailyData[lastDay].count) + " ml";
        document.getElementById('kpi-count').innerText = dailyData[lastDay].count;


        // --- CHART CONFIGS ---
        Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto';
        Chart.defaults.color = '#6b7280';

        // 1. Volume Total (Bar)
        new Chart(document.getElementById('chartTotal'), {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Volume Di√°rio',
                    data: chartVol,
                    backgroundColor: '#3b82f6',
                    borderRadius: 4,
                    barPercentage: 0.6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: {display: false} },
                scales: { y: { grid: { borderDash: [2, 2] } }, x: { grid: { display: false } } }
            }
        });

        // 2. M√©dia (Bar) + Count (Line)
        new Chart(document.getElementById('chartAvg'), {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [
                    {
                        label: 'M√©dia/Mamada (ml)',
                        data: chartAvg,
                        backgroundColor: '#10b981', // Verde
                        borderRadius: 4,
                        order: 2,
                        yAxisID: 'y'
                    },
                    {
                        type: 'line',
                        label: 'Qtd Mamadas',
                        data: chartCount,
                        borderColor: '#f59e0b', // Amarelo/Laranja
                        borderWidth: 2,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#f59e0b',
                        pointRadius: 4,
                        tension: 0.1,
                        order: 1,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { position: 'left', grid: { borderDash: [2, 2] } },
                    y1: { position: 'right', grid: { display: false }, min: 0, max: 10 },
                    x: { grid: { display: false } }
                }
            }
        });

        // 3. Scatter (Dia no X, Volume no Y)
        new Chart(document.getElementById('chartScatter'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Mamada (ml)',
                    data: scatterPoints, // {x: Date, y: 120}
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: '#2563eb',
                    borderWidth: 1,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: {display: false} },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'day', displayFormats: { day: 'dd/MM' } },
                        title: { display: true, text: 'Dia' },
                        grid: { display: false }
                    },
                    y: {
                        title: { display: true, text: 'Volume (ml)' },
                        min: 0,
                        grid: { borderDash: [2, 2] }
                    }
                }
            }
        });
    </script>
</body>
</html>
