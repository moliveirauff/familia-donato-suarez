<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçº BI do Matheus</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; margin: 0; padding: 10px; padding-bottom: 60px; color: #1f2937; }
        h1 { text-align: center; font-size: 20px; margin: 15px 0 5px 0; font-weight: 800; color: #111827; }
        .subtitle { text-align: center; font-size: 12px; color: #6b7280; margin-bottom: 20px; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 15px; margin-bottom: 24px; border: 1px solid #e5e7eb; }
        .card-header { font-size: 15px; font-weight: 700; color: #374151; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .kpi-row { display: flex; justify-content: space-between; margin-bottom: 0; }
        .kpi-box { text-align: center; flex: 1; border-right: 1px solid #f3f4f6; }
        .kpi-box:last-child { border-right: none; }
        .kpi-val { font-size: 22px; font-weight: 800; color: #2563eb; }
        .kpi-lbl { font-size: 10px; text-transform: uppercase; color: #9ca3af; font-weight: 600; margin-top: 2px; }
        .filter-group { display: flex; gap: 5px; }
        .btn-filter { background: #e5e7eb; border: none; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; color: #4b5563; cursor: pointer; transition: all 0.2s; }
        .btn-filter.active { background: #2563eb; color: white; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        @media (min-width: 768px) { body { max-width: 900px; margin: 0 auto; } .chart-container { height: 380px; } }
    </style>
</head>
<body>

    <h1>üçº BI do Matheus</h1>
    <div class="subtitle">√öltima atualiza√ß√£o: 30/01/2026</div>

    <div class="card">
        <div class="kpi-row">
            <div class="kpi-box"><div class="kpi-val" id="kpi-vol">--</div><div class="kpi-lbl">Vol. Ontem</div></div>
            <div class="kpi-box"><div class="kpi-val" id="kpi-avg">--</div><div class="kpi-lbl">M√©dia Di√°ria</div></div>
            <div class="kpi-box"><div class="kpi-val" id="kpi-records">--</div><div class="kpi-lbl">Registros</div></div>
        </div>
    </div>

    <!-- 1. Volume Total -->
    <div class="card">
        <div class="card-header">üìä Volume Di√°rio (ml)</div>
        <div class="chart-container"><canvas id="cTotal"></canvas></div>
    </div>

    <!-- 2. M√©dia e Qtd -->
    <div class="card">
        <div class="card-header">üìâ M√©dia/Mamada vs Qtd</div>
        <div class="chart-container"><canvas id="cAvg"></canvas></div>
    </div>

    <!-- 3. Dispers√£o Di√°ria -->
    <div class="card">
        <div class="card-header">üìç Distribui√ß√£o por Dia</div>
        <div class="chart-container"><canvas id="cScatterDay"></canvas></div>
    </div>

    <!-- 4. Histograma -->
    <div class="card">
        <div class="card-header">
            <span>üîî Frequ√™ncia de Volume</span>
            <div class="filter-group">
                <button class="btn-filter active" onclick="updateFilter('hist', 14, this)">14D</button>
                <button class="btn-filter" onclick="updateFilter('hist', 999, this)">Tudo</button>
            </div>
        </div>
        <div class="chart-container"><canvas id="cHist"></canvas></div>
    </div>

    <!-- 5. Tend√™ncia Hor√°ria -->
    <div class="card">
        <div class="card-header">
            <span>üïê Tend√™ncia Hor√°ria (2h)</span>
            <div class="filter-group">
                <button class="btn-filter active" onclick="updateFilter('hourly', 14, this)">14D</button>
                <button class="btn-filter" onclick="updateFilter('hourly', 999, this)">Tudo</button>
            </div>
        </div>
        <div class="chart-container"><canvas id="cHourly"></canvas></div>
    </div>

    <!-- 6. Intervalo -->
    <div class="card">
        <div class="card-header">
            <span>‚è≥ Intervalo vs Volume</span>
            <div class="filter-group">
                <button class="btn-filter active" onclick="updateFilter('interval', 14, this)">14D</button>
                <button class="btn-filter" onclick="updateFilter('interval', 999, this)">Tudo</button>
            </div>
        </div>
        <div class="chart-container"><canvas id="cInterval"></canvas></div>
    </div>

    <script>
        const rawData = [
            {d: "2026-01-17", t: "00:45", v: 135}, {d: "2026-01-17", t: "02:50", v: 50}, {d: "2026-01-17", t: "06:30", v: 100}, {d: "2026-01-17", t: "10:40", v: 100}, {d: "2026-01-17", t: "13:40", v: 115}, {d: "2026-01-17", t: "17:00", v: 110}, {d: "2026-01-17", t: "20:30", v: 105},
            {d: "2026-01-18", t: "02:20", v: 150}, {d: "2026-01-18", t: "06:13", v: 70}, {d: "2026-01-18", t: "10:15", v: 140}, {d: "2026-01-18", t: "14:10", v: 150}, {d: "2026-01-18", t: "17:50", v: 120}, {d: "2026-01-18", t: "21:30", v: 135},
            {d: "2026-01-19", t: "02:35", v: 140}, {d: "2026-01-19", t: "07:00", v: 90}, {d: "2026-01-19", t: "10:00", v: 120}, {d: "2026-01-19", t: "13:38", v: 120}, {d: "2026-01-19", t: "16:40", v: 120}, {d: "2026-01-19", t: "20:05", v: 70}, {d: "2026-01-19", t: "22:35", v: 140},
            {d: "2026-01-20", t: "03:05", v: 100}, {d: "2026-01-20", t: "05:00", v: 30}, {d: "2026-01-20", t: "08:00", v: 80}, {d: "2026-01-20", t: "11:30", v: 135}, {d: "2026-01-20", t: "14:15", v: 80}, {d: "2026-01-20", t: "16:45", v: 60}, {d: "2026-01-20", t: "20:20", v: 150}, {d: "2026-01-20", t: "23:05", v: 90},
            {d: "2026-01-21", t: "01:40", v: 80}, {d: "2026-01-21", t: "03:40", v: 40}, {d: "2026-01-21", t: "07:20", v: 60}, {d: "2026-01-21", t: "10:15", v: 120}, {d: "2026-01-21", t: "13:18", v: 70}, {d: "2026-01-21", t: "16:25", v: 70}, {d: "2026-01-21", t: "19:35", v: 140},
            {d: "2026-01-22", t: "00:00", v: 140}, {d: "2026-01-22", t: "04:30", v: 100}, {d: "2026-01-22", t: "08:30", v: 100}, {d: "2026-01-22", t: "11:20", v: 90}, {d: "2026-01-22", t: "14:30", v: 80}, {d: "2026-01-22", t: "17:20", v: 100}, {d: "2026-01-22", t: "20:30", v: 150},
            {d: "2026-01-23", t: "01:10", v: 150}, {d: "2026-01-23", t: "05:00", v: 60}, {d: "2026-01-23", t: "07:15", v: 100}, {d: "2026-01-23", t: "11:50", v: 100}, {d: "2026-01-23", t: "14:15", v: 140}, {d: "2026-01-23", t: "16:50", v: 130}, {d: "2026-01-23", t: "19:45", v: 150},
            {d: "2026-01-24", t: "00:05", v: 140}, {d: "2026-01-24", t: "04:20", v: 110}, {d: "2026-01-24", t: "07:05", v: 40}, {d: "2026-01-24", t: "09:00", v: 140}, {d: "2026-01-24", t: "12:15", v: 130}, {d: "2026-01-24", t: "16:15", v: 130}, {d: "2026-01-24", t: "19:30", v: 120},
            {d: "2026-01-25", t: "00:40", v: 145}, {d: "2026-01-25", t: "03:40", v: 70}, {d: "2026-01-25", t: "06:00", v: 60}, {d: "2026-01-25", t: "08:50", v: 50}, {d: "2026-01-25", t: "11:00", v: 100}, {d: "2026-01-25", t: "14:20", v: 110}, {d: "2026-01-25", t: "17:30", v: 110}, {d: "2026-01-25", t: "20:30", v: 140},
            {d: "2026-01-26", t: "02:30", v: 140}, {d: "2026-01-26", t: "08:00", v: 135}, {d: "2026-01-26", t: "11:00", v: 90}, {d: "2026-01-26", t: "14:00", v: 60}, {d: "2026-01-26", t: "17:00", v: 110}, {d: "2026-01-26", t: "20:10", v: 150},
            {d: "2026-01-27", t: "00:50", v: 140}, {d: "2026-01-27", t: "04:35", v: 140}, {d: "2026-01-27", t: "08:20", v: 60}, {d: "2026-01-27", t: "11:30", v: 100}, {d: "2026-01-27", t: "14:20", v: 140}, {d: "2026-01-27", t: "17:30", v: 110}, {d: "2026-01-27", t: "20:30", v: 60},
            {d: "2026-01-28", t: "01:30", v: 100}, {d: "2026-01-28", t: "04:15", v: 110}, {d: "2026-01-28", t: "09:00", v: 100}, {d: "2026-01-28", t: "12:30", v: 110}, {d: "2026-01-28", t: "15:30", v: 80}, {d: "2026-01-28", t: "17:30", v: 100}, {d: "2026-01-28", t: "20:30", v: 60},
            {d: "2026-01-29", t: "00:40", v: 140}, {d: "2026-01-29", t: "04:40", v: 100}, {d: "2026-01-29", t: "09:30", v: 100}, {d: "2026-01-29", t: "12:45", v: 100}, {d: "2026-01-29", t: "17:20", v: 130}, {d: "2026-01-29", t: "23:40", v: 120},
            {d: "2026-01-30", t: "04:20", v: 120}, {d: "2026-01-30", t: "10:00", v: 110}, {d: "2026-01-30", t: "13:20", v: 100}, {d: "2026-01-30", t: "16:40", v: 60}, {d: "2026-01-30", t: "19:50", v: 140}
        ];

        const lastDataDate = new Date(rawData[rawData.length-1].d + "T12:00:00");
        let processedData = rawData.map(r => ({
            ...r,
            dateObj: new Date(r.d + "T" + r.t),
            dayStr: r.d.split('-').reverse().slice(0,2).join('/')
        })).sort((a,b) => a.dateObj - b.dateObj);

        // Agrega√ß√£o Di√°ria
        const dailyMap = {};
        processedData.forEach(r => {
            if(!dailyMap[r.d]) dailyMap[r.d] = { vol:0, count:0 };
            dailyMap[r.d].vol += r.v;
            dailyMap[r.d].count++;
        });

        for(let i=1; i<processedData.length; i++) {
            const diffMs = processedData[i].dateObj - processedData[i-1].dateObj;
            processedData[i].intervalHours = (diffMs / 60000) / 60;
        }

        function getFilteredData(daysLimit) {
            if (daysLimit > 100) return processedData;
            const limitTime = new Date(lastDataDate);
            limitTime.setDate(limitTime.getDate() - daysLimit);
            return processedData.filter(d => d.dateObj >= limitTime);
        }

        function calculatePeriodDailyAvg(data) {
            const dMap = {};
            data.forEach(r => {
                if(!dMap[r.d]) dMap[r.d] = 0;
                dMap[r.d] += r.v;
            });
            const days = Object.keys(dMap).length;
            const total = Object.values(dMap).reduce((a,b) => a+b, 0);
            return days ? (total/days) : 0;
        }

        const lastDayKey = rawData[rawData.length-1].d;
        document.getElementById('kpi-vol').innerText = dailyMap[lastDayKey].vol + " ml";
        
        const recentData = getFilteredData(14);
        const avg14d = Math.round(calculatePeriodDailyAvg(recentData));
        document.getElementById('kpi-avg').innerText = avg14d + " ml";
        document.getElementById('kpi-records').innerText = processedData.length;

        // Render Overview Charts
        const dailyKeys = Object.keys(dailyMap).sort();
        const lbls = dailyKeys.map(k => k.split('-').reverse().slice(0,2).join('/'));
        const dVols = dailyKeys.map(k => dailyMap[k].vol);
        const dCounts = dailyKeys.map(k => dailyMap[k].count);
        const dAvgs = dailyKeys.map(k => Math.round(dailyMap[k].vol / dailyMap[k].count));

        new Chart(document.getElementById('cTotal'), {
            type: 'bar',
            data: { labels: lbls, datasets: [{ label: 'Total', data: dVols, backgroundColor: '#3b82f6', borderRadius: 4 }] },
            options: { maintainAspectRatio: false, plugins: {legend:{display:false}}, scales: { x: {grid:{display:false}} } }
        });

        new Chart(document.getElementById('cAvg'), {
            type: 'bar',
            data: {
                labels: lbls,
                datasets: [
                    { label: 'M√©dia (ml)', data: dAvgs, backgroundColor: '#10b981', order: 2, yAxisID: 'y' },
                    { type: 'line', label: 'Qtd', data: dCounts, borderColor: '#f59e0b', pointBackgroundColor:'white', order: 1, yAxisID: 'y1' }
                ]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    x: {grid:{display:false}},
                    y: { position: 'left', title: {display:true, text:'M√©dia ml'}, grid: { borderDash: [2, 2] } },
                    y1: { position: 'right', title: {display:true, text:'Qtd'}, grid:{display:false}, min: 0 }
                }
            }
        });

        new Chart(document.getElementById('cScatterDay'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Mamada',
                    data: processedData.map(d => ({ x: d.dayStr, y: d.v })),
                    backgroundColor: 'rgba(37, 99, 235, 0.6)',
                    borderColor: '#2563eb',
                    borderWidth: 1
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    x: { type: 'category', labels: lbls, grid:{display:false} },
                    y: { title: {display:true, text:'Volume (ml)'} }
                },
                plugins: { legend: {display:false} }
            }
        });

        // Dynamic Charts
        let chartHist, chartHourly, chartInterval;

        function renderHist(limit) {
            const data = getFilteredData(limit);
            const bins = {};
            data.forEach(r => {
                const binFloor = Math.floor(r.v / 20) * 20;
                const label = `${binFloor}-${binFloor+20}`;
                bins[label] = (bins[label] || 0) + 1;
            });
            const sortedKeys = Object.keys(bins).sort((a,b) => parseInt(a) - parseInt(b));
            
            const config = {
                type: 'bar',
                data: {
                    labels: sortedKeys,
                    datasets: [{ label: 'Frequ√™ncia', data: sortedKeys.map(k => bins[k]), backgroundColor: '#8b5cf6', borderRadius: 4 }]
                },
                options: { maintainAspectRatio: false, plugins: {legend:{display:false}}, scales: {x:{grid:{display:false}}, y:{beginAtZero:true}} }
            };

            if(chartHist) chartHist.destroy();
            chartHist = new Chart(document.getElementById('cHist'), config);
        }

        function renderHourly(limit) {
            const data = getFilteredData(limit);
            const bins = {};
            for(let i=0; i<24; i+=2) bins[`${i}h-${i+2}h`] = [];

            data.forEach(r => {
                const h = r.dateObj.getHours();
                const binFloor = Math.floor(h / 2) * 2;
                bins[`${binFloor}h-${binFloor+2}h`].push(r.v);
            });

            const labels = Object.keys(bins);
            const avgs = labels.map(k => {
                const vols = bins[k];
                if(vols.length === 0) return 0;
                return Math.round(vols.reduce((a,b)=>a+b,0) / vols.length);
            });

            const scatterPts = data.map(r => ({
                x: r.dateObj.getHours() + (r.dateObj.getMinutes()/60),
                y: r.v
            }));

            const config = {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            type: 'line',
                            label: 'M√©dia',
                            data: avgs.map((v, i) => ({x: i*2 + 1, y: v})),
                            borderColor: '#ec4899',
                            borderWidth: 3,
                            pointRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: 'Mamada',
                            data: scatterPts,
                            backgroundColor: 'rgba(156, 163, 175, 0.4)',
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', min: 0, max: 24, title: {display:true, text:'Hora do Dia'}, ticks: {stepSize: 2} },
                        y: { title: {display:true, text:'Volume'} }
                    }
                }
            };

            if(chartHourly) chartHourly.destroy();
            chartHourly = new Chart(document.getElementById('cHourly'), config);
        }

        function renderInterval(limit) {
            const data = getFilteredData(limit).filter(r => r.intervalHours);
            const periodDailyAvg = calculatePeriodDailyAvg(data);

            const config = {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Mamada',
                        data: data.map(r => ({ x: r.intervalHours, y: r.v, dateRef: r.d })),
                        backgroundColor: function(context) {
                            if(!context.raw) return '#999';
                            const dayKey = context.raw.dateRef;
                            const dayTotal = dailyMap[dayKey].vol;
                            return dayTotal >= periodDailyAvg ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)';
                        },
                        pointRadius: 6
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', title: {display:true, text:'Intervalo (Horas)'}, ticks: {stepSize: 0.5} },
                        y: { title: {display:true, text:'Volume (ml)'} }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    const dayKey = ctx.raw.dateRef;
                                    const dayVol = dailyMap[dayKey].vol;
                                    const status = dayVol >= periodDailyAvg ? 'Dia Bom' : 'Dia Ruim';
                                    return `${ctx.raw.y}ml (${status}: ${dayVol}ml vs Avg ${Math.round(periodDailyAvg)})`;
                                }
                            }
                        },
                        title: { display: true, text: `M√©dia do Per√≠odo: ${Math.round(periodDailyAvg)} ml/dia` }
                    }
                }
            };

            if(chartInterval) chartInterval.destroy();
            chartInterval = new Chart(document.getElementById('cInterval'), config);
        }

        window.updateFilter = function(chartName, days, btn) {
            const parent = btn.parentNode;
            parent.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(chartName === 'hist') renderHist(days);
            if(chartName === 'hourly') renderHourly(days);
            if(chartName === 'interval') renderInterval(days);
        };

        renderHist(14);
        renderHourly(14);
        renderInterval(14);

    </script>
</body>
</html>
