<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçº BI do Matheus</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; margin: 0; padding: 10px; padding-bottom: 60px; color: #1f2937; }
        h1 { text-align: center; font-size: 20px; margin: 15px 0 5px 0; font-weight: 800; color: #111827; }
        .subtitle { text-align: center; font-size: 12px; color: #6b7280; margin-bottom: 20px; }
        .card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 15px; margin-bottom: 24px; border: 1px solid #e5e7eb; }
        .card-header { font-size: 15px; font-weight: 700; color: #374151; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .kpi-row { display: flex; justify-content: space-between; margin-bottom: 0; }
        .kpi-box { text-align: center; flex: 1; border-right: 1px solid #f3f4f6; }
        .kpi-box:last-child { border-right: none; }
        .kpi-val { font-size: 22px; font-weight: 800; color: #2563eb; }
        .kpi-lbl { font-size: 10px; text-transform: uppercase; color: #9ca3af; font-weight: 600; margin-top: 2px; }
        .filter-group { display: flex; gap: 5px; }
        .btn-filter { background: #e5e7eb; border: none; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; color: #4b5563; cursor: pointer; transition: all 0.2s; }
        .btn-filter.active { background: #2563eb; color: white; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        #loading { text-align: center; padding: 50px; color: #6b7280; }
        @media (min-width: 768px) { body { max-width: 900px; margin: 0 auto; } .chart-container { height: 380px; } }
    </style>
</head>
<body>

    <h1>üçº BI do Matheus</h1>
    <div class="subtitle" id="last-update">Carregando dados...</div>

    <div id="loading">‚è≥ Conectando √† planilha...</div>

    <div id="dashboard" style="display:none;">
        <div class="card">
            <div class="kpi-row">
                <div class="kpi-box"><div class="kpi-val" id="kpi-vol">--</div><div class="kpi-lbl" id="lbl-vol">Vol. Recente</div></div>
                <div class="kpi-box"><div class="kpi-val" id="kpi-avg">--</div><div class="kpi-lbl">M√©dia (14d)</div></div>
                <div class="kpi-box"><div class="kpi-val" id="kpi-records">--</div><div class="kpi-lbl">Registros</div></div>
            </div>
        </div>

        <!-- 1. Volume Total -->
        <div class="card">
            <div class="card-header">
                <span>üìä Volume Di√°rio (ml)</span>
                <div class="filter-group">
                    <button class="btn-filter" onclick="updateFilter('total', 14, this)">14D</button>
                    <button class="btn-filter" onclick="updateFilter('total', 30, this)">30D</button>
                    <button class="btn-filter active" onclick="updateFilter('total', 999, this)">Tudo</button>
                </div>
            </div>
            <div class="chart-container"><canvas id="cTotal"></canvas></div>
        </div>

        <!-- 2a. M√©dia por Mamada -->
        <div class="card">
            <div class="card-header">
                <span>üìà M√©dia por Mamada (ml)</span>
                <div class="filter-group">
                    <button class="btn-filter" onclick="updateFilter('avgOnly', 14, this)">14D</button>
                    <button class="btn-filter" onclick="updateFilter('avgOnly', 30, this)">30D</button>
                    <button class="btn-filter active" onclick="updateFilter('avgOnly', 999, this)">Tudo</button>
                </div>
            </div>
            <div class="chart-container"><canvas id="cAvgOnly"></canvas></div>
        </div>

        <!-- 2b. Quantidade de Mamadas -->
        <div class="card">
            <div class="card-header">
                <span>üî¢ Qtd de Mamadas no Dia</span>
                <div class="filter-group">
                    <button class="btn-filter" onclick="updateFilter('countOnly', 14, this)">14D</button>
                    <button class="btn-filter" onclick="updateFilter('countOnly', 30, this)">30D</button>
                    <button class="btn-filter active" onclick="updateFilter('countOnly', 999, this)">Tudo</button>
                </div>
            </div>
            <div class="chart-container"><canvas id="cCountOnly"></canvas></div>
        </div>

        <!-- 3. Dispers√£o Di√°ria (Alinhada) -->
        <div class="card">
            <div class="card-header">
                <span>üìç Distribui√ß√£o por Dia</span>
                <div class="filter-group">
                    <button class="btn-filter" onclick="updateFilter('scatter', 14, this)">14D</button>
                    <button class="btn-filter" onclick="updateFilter('scatter', 30, this)">30D</button>
                    <button class="btn-filter active" onclick="updateFilter('scatter', 999, this)">Tudo</button>
                </div>
            </div>
            <div class="chart-container"><canvas id="cScatterDay"></canvas></div>
        </div>

        <!-- 4. Histograma -->
        <div class="card">
            <div class="card-header">
                <span>üîî Frequ√™ncia de Volume</span>
                <div class="filter-group">
                    <button class="btn-filter" onclick="updateFilter('hist', 14, this)">14D</button>
                    <button class="btn-filter" onclick="updateFilter('hist', 30, this)">30D</button>
                    <button class="btn-filter active" onclick="updateFilter('hist', 999, this)">Tudo</button>
                </div>
            </div>
            <div class="chart-container"><canvas id="cHist"></canvas></div>
        </div>

        <!-- 5. Tend√™ncia Hor√°ria -->
        <div class="card">
            <div class="card-header">
                <span>üïê Tend√™ncia Hor√°ria (2h)</span>
                <div class="filter-group">
                    <button class="btn-filter" onclick="updateFilter('hourly', 14, this)">14D</button>
                    <button class="btn-filter" onclick="updateFilter('hourly', 30, this)">30D</button>
                    <button class="btn-filter active" onclick="updateFilter('hourly', 999, this)">Tudo</button>
                </div>
            </div>
            <div class="chart-container"><canvas id="cHourly"></canvas></div>
        </div>

        <!-- 6. Intervalo -->
        <div class="card">
            <div class="card-header">
                <span>‚è≥ Intervalo vs Volume</span>
                <div class="filter-group">
                    <button class="btn-filter" onclick="updateFilter('interval', 14, this)">14D</button>
                    <button class="btn-filter" onclick="updateFilter('interval', 30, this)">30D</button>
                    <button class="btn-filter active" onclick="updateFilter('interval', 999, this)">Tudo</button>
                </div>
            </div>
            <div class="chart-container"><canvas id="cInterval"></canvas></div>
        </div>
    </div>

    <script>
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuNhMpD8np684lVzD9NYKUlKfPkTdYyTVh7mYn2h-Oq-xIGa_QDcSeG-1o7Dw-Zq6EpigKjuKcUVri/pub?gid=0&single=true&output=csv';

        let processedData = [];
        let dailyMap = {};
        let lastDataDate;

        Papa.parse(SHEET_URL, {
            download: true,
            header: true,
            complete: function(results) {
                processAndRender(results.data);
            },
            error: function(err) {
                document.getElementById('loading').innerHTML = "‚ùå Erro ao carregar dados.<br>Verifique a conex√£o.";
                console.error(err);
            }
        });

        function processAndRender(csvData) {
            processedData = csvData
                .filter(row => row.Data && row.Hora && row['Volume (ml)'])
                .map(row => {
                    let dStr = row.Data;
                    if(dStr.includes('/')) {
                        const parts = dStr.split('/');
                        dStr = `${parts[2]}-${parts[1]}-${parts[0]}`;
                    }
                    return {
                        d: dStr, 
                        t: row.Hora, 
                        v: parseInt(row['Volume (ml)'])
                    };
                });

            processedData = processedData
                .map(r => ({ ...r, dateObj: new Date(r.d + "T" + r.t), dayStr: r.d.split('-').reverse().slice(0,2).join('/') }))
                .sort((a,b) => a.dateObj - b.dateObj);

            if (processedData.length > 0) {
                lastDataDate = processedData[processedData.length-1].dateObj;
                document.getElementById('last-update').innerText = "Dados at√©: " + processedData[processedData.length-1].d.split('-').reverse().join('/');
            }
            
            dailyMap = {};
            processedData.forEach(r => {
                if(!dailyMap[r.d]) dailyMap[r.d] = { vol:0, count:0 };
                dailyMap[r.d].vol += r.v;
                dailyMap[r.d].count++;
            });

            for(let i=1; i<processedData.length; i++) {
                const diffMs = processedData[i].dateObj - processedData[i-1].dateObj;
                processedData[i].intervalHours = (diffMs / 60000) / 60;
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            initCharts();
        }

        function getFilteredData(daysLimit) {
            if (daysLimit > 100) return processedData;
            const limitTime = new Date(lastDataDate);
            limitTime.setDate(limitTime.getDate() - daysLimit);
            limitTime.setHours(0,0,0,0);
            return processedData.filter(d => d.dateObj >= limitTime);
        }

        function calculateMovingAverage(data, windowSize) {
            let result = [];
            for (let i = 0; i < data.length; i++) {
                let start = Math.max(0, i - windowSize + 1);
                let subset = data.slice(start, i + 1);
                let sum = subset.reduce((a, b) => a + b, 0);
                result.push(Math.round(sum / subset.length));
            }
            return result;
        }

        function calculatePeriodDailyAvg(data) {
            const dMap = {};
            data.forEach(r => {
                if(!dMap[r.d]) dMap[r.d] = 0;
                dMap[r.d] += r.v;
            });
            const days = Object.keys(dMap).length;
            const total = Object.values(dMap).reduce((a,b) => a+b, 0);
            return days ? (total/days) : 0;
        }

        let chartTotal, chartAvgOnly, chartCountOnly, chartScatter, chartHist, chartHourly, chartInterval;

        function initCharts() {
            const lastDataObj = processedData[processedData.length-1];
            const lastDataDateStr = lastDataObj.d;
            const now = new Date();
            const last = new Date(lastDataDateStr + "T12:00:00");
            const isSameDay = (now.getDate() === last.getDate() && now.getMonth() === last.getMonth());

            document.getElementById('kpi-vol').innerText = dailyMap[lastDataDateStr].vol + " ml";
            const kpiLabel = document.getElementById('lbl-vol');
            if(isSameDay) {
                kpiLabel.innerText = "Vol. Hoje (Parcial)";
                kpiLabel.style.color = "#2563eb";
            } else {
                kpiLabel.innerText = "Vol. Ontem (Fechado)";
                kpiLabel.style.color = "#9ca3af";
            }

            const avg14d = Math.round(calculatePeriodDailyAvg(getFilteredData(14)));
            document.getElementById('kpi-avg').innerText = avg14d + " ml";
            document.getElementById('kpi-records').innerText = processedData.length;

            renderTotal(999);
            renderAvgOnly(999);
            renderCountOnly(999);
            renderScatter(999);
            renderHist(999);
            renderHourly(999);
            renderInterval(999);
        }

        function renderTotal(limit) {
            const data = getFilteredData(limit);
            const dMap = {};
            data.forEach(r => {
                if(!dMap[r.d]) dMap[r.d] = 0;
                dMap[r.d] += r.v;
            });
            const keys = Object.keys(dMap).sort();
            const labels = keys.map(k => k.split('-').reverse().slice(0,2).join('/'));
            const values = keys.map(k => dMap[k]);
            const movingAvg = calculateMovingAverage(values, 5);

            if(chartTotal) chartTotal.destroy();
            chartTotal = new Chart(document.getElementById('cTotal'), {
                type: 'bar',
                data: { 
                    labels: labels, 
                    datasets: [
                        { label: 'Total', data: values, backgroundColor: '#3b82f6', borderRadius: 4, order: 2 },
                        { label: 'Tend√™ncia (5d)', data: movingAvg, borderColor: '#ef4444', borderWidth: 2, type: 'line', pointRadius: 0, tension: 0.3, order: 1 }
                    ] 
                },
                options: { maintainAspectRatio: false, plugins: {legend:{display:false}}, scales: { x: {grid:{display:false}} } }
            });
        }

        function renderAvgOnly(limit) {
            const data = getFilteredData(limit);
            const dMap = {};
            data.forEach(r => {
                if(!dMap[r.d]) dMap[r.d] = {vol:0, count:0};
                dMap[r.d].vol += r.v;
                dMap[r.d].count++;
            });
            const keys = Object.keys(dMap).sort();
            const labels = keys.map(k => k.split('-').reverse().slice(0,2).join('/'));
            const avgs = keys.map(k => Math.round(dMap[k].vol / dMap[k].count));
            const movingAvg = calculateMovingAverage(avgs, 5);

            if(chartAvgOnly) chartAvgOnly.destroy();
            chartAvgOnly = new Chart(document.getElementById('cAvgOnly'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'M√©dia (ml)', data: avgs, backgroundColor: '#10b981', borderRadius: 4, order: 2 },
                        { label: 'Tend√™ncia (5d)', data: movingAvg, borderColor: '#ef4444', borderWidth: 2, type: 'line', pointRadius: 0, tension: 0.3, order: 1 }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: { x: {grid:{display:false}}, y: { title: {display:true, text:'M√©dia ml'} } },
                    plugins: { legend: {display: false} }
                }
            });
        }

        function renderCountOnly(limit) {
            const data = getFilteredData(limit);
            const dMap = {};
            data.forEach(r => {
                if(!dMap[r.d]) dMap[r.d] = 0;
                dMap[r.d]++;
            });
            const keys = Object.keys(dMap).sort();
            const labels = keys.map(k => k.split('-').reverse().slice(0,2).join('/'));
            const values = keys.map(k => dMap[k]);

            if(chartCountOnly) chartCountOnly.destroy();
            chartCountOnly = new Chart(document.getElementById('cCountOnly'), {
                type: 'line',
                data: { 
                    labels: labels, 
                    datasets: [{ label: 'Qtd Mamadas', data: values, borderColor: '#f59e0b', backgroundColor: '#f59e0b', tension: 0.3, fill: false, pointRadius: 3 }] 
                },
                options: { maintainAspectRatio: false, plugins: {legend:{display:false}}, scales: { x: {grid:{display:false}}, y: {beginAtZero: true, ticks: {stepSize: 1}} } }
            });
        }

        function renderScatter(limit) {
            const data = getFilteredData(limit);
            const keys = [...new Set(data.map(d => d.d))].sort();
            const labels = keys.map(k => k.split('-').reverse().slice(0,2).join('/'));

            if(chartScatter) chartScatter.destroy();
            chartScatter = new Chart(document.getElementById('cScatterDay'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Mamada',
                        data: data.map(d => ({ x: d.dayStr, y: d.v })),
                        backgroundColor: 'rgba(37, 99, 235, 0.6)',
                        borderColor: '#2563eb',
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'category', labels: labels, grid:{display:false} },
                        y: { title: {display:true, text:'Volume (ml)'} }
                    },
                    plugins: { legend: {display:false} }
                }
            });
        }

        function renderHist(limit) {
            const data = getFilteredData(limit);
            const bins = {};
            data.forEach(r => {
                const binFloor = Math.floor(r.v / 20) * 20;
                const label = `${binFloor}-${binFloor+20}`;
                bins[label] = (bins[label] || 0) + 1;
            });
            const sortedKeys = Object.keys(bins).sort((a,b) => parseInt(a) - parseInt(b));
            
            if(chartHist) chartHist.destroy();
            chartHist = new Chart(document.getElementById('cHist'), {
                type: 'bar',
                data: {
                    labels: sortedKeys,
                    datasets: [{ label: 'Frequ√™ncia', data: sortedKeys.map(k => bins[k]), backgroundColor: '#8b5cf6', borderRadius: 4 }]
                },
                options: { maintainAspectRatio: false, plugins: {legend:{display:false}}, scales: {x:{grid:{display:false}}, y:{beginAtZero:true}} }
            });
        }

        function renderHourly(limit) {
            const data = getFilteredData(limit);
            const bins = {};
            for(let i=0; i<24; i+=2) bins[`${i}h-${i+2}h`] = [];

            data.forEach(r => {
                const h = r.dateObj.getHours();
                const binFloor = Math.floor(h / 2) * 2;
                bins[`${binFloor}h-${binFloor+2}h`].push(r.v);
            });

            const labels = Object.keys(bins);
            const avgs = labels.map(k => {
                const vols = bins[k];
                return vols.length === 0 ? 0 : Math.round(vols.reduce((a,b)=>a+b,0) / vols.length);
            });

            const scatterPts = data.map(r => ({
                x: r.dateObj.getHours() + (r.dateObj.getMinutes()/60),
                y: r.v
            }));

            if(chartHourly) chartHourly.destroy();
            chartHourly = new Chart(document.getElementById('cHourly'), {
                type: 'scatter',
                data: {
                    datasets: [
                        { type: 'line', label: 'M√©dia', data: avgs.map((v, i) => ({x: i*2 + 1, y: v})), borderColor: '#ec4899', borderWidth: 3, pointRadius: 0, tension: 0.4 },
                        { label: 'Mamada', data: scatterPts, backgroundColor: 'rgba(156, 163, 175, 0.4)', pointRadius: 3 }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', min: 0, max: 24, title: {display:true, text:'Hora do Dia'}, ticks: {stepSize: 2} },
                        y: { title: {display:true, text:'Volume'} }
                    }
                }
            });
        }

        function renderInterval(limit) {
            const data = getFilteredData(limit).filter(r => r.intervalHours);
            const periodDailyAvg = calculatePeriodDailyAvg(data);

            if(chartInterval) chartInterval.destroy();
            chartInterval = new Chart(document.getElementById('cInterval'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Mamada',
                        data: data.map(r => ({ x: r.intervalHours, y: r.v, dateRef: r.d })),
                        backgroundColor: function(context) {
                            if(!context.raw) return '#999';
                            const dayKey = context.raw.dateRef;
                            const dayTotal = dailyMap[dayKey].vol;
                            return dayTotal >= periodDailyAvg ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)';
                        },
                        pointRadius: 6
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', title: {display:true, text:'Intervalo (Horas)'}, ticks: {stepSize: 0.5} },
                        y: { title: {display:true, text:'Volume (ml)'} }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    const dayKey = ctx.raw.dateRef;
                                    const status = dailyMap[dayKey].vol >= periodDailyAvg ? 'Dia Bom' : 'Dia Ruim';
                                    return `${ctx.raw.y}ml (${status})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        window.updateFilter = function(chartName, days, btn) {
            const parent = btn.parentNode;
            parent.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(chartName === 'total') renderTotal(days);
            if(chartName === 'avgOnly') renderAvgOnly(days);
            if(chartName === 'countOnly') renderCountOnly(days);
            if(chartName === 'scatter') renderScatter(days);
            if(chartName === 'hist') renderHist(days);
            if(chartName === 'hourly') renderHourly(days);
            if(chartName === 'interval') renderInterval(days);
        };

    </script>
</body>
</html>
