<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ A√ß√µes Argos</title>
    <meta name="version" content="v1.0.0">
    <style>
        :root {
            --bg: #f7fafc;
            --text: #2d3748;
            --surface: #ffffff;
            --card-bg: var(--surface);
            --border: #e2e8f0;
            --text-muted: #718096;
            --subtext: var(--text-muted);
            --primary: #667eea;
            --primary-dark: #5568d3;
            --accent: var(--primary);
            --accent-light: #ebf4ff;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --green: #48bb78;
            --yellow: #ed8936;
            --red: #f56565;
            --shadow: 0 1px 3px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.06);
        }
        body.dark-mode {
            --bg: #1a202c;
            --text: #f7fafc;
            --surface: #2d3748;
            --card-bg: var(--surface);
            --border: #4a5568;
            --text-muted: #cbd5e0;
            --subtext: var(--text-muted);
            --primary: #7f9cf5;
            --accent: var(--primary);
            --accent-light: #2a3a6e;
            --green: #68d391;
            --yellow: #f6ad55;
            --red: #fc8181;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s;
            padding: 10px 10px 80px 10px;
        }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        #theme-toggle {
            position: absolute; top: 12px; right: 12px;
            background: rgba(0,0,0,0.05); border: none; font-size: 1.2rem; cursor: pointer;
            padding: 8px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            z-index: 10; transition: background 0.2s;
        }
        body.dark-mode #theme-toggle { background: rgba(255,255,255,0.1); }
        .nav-link {
            text-decoration: none;
            color: var(--primary);
            font-size: 0.9rem;
            margin: 10px 0 0 4px;
            display: inline-block;
        }
        h1 {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 800;
            margin: 10px 44px 4px 44px;
            color: var(--text);
        }
        .page-subtitle {
            text-align: center;
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-bottom: 18px;
        }

        /* ‚îÄ‚îÄ KPI Cards ‚îÄ‚îÄ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 18px;
        }
        @media (max-width: 700px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 400px) { .kpi-grid { grid-template-columns: 1fr; } }
        .kpi-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 4px;
        }
        .kpi-card.kpi-red::before { background: var(--red); }
        .kpi-card.kpi-yellow::before { background: var(--yellow); }
        .kpi-card.kpi-blue::before { background: #4299e1; }
        .kpi-card.kpi-green::before { background: var(--green); }
        .kpi-icon { font-size: 1.5rem; margin-bottom: 6px; }
        .kpi-value { font-size: 2rem; font-weight: 800; line-height: 1; }
        .kpi-card.kpi-red .kpi-value { color: var(--red); }
        .kpi-card.kpi-yellow .kpi-value { color: var(--yellow); }
        .kpi-card.kpi-blue .kpi-value { color: #4299e1; }
        .kpi-card.kpi-green .kpi-value { color: var(--green); }
        .kpi-label { font-size: 0.72rem; color: var(--text-muted); margin-top: 4px; font-weight: 600; text-transform: uppercase; }

        /* ‚îÄ‚îÄ Filter Bar ‚îÄ‚îÄ */
        .filter-bar {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 14px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .filter-label { font-size: 0.75rem; font-weight: 700; color: var(--subtext); text-transform: uppercase; }
        .filter-bar select {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 5px 10px;
            font-size: 0.82rem;
            color: var(--text);
            cursor: pointer;
        }
        .btn-nova {
            margin-left: auto;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 7px 16px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-nova:hover { background: var(--primary-dark); }

        /* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
        .table-wrap {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        thead th {
            padding: 10px 12px;
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            text-align: left;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        thead th:hover { color: var(--primary); }
        thead th .sort-icon { margin-left: 4px; opacity: 0.4; }
        thead th.sorted .sort-icon { opacity: 1; color: var(--primary); }
        tbody tr {
            border-bottom: 1px solid var(--border);
            transition: background 0.15s;
            cursor: pointer;
        }
        tbody tr:last-child { border-bottom: none; }
        tbody tr:hover { background: var(--accent-light); }
        td { padding: 9px 12px; font-size: 0.85rem; vertical-align: middle; }

        /* Editable cells */
        .editable {
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 3px 6px;
            min-width: 80px;
            outline: none;
            background: transparent;
            color: var(--text);
            font-size: 0.85rem;
            font-family: inherit;
        }
        .editable:focus { border-color: var(--primary); background: var(--accent-light); }

        /* Inline select */
        .inline-select {
            background: transparent;
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 3px 6px;
            font-size: 0.82rem;
            color: var(--text);
            cursor: pointer;
        }
        .inline-select:focus { border-color: var(--primary); background: var(--card-bg); outline: none; }

        /* Status badge */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .badge-pendente { background: #fef3c7; color: #92400e; }
        .badge-andamento { background: #dbeafe; color: #1e40af; }
        .badge-concluida { background: #d1fae5; color: #065f46; }
        .badge-cancelada { background: #f3f4f6; color: #6b7280; }
        body.dark-mode .badge-pendente { background: #78350f; color: #fef3c7; }
        body.dark-mode .badge-andamento { background: #1e3a8a; color: #dbeafe; }
        body.dark-mode .badge-concluida { background: #064e3b; color: #d1fae5; }
        body.dark-mode .badge-cancelada { background: #374151; color: #d1d5db; }

        /* Priority toggle */
        .prio-btn {
            background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 2px;
        }

        /* Progress bar */
        .progress-wrap { display: flex; align-items: center; gap: 6px; }
        .progress-bar {
            height: 8px; border-radius: 4px; background: var(--border);
            flex: 1; min-width: 50px; overflow: hidden;
        }
        .progress-fill { height: 100%; border-radius: 4px; background: var(--green); transition: width 0.3s; }
        .progress-text { font-size: 0.72rem; color: var(--text-muted); white-space: nowrap; }

        /* Origem tag */
        .origem-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--border);
            color: var(--text-muted);
        }
        .origem-reuniao { background: #ede9fe; color: #5b21b6; }
        .origem-manual { background: #e0f2fe; color: #0369a1; }
        .origem-argosbot { background: #fef9c3; color: #854d0e; }
        body.dark-mode .origem-reuniao { background: #3b1f7a; color: #ede9fe; }
        body.dark-mode .origem-manual { background: #0c4a6e; color: #e0f2fe; }
        body.dark-mode .origem-argosbot { background: #713f12; color: #fef9c3; }

        /* Concluir btn */
        .btn-concluir {
            background: none;
            border: 1px solid var(--green);
            color: var(--green);
            border-radius: 6px;
            padding: 3px 8px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-concluir:hover { background: var(--green); color: #fff; }
        .btn-concluir:disabled { opacity: 0.4; cursor: default; }

        /* ‚îÄ‚îÄ Side Panel ‚îÄ‚îÄ */
        .overlay {
            display: none;
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 100;
        }
        .overlay.open { display: block; }
        .side-panel {
            position: fixed; top: 0; right: -480px; bottom: 0;
            width: 460px; max-width: 96vw;
            background: var(--card-bg);
            border-left: 1px solid var(--border);
            z-index: 101;
            display: flex; flex-direction: column;
            transition: right 0.3s ease;
            box-shadow: -4px 0 24px rgba(0,0,0,0.15);
        }
        .side-panel.open { right: 0; }
        .panel-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .panel-title { font-size: 1rem; font-weight: 700; }
        .btn-close-panel {
            background: none; border: none; font-size: 1.4rem; cursor: pointer;
            color: var(--text-muted); line-height: 1;
        }
        .panel-body { flex: 1; overflow-y: auto; padding: 16px 18px; }
        .panel-section-title {
            font-size: 0.72rem; font-weight: 700; text-transform: uppercase;
            color: var(--text-muted); margin: 14px 0 8px;
        }
        .panel-section-title:first-child { margin-top: 0; }

        /* Checklist items */
        .checklist-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 8px;
        }
        .checklist-item-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 6px; }
        .checklist-item-row:last-child { margin-bottom: 0; }
        .chk-done { width: 16px; height: 16px; cursor: pointer; accent-color: var(--primary); flex-shrink: 0; }
        .chk-desc {
            flex: 1; min-width: 100px;
            border: none; background: transparent;
            color: var(--text); font-size: 0.85rem; font-family: inherit;
            outline: none; border-bottom: 1px solid transparent;
        }
        .chk-desc:focus { border-bottom-color: var(--primary); }
        .chk-desc.done-text { text-decoration: line-through; color: var(--text-muted); }
        .chk-meta { display: flex; gap: 8px; flex-wrap: wrap; margin-left: 24px; }
        .chk-input-sm {
            border: 1px solid var(--border); border-radius: 6px;
            padding: 3px 7px; font-size: 0.78rem;
            background: var(--card-bg); color: var(--text);
            outline: none;
        }
        .chk-input-sm:focus { border-color: var(--primary); }
        .btn-del-chk {
            background: none; border: none; cursor: pointer; color: var(--red); font-size: 1rem;
            padding: 2px 4px; opacity: 0.6;
        }
        .btn-del-chk:hover { opacity: 1; }
        .btn-add-sub {
            background: none; border: 1px dashed var(--border); border-radius: 8px;
            padding: 8px; width: 100%; text-align: center;
            color: var(--primary); font-size: 0.82rem; cursor: pointer;
            transition: all 0.2s;
        }
        .btn-add-sub:hover { border-color: var(--primary); background: var(--accent-light); }

        /* Notes */
        .notes-area {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 0.85rem;
            color: var(--text);
            background: var(--bg);
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }
        .notes-area:focus { outline: none; border-color: var(--primary); }

        /* Panel footer */
        .panel-footer {
            padding: 14px 18px;
            border-top: 1px solid var(--border);
            display: flex; gap: 10px; justify-content: flex-end;
        }
        .btn-save {
            background: var(--primary); color: #fff;
            border: none; border-radius: 8px;
            padding: 8px 20px; font-weight: 700; font-size: 0.85rem;
            cursor: pointer; transition: background 0.2s;
        }
        .btn-save:hover { background: var(--primary-dark); }
        .btn-cancel {
            background: var(--border); color: var(--text);
            border: none; border-radius: 8px;
            padding: 8px 16px; font-size: 0.85rem;
            cursor: pointer;
        }

        /* ‚îÄ‚îÄ Modal (Nova A√ß√£o) ‚îÄ‚îÄ */
        .modal-overlay {
            display: none;
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 24px;
            width: 480px; max-width: 94vw;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25);
        }
        .modal h2 { font-size: 1.1rem; font-weight: 800; margin-bottom: 16px; }
        .form-row { margin-bottom: 12px; }
        .form-row label { display: block; font-size: 0.76rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; }
        .form-row input, .form-row select, .form-row textarea {
            width: 100%; padding: 8px 10px;
            border: 1px solid var(--border); border-radius: 8px;
            background: var(--bg); color: var(--text);
            font-size: 0.85rem; font-family: inherit;
        }
        .form-row input:focus, .form-row select:focus { outline: none; border-color: var(--primary); }
        .form-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 16px; }

        /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
        .site-footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .site-footer a { color: var(--primary); text-decoration: none; }

        /* Toast */
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(60px);
            background: #2d3748; color: #fff;
            padding: 10px 20px; border-radius: 8px;
            font-size: 0.85rem; font-weight: 600;
            z-index: 999; transition: transform 0.3s;
            pointer-events: none;
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        /* Empty row */
        .empty-row td { text-align: center; padding: 30px; color: var(--text-muted); font-size: 0.9rem; }
    </style>
</head>
<body>
    <button id="theme-toggle" title="Alternar tema">üåô</button>
    <a class="nav-link" href="index.html">‚Üê Hub</a>

    <h1>‚úÖ A√ß√µes Argos</h1>
    <p class="page-subtitle" id="last-update">Carregando‚Ä¶</p>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card kpi-red">
            <div class="kpi-icon">üî¥</div>
            <div class="kpi-value" id="kpi-atrasadas">0</div>
            <div class="kpi-label">Atrasadas</div>
        </div>
        <div class="kpi-card kpi-yellow">
            <div class="kpi-icon">üü°</div>
            <div class="kpi-value" id="kpi-vence7">0</div>
            <div class="kpi-label">Vence em 7 dias</div>
        </div>
        <div class="kpi-card kpi-blue">
            <div class="kpi-icon">üîµ</div>
            <div class="kpi-value" id="kpi-andamento">0</div>
            <div class="kpi-label">Em Andamento</div>
        </div>
        <div class="kpi-card kpi-green">
            <div class="kpi-icon">üü¢</div>
            <div class="kpi-value" id="kpi-concluidas">0</div>
            <div class="kpi-label">Conclu√≠das (m√™s)</div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <span class="filter-label">Filtrar:</span>
        <select id="filter-status" onchange="renderTable()">
            <option value="">Todos os status</option>
            <option>Pendente</option>
            <option>Em Andamento</option>
            <option>Conclu√≠da</option>
            <option>Cancelada</option>
        </select>
        <select id="filter-imovel" onchange="renderTable()">
            <option value="">Todos os im√≥veis</option>
            <option>Copacabana</option>
            <option>Teres√≥polis</option>
            <option>Outro</option>
        </select>
        <select id="filter-prioridade" onchange="renderTable()">
            <option value="">Todas as prioridades</option>
            <option value="alta">üî¥ Alta</option>
            <option value="media">üü° M√©dia</option>
            <option value="baixa">üü¢ Baixa</option>
        </select>
        <button class="btn-nova" onclick="openModal()">+ Nova A√ß√£o</button>
    </div>

    <!-- Table -->
    <div class="table-wrap">
        <table>
            <thead>
                <tr>
                    <th onclick="sortBy('id')"># <span class="sort-icon">‚Üï</span></th>
                    <th onclick="sortBy('titulo')">T√≠tulo <span class="sort-icon">‚Üï</span></th>
                    <th onclick="sortBy('imovel')">Im√≥vel <span class="sort-icon">‚Üï</span></th>
                    <th onclick="sortBy('responsavel')">Respons√°vel <span class="sort-icon">‚Üï</span></th>
                    <th onclick="sortBy('prazo')">Prazo <span class="sort-icon">‚Üï</span></th>
                    <th onclick="sortBy('status')">Status <span class="sort-icon">‚Üï</span></th>
                    <th onclick="sortBy('prioridade')">Prior. <span class="sort-icon">‚Üï</span></th>
                    <th>Progresso</th>
                    <th onclick="sortBy('origem')">Origem <span class="sort-icon">‚Üï</span></th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <!-- Side Panel Overlay -->
    <div class="overlay" id="overlay" onclick="closePanel()"></div>

    <!-- Side Panel -->
    <div class="side-panel" id="side-panel">
        <div class="panel-header">
            <span class="panel-title" id="panel-title">Detalhes da A√ß√£o</span>
            <button class="btn-close-panel" onclick="closePanel()">√ó</button>
        </div>
        <div class="panel-body" id="panel-body">
            <!-- Dinamicamente preenchido -->
        </div>
        <div class="panel-footer">
            <button class="btn-cancel" onclick="closePanel()">Fechar</button>
            <button class="btn-save" onclick="savePanel()">üíæ Salvar</button>
        </div>
    </div>

    <!-- Modal Nova A√ß√£o -->
    <div class="modal-overlay" id="modal-overlay" onclick="handleModalOverlayClick(event)">
        <div class="modal">
            <h2>‚ûï Nova A√ß√£o</h2>
            <div class="form-row">
                <label>T√≠tulo *</label>
                <input id="m-titulo" type="text" placeholder="Descri√ß√£o da a√ß√£o">
            </div>
            <div class="form-row-2">
                <div class="form-row">
                    <label>Im√≥vel</label>
                    <select id="m-imovel">
                        <option>Copacabana</option>
                        <option>Teres√≥polis</option>
                        <option>Outro</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Respons√°vel</label>
                    <input id="m-responsavel" type="text" placeholder="Nome">
                </div>
            </div>
            <div class="form-row-2">
                <div class="form-row">
                    <label>Prazo</label>
                    <input id="m-prazo" type="date">
                </div>
                <div class="form-row">
                    <label>Prioridade</label>
                    <select id="m-prioridade">
                        <option value="alta">üî¥ Alta</option>
                        <option value="media">üü° M√©dia</option>
                        <option value="baixa">üü¢ Baixa</option>
                    </select>
                </div>
            </div>
            <div class="form-row-2">
                <div class="form-row">
                    <label>Status</label>
                    <select id="m-status">
                        <option>Pendente</option>
                        <option>Em Andamento</option>
                        <option>Conclu√≠da</option>
                        <option>Cancelada</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Origem</label>
                    <select id="m-origem">
                        <option>Manual</option>
                        <option>Reuni√£o</option>
                        <option>ArgosBot</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
                <button class="btn-save" onclick="createAcao()">Criar A√ß√£o</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <div class="site-footer">
        <a href="https://moliveirauff.github.io/familia-donato-suarez/" target="_blank">üè† Family Hub</a>
        &nbsp;¬∑&nbsp; Argos A√ß√µes v1.0
    </div>

    <script>
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // DATA
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const STORAGE_KEY = 'argos_acoes_v1';
    let acoes = [];
    let sortCol = 'prazo';
    let sortDir = 1;
    let activePanelId = null;

    const PRIORIDADE_MAP = { alta: 'üî¥', media: 'üü°', baixa: 'üü¢' };
    const PRIORIDADE_ORDER = ['alta', 'media', 'baixa'];
    const STATUS_BADGE = {
        'Pendente': 'badge-pendente',
        'Em Andamento': 'badge-andamento',
        'Conclu√≠da': 'badge-concluida',
        'Cancelada': 'badge-cancelada'
    };
    const ORIGEM_CLASS = {
        'Reuni√£o': 'origem-reuniao',
        'Manual': 'origem-manual',
        'ArgosBot': 'origem-argosbot'
    };

    // Load data
    async function loadData() {
        // Try localStorage first
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try { acoes = JSON.parse(saved); } catch(e) { acoes = []; }
        }
        // Try to load from JSON (works when served via HTTP)
        try {
            const res = await fetch('data/acoes.json?t=' + Date.now());
            if (res.ok) {
                const json = await res.json();
                // Merge: prefer localStorage version if newer (has more items)
                if (!saved || json.length > acoes.length) {
                    acoes = json;
                    persist();
                }
            }
        } catch(e) { /* offline or file:// */ }
        if (!acoes.length) acoes = getDefaultData();
        updateKPIs();
        renderTable();
        document.getElementById('last-update').textContent =
            'Atualizado em ' + new Date().toLocaleString('pt-BR');
    }

    function getDefaultData() {
        return [{
            id: 1,
            titulo: 'Exemplo de A√ß√£o',
            imovel: 'Copacabana',
            responsavel: 'Mauricio',
            prazo: '2026-02-28',
            status: 'Pendente',
            prioridade: 'alta',
            origem: 'Manual',
            notas: '',
            checklist: [{
                id: 1,
                descricao: 'Sub-tarefa exemplo',
                responsavel: 'Mauricio',
                prazo: '2026-02-25',
                status: 'Pendente'
            }]
        }];
    }

    function persist() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(acoes));
    }

    function nextId() {
        return acoes.length ? Math.max(...acoes.map(a => a.id)) + 1 : 1;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // KPIs
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateKPIs() {
        const today = new Date(); today.setHours(0,0,0,0);
        const in7 = new Date(today); in7.setDate(in7.getDate() + 7);
        const openStatuses = ['Pendente', 'Em Andamento'];
        const thisMonth = today.getMonth();
        const thisYear = today.getFullYear();

        let atrasadas = 0, vence7 = 0, andamento = 0, concluidas = 0;
        acoes.forEach(a => {
            const prazo = a.prazo ? new Date(a.prazo + 'T00:00:00') : null;
            if (prazo && openStatuses.includes(a.status) && prazo < today) atrasadas++;
            if (prazo && openStatuses.includes(a.status) && prazo >= today && prazo <= in7) vence7++;
            if (a.status === 'Em Andamento') andamento++;
            if (a.status === 'Conclu√≠da') {
                const prazoDt = prazo || new Date();
                if (prazoDt.getMonth() === thisMonth && prazoDt.getFullYear() === thisYear) concluidas++;
            }
        });
        document.getElementById('kpi-atrasadas').textContent = atrasadas;
        document.getElementById('kpi-vence7').textContent = vence7;
        document.getElementById('kpi-andamento').textContent = andamento;
        document.getElementById('kpi-concluidas').textContent = concluidas;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // TABLE
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function sortBy(col) {
        if (sortCol === col) sortDir *= -1;
        else { sortCol = col; sortDir = 1; }
        renderTable();
    }

    function getFiltered() {
        const fs = document.getElementById('filter-status').value;
        const fi = document.getElementById('filter-imovel').value;
        const fp = document.getElementById('filter-prioridade').value;
        return acoes.filter(a =>
            (!fs || a.status === fs) &&
            (!fi || a.imovel === fi) &&
            (!fp || a.prioridade === fp)
        );
    }

    function getProgress(a) {
        if (!a.checklist || !a.checklist.length) return { done: 0, total: 0 };
        const done = a.checklist.filter(c => c.status === 'Conclu√≠da').length;
        return { done, total: a.checklist.length };
    }

    function renderTable() {
        const today = new Date(); today.setHours(0,0,0,0);
        const data = getFiltered().sort((a, b) => {
            let va = a[sortCol] || '', vb = b[sortCol] || '';
            if (sortCol === 'prioridade') { va = PRIORIDADE_ORDER.indexOf(va); vb = PRIORIDADE_ORDER.indexOf(vb); }
            if (va < vb) return -sortDir;
            if (va > vb) return sortDir;
            return 0;
        });

        // Update sort icons
        document.querySelectorAll('thead th').forEach(th => th.classList.remove('sorted'));

        const tbody = document.getElementById('table-body');
        if (!data.length) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="10">Nenhuma a√ß√£o encontrada. Clique em "+ Nova A√ß√£o".</td></tr>';
            return;
        }

        tbody.innerHTML = data.map((a, i) => {
            const prazo = a.prazo ? new Date(a.prazo + 'T00:00:00') : null;
            const atrasada = prazo && prazo < today && !['Conclu√≠da','Cancelada'].includes(a.status);
            const prog = getProgress(a);
            const pct = prog.total ? Math.round(prog.done / prog.total * 100) : 0;
            const statusBadge = STATUS_BADGE[a.status] || 'badge-pendente';
            const origemClass = ORIGEM_CLASS[a.origem] || '';
            const prioEmoji = PRIORIDADE_MAP[a.prioridade] || 'üü°';
            const nextPrio = PRIORIDADE_ORDER[(PRIORIDADE_ORDER.indexOf(a.prioridade) + 1) % 3];
            const concluirDisabled = ['Conclu√≠da','Cancelada'].includes(a.status) ? 'disabled' : '';

            return `<tr data-id="${a.id}" onclick="openPanel(${a.id}, event)">
                <td style="color:var(--text-muted);font-size:0.75rem;">${i+1}</td>
                <td>
                  <input class="editable" value="${esc(a.titulo)}"
                    onclick="event.stopPropagation()"
                    onchange="updateField(${a.id},'titulo',this.value)"
                    style="${atrasada ? 'color:var(--red);' : ''}">
                </td>
                <td>
                  <select class="inline-select" onclick="event.stopPropagation()"
                    onchange="updateField(${a.id},'imovel',this.value)">
                    ${['Copacabana','Teres√≥polis','Outro'].map(o =>
                        `<option${a.imovel===o?' selected':''}>${o}</option>`).join('')}
                  </select>
                </td>
                <td>
                  <input class="editable" value="${esc(a.responsavel)}"
                    onclick="event.stopPropagation()"
                    onchange="updateField(${a.id},'responsavel',this.value)">
                </td>
                <td>
                  <input type="date" class="editable" value="${a.prazo||''}"
                    onclick="event.stopPropagation()"
                    onchange="updateField(${a.id},'prazo',this.value)"
                    style="${atrasada ? 'color:var(--red);font-weight:700;' : ''}">
                </td>
                <td onclick="event.stopPropagation()">
                  <select class="inline-select" onchange="updateField(${a.id},'status',this.value);renderTable();updateKPIs()">
                    ${['Pendente','Em Andamento','Conclu√≠da','Cancelada'].map(s =>
                        `<option${a.status===s?' selected':''}>${s}</option>`).join('')}
                  </select>
                  <span class="badge ${statusBadge}" style="margin-left:4px;">${a.status}</span>
                </td>
                <td>
                  <button class="prio-btn" title="Alternar prioridade"
                    onclick="event.stopPropagation();updateField(${a.id},'prioridade','${nextPrio}');renderTable()">
                    ${prioEmoji}
                  </button>
                </td>
                <td>
                  <div class="progress-wrap">
                    <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
                    <span class="progress-text">${prog.done}/${prog.total} ‚úÖ</span>
                  </div>
                </td>
                <td><span class="origem-tag ${origemClass}">${a.origem}</span></td>
                <td onclick="event.stopPropagation()">
                  <button class="btn-concluir" ${concluirDisabled}
                    onclick="concluirAcao(${a.id})">‚úî Concluir</button>
                </td>
            </tr>`;
        }).join('');
    }

    function esc(str) {
        return (str || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
    }

    function updateField(id, field, value) {
        const a = acoes.find(x => x.id === id);
        if (!a) return;
        a[field] = value;
        persist();
        updateKPIs();
    }

    function concluirAcao(id) {
        updateField(id, 'status', 'Conclu√≠da');
        renderTable();
        updateKPIs();
        showToast('‚úÖ A√ß√£o conclu√≠da!');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // SIDE PANEL
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openPanel(id, event) {
        // Don't open if clicking on editable elements
        if (event && event.target.tagName.match(/INPUT|SELECT|BUTTON/)) return;
        activePanelId = id;
        const a = acoes.find(x => x.id === id);
        if (!a) return;

        document.getElementById('panel-title').textContent = a.titulo || 'Detalhes';
        document.getElementById('panel-body').innerHTML = buildPanelHTML(a);
        document.getElementById('overlay').classList.add('open');
        document.getElementById('side-panel').classList.add('open');
    }

    function buildPanelHTML(a) {
        const checklist = a.checklist || [];
        const checkItems = checklist.map((c, i) => `
            <div class="checklist-item" data-chk="${i}">
                <div class="checklist-item-row">
                    <input type="checkbox" class="chk-done"
                        ${c.status==='Conclu√≠da'?'checked':''}
                        onchange="toggleChk(${i},this.checked)">
                    <input type="text" class="chk-desc ${c.status==='Conclu√≠da'?'done-text':''}"
                        value="${esc(c.descricao)}"
                        onchange="updateChk(${i},'descricao',this.value)"
                        placeholder="Descri√ß√£o">
                    <button class="btn-del-chk" onclick="deleteChk(${i})">üóë</button>
                </div>
                <div class="chk-meta">
                    <input type="text" class="chk-input-sm" placeholder="Respons√°vel"
                        value="${esc(c.responsavel||'')}"
                        onchange="updateChk(${i},'responsavel',this.value)"
                        style="width:110px;">
                    <input type="date" class="chk-input-sm"
                        value="${c.prazo||''}"
                        onchange="updateChk(${i},'prazo',this.value)">
                    <select class="chk-input-sm" onchange="updateChkStatus(${i},this.value)">
                        ${['Pendente','Em Andamento','Conclu√≠da'].map(s =>
                            `<option${c.status===s?' selected':''}>${s}</option>`).join('')}
                    </select>
                </div>
            </div>`).join('');

        return `
            <p class="panel-section-title">Checklist (${checklist.filter(c=>c.status==='Conclu√≠da').length}/${checklist.length})</p>
            <div id="checklist-items">${checkItems}</div>
            <button class="btn-add-sub" onclick="addChk()">+ Adicionar sub-tarefa</button>

            <p class="panel-section-title" style="margin-top:18px;">Notas</p>
            <textarea class="notes-area" id="panel-notas"
                onchange="updatePanelNotas(this.value)">${(a.notas||'').replace(/</g,'&lt;')}</textarea>
        `;
    }

    function refreshPanelChecklist() {
        const a = acoes.find(x => x.id === activePanelId);
        if (!a) return;
        document.getElementById('panel-body').innerHTML = buildPanelHTML(a);
        // Update row progress bar
        renderTable();
    }

    function toggleChk(idx, checked) {
        const a = acoes.find(x => x.id === activePanelId);
        if (!a || !a.checklist[idx]) return;
        a.checklist[idx].status = checked ? 'Conclu√≠da' : 'Pendente';
        persist();
        refreshPanelChecklist();
    }

    function updateChk(idx, field, value) {
        const a = acoes.find(x => x.id === activePanelId);
        if (!a || !a.checklist[idx]) return;
        a.checklist[idx][field] = value;
        persist();
    }

    function updateChkStatus(idx, value) {
        const a = acoes.find(x => x.id === activePanelId);
        if (!a || !a.checklist[idx]) return;
        a.checklist[idx].status = value;
        persist();
        refreshPanelChecklist();
    }

    function deleteChk(idx) {
        const a = acoes.find(x => x.id === activePanelId);
        if (!a) return;
        a.checklist.splice(idx, 1);
        persist();
        refreshPanelChecklist();
    }

    function addChk() {
        const a = acoes.find(x => x.id === activePanelId);
        if (!a) return;
        if (!a.checklist) a.checklist = [];
        const newId = a.checklist.length ? Math.max(...a.checklist.map(c=>c.id||0)) + 1 : 1;
        a.checklist.push({ id: newId, descricao: '', responsavel: '', prazo: '', status: 'Pendente' });
        persist();
        refreshPanelChecklist();
    }

    function updatePanelNotas(val) {
        const a = acoes.find(x => x.id === activePanelId);
        if (!a) return;
        a.notas = val;
        persist();
    }

    function savePanel() {
        persist();
        showToast('üíæ Salvo!');
        closePanel();
    }

    function closePanel() {
        document.getElementById('overlay').classList.remove('open');
        document.getElementById('side-panel').classList.remove('open');
        activePanelId = null;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // MODAL NOVA A√á√ÉO
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openModal() {
        document.getElementById('modal-overlay').classList.add('open');
        document.getElementById('m-titulo').value = '';
        document.getElementById('m-responsavel').value = '';
        document.getElementById('m-prazo').value = '';
    }

    function closeModal() {
        document.getElementById('modal-overlay').classList.remove('open');
    }

    function handleModalOverlayClick(e) {
        if (e.target === document.getElementById('modal-overlay')) closeModal();
    }

    function createAcao() {
        const titulo = document.getElementById('m-titulo').value.trim();
        if (!titulo) { alert('Informe um t√≠tulo.'); return; }
        const nova = {
            id: nextId(),
            titulo,
            imovel: document.getElementById('m-imovel').value,
            responsavel: document.getElementById('m-responsavel').value,
            prazo: document.getElementById('m-prazo').value,
            status: document.getElementById('m-status').value,
            prioridade: document.getElementById('m-prioridade').value,
            origem: document.getElementById('m-origem').value,
            notas: '',
            checklist: []
        };
        acoes.unshift(nova);
        persist();
        updateKPIs();
        renderTable();
        closeModal();
        showToast('‚úÖ A√ß√£o criada!');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // THEME
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function initTheme() {
        const saved = localStorage.getItem('theme');
        if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
        }
    }
    document.getElementById('theme-toggle').addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        document.getElementById('theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // TOAST
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let toastTimer;
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // INIT
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    initTheme();
    loadData();
    </script>
</body>
</html>
