<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Argos â€” AÃ§Ãµes</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f0f2f5;color:#1a1a2e;min-height:100vh}

/* â”€â”€â”€ TOP BAR â”€â”€â”€ */
.topbar{background:#1a1a2e;color:#fff;padding:10px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.topbar h1{font-size:1rem;font-weight:700;letter-spacing:.5px}
.topbar-actions{display:flex;gap:8px;align-items:center}
.btn-new{background:#4f8ef7;color:#fff;border:none;border-radius:8px;padding:6px 12px;font-size:.8rem;font-weight:600;cursor:pointer;white-space:nowrap}
.btn-gear{background:none;border:none;color:#aab;font-size:1.3rem;cursor:pointer;padding:4px 6px;line-height:1}
.btn-gear:hover{color:#fff}

/* â”€â”€â”€ KPI BAR â”€â”€â”€ */
.kpi-bar{display:flex;gap:8px;padding:10px 12px;overflow-x:auto;scrollbar-width:none}
.kpi-bar::-webkit-scrollbar{display:none}
.kpi{background:#fff;border-radius:10px;padding:8px 12px;flex:1;min-width:70px;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,.08)}
.kpi .val{font-size:1.4rem;font-weight:700;line-height:1.1}
.kpi .lbl{font-size:.62rem;color:#888;margin-top:2px;text-transform:uppercase;letter-spacing:.3px}
.kpi.kpi-total .val{color:#1a1a2e}
.kpi.kpi-andamento .val{color:#4f8ef7}
.kpi.kpi-concluido .val{color:#22c55e}
.kpi.kpi-atrasado .val{color:#ef4444}

/* â”€â”€â”€ SECTIONS â”€â”€â”€ */
.sections{padding:0 12px 80px}
.section{margin-bottom:8px;border-radius:12px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.07)}
.sec-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;cursor:pointer;user-select:none;font-weight:600;font-size:.85rem}
.sec-header .sec-left{display:flex;align-items:center;gap:8px}
.sec-header .sec-count{background:rgba(0,0,0,.12);border-radius:20px;padding:1px 8px;font-size:.72rem;font-weight:700}
.sec-header .chevron{font-size:.75rem;transition:transform .2s}
.sec-header.collapsed .chevron{transform:rotate(-90deg)}
.sec-body{background:#fff}

.section-concluido .sec-header{background:#dcfce7;color:#166534}
.section-andamento .sec-header{background:#dbeafe;color:#1e40af}
.section-nao-iniciado .sec-header{background:#f3f4f6;color:#374151}

/* â”€â”€â”€ ACTION ROWS â”€â”€â”€ */
.action-row{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid #f0f2f5;cursor:pointer;transition:background .15s}
.action-row:last-child{border-bottom:none}
.action-row:hover{background:#f8faff}
.status-dot{width:18px;height:18px;border-radius:50%;flex-shrink:0;cursor:pointer;border:2px solid rgba(0,0,0,.1);transition:transform .1s}
.status-dot:active{transform:scale(.85)}
.dot-concluido{background:#22c55e}
.dot-andamento{background:#4f8ef7}
.dot-nao-iniciado{background:#d1d5db}
.action-title{flex:1;font-size:.85rem;font-weight:500;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.action-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:700;color:#fff;flex-shrink:0}
.action-prazo{font-size:.72rem;color:#888;flex-shrink:0;white-space:nowrap}
.action-prazo.vencido{color:#ef4444;font-weight:600}

/* â”€â”€â”€ MODAL BASE â”€â”€â”€ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:#fff;border-radius:16px;width:100%;max-width:560px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden}
@media(max-width:600px){
  .modal{border-radius:16px 16px 0 0;max-height:95vh;position:fixed;bottom:0;left:0;right:0;max-width:none}
  .modal-overlay{align-items:flex-end}
}
.modal-header{padding:14px 16px;border-bottom:1px solid #f0f2f5;display:flex;align-items:center;justify-content:space-between}
.modal-header h2{font-size:1rem;font-weight:700}
.btn-close{background:none;border:none;font-size:1.4rem;cursor:pointer;color:#888;line-height:1;padding:2px 6px}
.modal-body{padding:16px;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:14px}
.modal-footer{padding:12px 16px;border-top:1px solid #f0f2f5;display:flex;gap:8px;justify-content:flex-end}

/* â”€â”€â”€ FORM ELEMENTS â”€â”€â”€ */
.field{display:flex;flex-direction:column;gap:4px}
.field label{font-size:.75rem;color:#666;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
.field input,.field select,.field textarea{border:1px solid #e2e8f0;border-radius:8px;padding:8px 10px;font-size:.9rem;width:100%;font-family:inherit;background:#fff;color:#1a1a2e}
.field textarea{resize:vertical;min-height:80px}
.field input:focus,.field select:focus,.field textarea:focus{outline:none;border-color:#4f8ef7;box-shadow:0 0 0 3px rgba(79,142,247,.15)}

.toggle-group{display:flex;border:1px solid #e2e8f0;border-radius:8px;overflow:hidden}
.toggle-group button{flex:1;border:none;background:#fff;padding:7px;font-size:.82rem;cursor:pointer;font-weight:500;transition:all .15s}
.toggle-group button.active{background:#4f8ef7;color:#fff;font-weight:700}
.toggle-group.priority button:nth-child(1).active{background:#ef4444}
.toggle-group.priority button:nth-child(2).active{background:#f59e0b}
.toggle-group.priority button:nth-child(3).active{background:#22c55e}

/* â”€â”€â”€ CHECKLIST â”€â”€â”€ */
.checklist-list{display:flex;flex-direction:column;gap:6px}
.checklist-item{display:flex;align-items:center;gap:6px;background:#f8faff;border-radius:8px;padding:6px 8px}
.checklist-item input[type=checkbox]{width:16px;height:16px;flex-shrink:0;cursor:pointer;accent-color:#22c55e}
.checklist-item input[type=text]{flex:1;border:none;background:transparent;font-size:.83rem;padding:0;min-width:0}
.checklist-item input[type=text]:focus{outline:none}
.checklist-item select{font-size:.75rem;border:1px solid #e2e8f0;border-radius:6px;padding:2px 4px;background:#fff;max-width:80px}
.checklist-item input[type=date]{font-size:.72rem;border:1px solid #e2e8f0;border-radius:6px;padding:2px 4px;background:#fff;max-width:110px}
.checklist-item .btn-del{background:none;border:none;color:#ef4444;cursor:pointer;font-size:.85rem;padding:2px 4px;flex-shrink:0}
.btn-add-sub{background:none;border:2px dashed #c7d2fe;color:#4f8ef7;border-radius:8px;padding:6px;font-size:.8rem;cursor:pointer;width:100%;font-weight:600;transition:all .15s}
.btn-add-sub:hover{background:#eff6ff}

/* â”€â”€â”€ BTN STYLES â”€â”€â”€ */
.btn-save{background:#22c55e;color:#fff;border:none;border-radius:8px;padding:8px 18px;font-size:.85rem;font-weight:700;cursor:pointer}
.btn-delete{background:#ef4444;color:#fff;border:none;border-radius:8px;padding:8px 18px;font-size:.85rem;font-weight:700;cursor:pointer}
.btn-cancel{background:#f3f4f6;color:#374151;border:none;border-radius:8px;padding:8px 16px;font-size:.85rem;cursor:pointer}

/* â”€â”€â”€ SETTINGS MODAL â”€â”€â”€ */
.tabs{display:flex;border-bottom:2px solid #f0f2f5;padding:0 16px}
.tab-btn{background:none;border:none;padding:10px 16px;font-size:.85rem;cursor:pointer;color:#888;font-weight:600;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s}
.tab-btn.active{color:#4f8ef7;border-bottom-color:#4f8ef7}
.tab-pane{display:none;padding:14px 16px;flex-direction:column;gap:10px}
.tab-pane.active{display:flex}

.settings-table{width:100%;border-collapse:collapse;font-size:.8rem}
.settings-table th{text-align:left;padding:6px 8px;background:#f8faff;color:#666;font-size:.72rem;text-transform:uppercase;letter-spacing:.3px;border-bottom:1px solid #e2e8f0}
.settings-table td{padding:4px 4px;vertical-align:middle;border-bottom:1px solid #f0f2f5}
.settings-table td input{border:1px solid #e2e8f0;border-radius:6px;padding:4px 6px;font-size:.8rem;width:100%}
.sigla-badge{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:50%;color:#fff;font-size:.65rem;font-weight:700}

.imovel-card{border:1px solid #e2e8f0;border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:8px}
.imovel-card .imovel-header{display:flex;justify-content:space-between;align-items:center}
.imovel-card .imovel-title{font-weight:700;font-size:.85rem}
.imovel-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.imovel-grid .full{grid-column:1/-1}
.imovel-grid input{border:1px solid #e2e8f0;border-radius:6px;padding:5px 8px;font-size:.8rem;width:100%}
.btn-add{background:#4f8ef7;color:#fff;border:none;border-radius:8px;padding:7px 14px;font-size:.8rem;font-weight:600;cursor:pointer}
.btn-del-sm{background:none;border:none;color:#ef4444;cursor:pointer;font-size:.9rem;padding:2px 6px}

/* â”€â”€â”€ EMPTY STATE â”€â”€â”€ */
.empty{padding:24px;text-align:center;color:#aaa;font-size:.85rem}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <h1>âš¡ Argos â€” AÃ§Ãµes</h1>
  <div class="topbar-actions">
    <button class="btn-new" onclick="openNewAcao()">+ Nova AÃ§Ã£o</button>
    <button class="btn-new" id="syncBtn" onclick="syncTelegram()" style="background:#0ea5e9">ğŸ“¤ Sincronizar</button>
    <button class="btn-gear" onclick="openSettings()" title="ConfiguraÃ§Ãµes">âš™ï¸</button>
  </div>
</div>

<!-- KPI BAR -->
<div class="kpi-bar">
  <div class="kpi kpi-total"><div class="val" id="kpi-total">0</div><div class="lbl">Total</div></div>
  <div class="kpi kpi-andamento"><div class="val" id="kpi-andamento">0</div><div class="lbl">Andamento</div></div>
  <div class="kpi kpi-concluido"><div class="val" id="kpi-concluido">0</div><div class="lbl">ConcluÃ­das</div></div>
  <div class="kpi kpi-atrasado"><div class="val" id="kpi-atrasado">0</div><div class="lbl">Atrasadas</div></div>
</div>

<!-- SECTIONS -->
<div class="sections">
  <div class="section section-concluido" id="sec-concluido">
    <div class="sec-header" onclick="toggleSection('concluido')">
      <div class="sec-left"><span>ğŸŸ¢ ConcluÃ­do</span><span class="sec-count" id="cnt-concluido">0</span></div>
      <span class="chevron">â–¼</span>
    </div>
    <div class="sec-body" id="body-concluido"></div>
  </div>
  <div class="section section-andamento" id="sec-andamento">
    <div class="sec-header" onclick="toggleSection('andamento')">
      <div class="sec-left"><span>ğŸ”µ Em Andamento</span><span class="sec-count" id="cnt-andamento">0</span></div>
      <span class="chevron">â–¼</span>
    </div>
    <div class="sec-body" id="body-andamento"></div>
  </div>
  <div class="section section-nao-iniciado" id="sec-nao-iniciado">
    <div class="sec-header" onclick="toggleSection('nao-iniciado')">
      <div class="sec-left"><span>âšª NÃ£o Iniciado</span><span class="sec-count" id="cnt-nao-iniciado">0</span></div>
      <span class="chevron">â–¼</span>
    </div>
    <div class="sec-body" id="body-nao-iniciado"></div>
  </div>
</div>

<!-- MODAL DETALHE AÃ‡ÃƒO -->
<div class="modal-overlay" id="modal-acao" onclick="handleOverlayClick(event,'modal-acao')">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modal-acao-title">AÃ§Ã£o</h2>
      <button class="btn-close" onclick="closeModal('modal-acao')">Ã—</button>
    </div>
    <div class="modal-body" id="modal-acao-body">
      <!-- dynamically built -->
    </div>
    <div class="modal-footer">
      <button class="btn-delete" id="btn-delete-acao" onclick="deleteAcao()">ğŸ—‘ï¸ Excluir</button>
      <button class="btn-cancel" onclick="closeModal('modal-acao')">Cancelar</button>
      <button class="btn-save" onclick="saveAcao()">âœ… Salvar</button>
    </div>
  </div>
</div>

<!-- MODAL CONFIGURAÃ‡Ã•ES -->
<div class="modal-overlay" id="modal-settings" onclick="handleOverlayClick(event,'modal-settings')">
  <div class="modal" style="max-width:620px">
    <div class="modal-header">
      <h2>âš™ï¸ ConfiguraÃ§Ãµes</h2>
      <button class="btn-close" onclick="closeModal('modal-settings')">Ã—</button>
    </div>
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('pessoas')">ğŸ‘¥ Pessoas</button>
      <button class="tab-btn" onclick="switchTab('imoveis')">ğŸ  ImÃ³veis</button>
    </div>
    <div class="tab-pane active" id="tab-pessoas" style="overflow-y:auto;max-height:60vh">
      <table class="settings-table" id="tbl-pessoas">
        <thead><tr><th>Sigla</th><th>Nome</th><th>Sobrenome</th><th>Email</th><th>Celular</th><th></th></tr></thead>
        <tbody id="tbody-pessoas"></tbody>
      </table>
      <button class="btn-add" onclick="addPessoa()">+ Adicionar</button>
    </div>
    <div class="tab-pane" id="tab-imoveis" style="overflow-y:auto;max-height:60vh">
      <div id="imoveis-list"></div>
      <button class="btn-add" onclick="addImovel()">+ Adicionar ImÃ³vel</button>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('modal-settings')">Fechar</button>
      <button class="btn-save" onclick="saveSettings()">âœ… Salvar</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TELEGRAM SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function syncTelegram() {
  const btn = document.getElementById('syncBtn');
  const orig = btn.textContent;
  btn.textContent = 'â³...'; btn.disabled = true;
  const botToken = '8032731802:AAH9E3Y_T04n5k9jUuE6f6U3g5L7h9B6E4M';
  const chatId = '8306629331';
  const message = `BOT_SYNC_ACOES:${JSON.stringify({acoes, pessoas, imoveis})}`;
  try {
    await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chat_id: chatId, text: message })
    });
    btn.textContent = 'âœ… Enviado!';
    setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 2000);
  } catch (e) {
    showToast('âš ï¸ Erro ao sincronizar: ' + e.message, 'error');
    btn.textContent = orig; btn.disabled = false;
  }
}

function showToast(msg, type = 'success') {
  let toast = document.getElementById('_toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = '_toast';
    toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:10px;font-size:.85rem;font-weight:600;z-index:9999;transition:opacity .4s;pointer-events:none;white-space:nowrap';
    document.body.appendChild(toast);
  }
  const colors = { success: '#22c55e', warn: '#f59e0b', error: '#ef4444' };
  toast.style.background = colors[type] || '#22c55e';
  toast.style.color = '#fff';
  toast.style.opacity = '1';
  toast.textContent = msg;
  clearTimeout(toast._t);
  toast._t = setTimeout(() => { toast.style.opacity = '0'; }, 3000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA LAYER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AVATAR_COLORS = ['#6366f1','#ec4899','#f59e0b','#10b981','#3b82f6','#ef4444','#8b5cf6','#14b8a6'];

function sigla(p){
  return ((p.nome||'').charAt(0) + (p.sobrenome||'').substring(0,2)).toUpperCase();
}
function avatarColor(id){return AVATAR_COLORS[(id-1)%AVATAR_COLORS.length]}

let pessoas = [];
let imoveis = [];
let acoes   = [];
let editingId = null; // null = new

async function loadData(){
  // Try localStorage first, fallback to server JSON
  const sa = localStorage.getItem('argos_acoes');
  const sp = localStorage.getItem('argos_pessoas');
  const si = localStorage.getItem('argos_imoveis');
  if (sa) acoes   = JSON.parse(sa);
  else { try { acoes   = await fetch('data/acoes.json?v='+Date.now()).then(r=>r.json()); } catch(e){ acoes=[]; } }
  if (sp) pessoas = JSON.parse(sp);
  else { try { pessoas = await fetch('data/acoes_pessoas.json?v='+Date.now()).then(r=>r.json()); } catch(e){ pessoas=[]; } }
  if (si) imoveis = JSON.parse(si);
  else { try { imoveis = await fetch('data/acoes_imoveis.json?v='+Date.now()).then(r=>r.json()); } catch(e){ imoveis=[]; } }
}

function persist(){
  localStorage.setItem('argos_pessoas', JSON.stringify(pessoas));
  localStorage.setItem('argos_imoveis', JSON.stringify(imoveis));
  localStorage.setItem('argos_acoes',   JSON.stringify(acoes));
}

function persistAndSync(commitMsg){
  persist();
  showToast('ğŸ’¾ Salvo localmente', 'success');
}

function nextId(arr){ return arr.length ? Math.max(...arr.map(x=>x.id))+1 : 1; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATUS_CYCLE = {'NÃ£o Iniciado':'Em Andamento','Em Andamento':'ConcluÃ­do','ConcluÃ­do':'NÃ£o Iniciado'};
const STATUS_DOT   = {'NÃ£o Iniciado':'dot-nao-iniciado','Em Andamento':'dot-andamento','ConcluÃ­do':'dot-concluido'};
const STATUS_SEC   = {'ConcluÃ­do':'concluido','Em Andamento':'andamento','NÃ£o Iniciado':'nao-iniciado'};

function isVencido(prazo){
  if(!prazo) return false;
  return new Date(prazo+'T23:59:59') < new Date();
}

function fmtDate(d){
  if(!d) return '';
  const [y,m,dd] = d.split('-');
  return `${dd}/${m}`;
}

function getPessoa(id){ return pessoas.find(p=>p.id===id)||null; }
function getImovel(id){ return imoveis.find(i=>i.id===id)||null; }

function render(){
  // KPIs
  const today = new Date();
  const total     = acoes.length;
  const andamento = acoes.filter(a=>a.status==='Em Andamento').length;
  const concluido = acoes.filter(a=>a.status==='ConcluÃ­do').length;
  const atrasado  = acoes.filter(a=>a.status!=='ConcluÃ­do' && isVencido(a.prazo)).length;
  document.getElementById('kpi-total').textContent     = total;
  document.getElementById('kpi-andamento').textContent = andamento;
  document.getElementById('kpi-concluido').textContent = concluido;
  document.getElementById('kpi-atrasado').textContent  = atrasado;

  // Sections
  const groups = {'concluido':[],'andamento':[],'nao-iniciado':[]};
  acoes.forEach(a=>{
    const key = STATUS_SEC[a.status]||'nao-iniciado';
    groups[key].push(a);
  });

  ['concluido','andamento','nao-iniciado'].forEach(sec=>{
    const list = groups[sec];
    document.getElementById('cnt-'+sec).textContent = list.length;
    const body = document.getElementById('body-'+sec);
    if(!list.length){ body.innerHTML='<div class="empty">Nenhuma aÃ§Ã£o</div>'; return; }
    body.innerHTML = list.map(a=>{
      const p = a.responsavel_id ? getPessoa(a.responsavel_id) : null;
      const dotClass = STATUS_DOT[a.status]||'dot-nao-iniciado';
      const vencido = isVencido(a.prazo) && a.status!=='ConcluÃ­do';
      const prazoHtml = a.prazo ? `<span class="action-prazo${vencido?' vencido':''}">${fmtDate(a.prazo)}</span>` : '';
      const avatarHtml = p
        ? `<div class="action-avatar" style="background:${avatarColor(p.id)}" title="${p.nome} ${p.sobrenome}">${sigla(p)}</div>`
        : '';
      return `<div class="action-row" data-id="${a.id}">
        <div class="status-dot ${dotClass}" title="AvanÃ§ar status" onclick="cycleStatus(event,${a.id})"></div>
        <div class="action-title">${esc(a.titulo||'Sem tÃ­tulo')}</div>
        ${avatarHtml}
        ${prazoHtml}
      </div>`;
    }).join('');
    // click on row â†’ open detail (handled via delegation)
  });

  // Row click delegation
  document.querySelectorAll('.action-row').forEach(row=>{
    row.addEventListener('click', e=>{
      if(e.target.classList.contains('status-dot')) return;
      openAcaoDetail(parseInt(row.dataset.id));
    });
  });
}

function esc(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

function toggleSection(sec){
  const body   = document.getElementById('body-'+sec);
  const header = body.previousElementSibling;
  const collapsed = body.style.display==='none';
  body.style.display = collapsed ? '' : 'none';
  header.classList.toggle('collapsed', !collapsed);
}

async function cycleStatus(e, id){
  e.stopPropagation();
  const a = acoes.find(x=>x.id===id);
  if(!a) return;
  a.status = STATUS_CYCLE[a.status]||'NÃ£o Iniciado';
  render();
  await persistAndSync(`update: status "${a.titulo}" â†’ ${a.status}`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL DETALHE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openNewAcao(){
  editingId = null;
  buildDetailModal({
    id:null, titulo:'', imovel_id:null, responsavel_id:null,
    prioridade:'media', prazo:'', status:'NÃ£o Iniciado',
    checklist:[], observacoes:''
  });
  document.getElementById('modal-acao-title').textContent = 'Nova AÃ§Ã£o';
  document.getElementById('btn-delete-acao').style.display = 'none';
  openModal('modal-acao');
}

function openAcaoDetail(id){
  const a = acoes.find(x=>x.id===id);
  if(!a) return;
  editingId = id;
  buildDetailModal(a);
  document.getElementById('modal-acao-title').textContent = 'Detalhe da AÃ§Ã£o';
  document.getElementById('btn-delete-acao').style.display = '';
  openModal('modal-acao');
}

function buildDetailModal(a){
  const imoveisOptions = imoveis.map(i=>`<option value="${i.id}" ${a.imovel_id===i.id?'selected':''}>${esc(i.nome)}</option>`).join('');
  const pessoasOptions = `<option value="">â€” Nenhum â€”</option>` + pessoas.map(p=>`<option value="${p.id}" ${a.responsavel_id===p.id?'selected':''}>${sigla(p)} â€” ${esc(p.nome)} ${esc(p.sobrenome)}</option>`).join('');
  const isImovel = a.imovel_id !== null && a.imovel_id !== undefined;

  const checklistHtml = (a.checklist||[]).map((c,i)=>renderChecklistItem(c,i)).join('');

  document.getElementById('modal-acao-body').innerHTML = `
    <div class="field">
      <label>TÃ­tulo</label>
      <input type="text" id="d-titulo" value="${esc(a.titulo||'')}" placeholder="TÃ­tulo da aÃ§Ã£o"/>
    </div>
    <div class="field">
      <label>Escopo</label>
      <div class="toggle-group" id="tg-escopo">
        <button type="button" class="${!isImovel?'active':''}" onclick="setEscopo('geral')">ğŸŒ Geral</button>
        <button type="button" class="${isImovel?'active':''}" onclick="setEscopo('imovel')">ğŸ  ImÃ³vel</button>
      </div>
      <div id="imovel-select-wrap" style="display:${isImovel?'block':'none'};margin-top:6px">
        <select id="d-imovel">${imoveisOptions}</select>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="field">
        <label>ResponsÃ¡vel</label>
        <select id="d-responsavel">${pessoasOptions}</select>
      </div>
      <div class="field">
        <label>Prazo</label>
        <input type="date" id="d-prazo" value="${a.prazo||''}"/>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="field">
        <label>Prioridade</label>
        <div class="toggle-group priority" id="tg-prio">
          <button type="button" class="${a.prioridade==='alta'?'active':''}" onclick="setPrio('alta')">ğŸ”´ Alta</button>
          <button type="button" class="${a.prioridade==='media'||!a.prioridade?'active':''}" onclick="setPrio('media')">ğŸŸ¡ MÃ©dia</button>
          <button type="button" class="${a.prioridade==='baixa'?'active':''}" onclick="setPrio('baixa')">ğŸŸ¢ Baixa</button>
        </div>
      </div>
      <div class="field">
        <label>Status</label>
        <select id="d-status">
          <option ${a.status==='NÃ£o Iniciado'?'selected':''}>NÃ£o Iniciado</option>
          <option ${a.status==='Em Andamento'?'selected':''}>Em Andamento</option>
          <option ${a.status==='ConcluÃ­do'?'selected':''}>ConcluÃ­do</option>
        </select>
      </div>
    </div>
    <div class="field">
      <label>Checklist</label>
      <div class="checklist-list" id="checklist-list">${checklistHtml}</div>
      <button class="btn-add-sub" onclick="addChecklistItem()">+ Sub-tarefa</button>
    </div>
    <div class="field">
      <label>ObservaÃ§Ãµes</label>
      <textarea id="d-obs" rows="4" placeholder="HistÃ³rico, origem, anotaÃ§Ãµes...">${esc(a.observacoes||'')}</textarea>
    </div>
  `;
}

function renderChecklistItem(c, idx){
  const pessoasOptions = `<option value="">â€”</option>` + pessoas.map(p=>`<option value="${p.id}" ${c.responsavel_id===p.id?'selected':''}>${sigla(p)}</option>`).join('');
  return `<div class="checklist-item" data-cidx="${idx}">
    <input type="checkbox" ${c.concluido?'checked':''} onchange="checklistCheck(this,${idx})"/>
    <input type="text" value="${esc(c.descricao||'')}" placeholder="DescriÃ§Ã£o..." onchange="checklistDesc(this,${idx})"/>
    <select onchange="checklistResp(this,${idx})">${pessoasOptions}</select>
    <input type="date" value="${c.prazo||''}" onchange="checklistPrazo(this,${idx})"/>
    <button class="btn-del" onclick="removeChecklist(${idx})">ğŸ—‘ï¸</button>
  </div>`;
}

// temp checklist state while editing
let _editChecklist = [];
let _editEscopo = 'geral';
let _editPrio = 'media';

function getEditingAcao(){
  // build from current modal fields
  const titleEl = document.getElementById('d-titulo');
  if(!titleEl) return null;
  const imovel_id = _editEscopo==='imovel' ? (parseInt(document.getElementById('d-imovel')?.value)||null) : null;
  const resp_id   = parseInt(document.getElementById('d-responsavel')?.value)||null;
  return {
    titulo:       document.getElementById('d-titulo').value.trim(),
    imovel_id:    imovel_id,
    responsavel_id: resp_id,
    prioridade:   _editPrio,
    prazo:        document.getElementById('d-prazo').value,
    status:       document.getElementById('d-status').value,
    checklist:    _editChecklist,
    observacoes:  document.getElementById('d-obs').value,
  };
}

function setEscopo(v){
  _editEscopo = v;
  document.querySelectorAll('#tg-escopo button').forEach((b,i)=>b.classList.toggle('active',(v==='geral'&&i===0)||(v==='imovel'&&i===1)));
  document.getElementById('imovel-select-wrap').style.display = v==='imovel'?'block':'none';
}
function setPrio(v){
  _editPrio = v;
  document.querySelectorAll('#tg-prio button').forEach((b,i)=>b.classList.toggle('active',['alta','media','baixa'][i]===v));
}
function addChecklistItem(){
  _editChecklist.push({id:nextId(_editChecklist),descricao:'',responsavel_id:null,prazo:'',concluido:false});
  reRenderChecklist();
}
function removeChecklist(idx){
  _editChecklist.splice(idx,1);
  reRenderChecklist();
}
function checklistCheck(el,idx){ _editChecklist[idx].concluido = el.checked; }
function checklistDesc(el,idx){ _editChecklist[idx].descricao = el.value; }
function checklistResp(el,idx){ _editChecklist[idx].responsavel_id = parseInt(el.value)||null; }
function checklistPrazo(el,idx){ _editChecklist[idx].prazo = el.value; }
function reRenderChecklist(){
  document.getElementById('checklist-list').innerHTML = _editChecklist.map((c,i)=>renderChecklistItem(c,i)).join('');
}

// Override buildDetailModal to init temp state
const _origBuild = buildDetailModal;
// patch: call after build
const origBuildDetail = buildDetailModal;
window.buildDetailModal = function(a){
  _editChecklist = JSON.parse(JSON.stringify(a.checklist||[]));
  _editEscopo    = (a.imovel_id!==null && a.imovel_id!==undefined) ? 'imovel' : 'geral';
  _editPrio      = a.prioridade||'media';
  origBuildDetail(a);
};

async function saveAcao(){
  const data = getEditingAcao();
  if(!data) return;
  if(!data.titulo){ alert('Informe um tÃ­tulo.'); return; }
  let commitMsg;
  if(editingId){
    const idx = acoes.findIndex(a=>a.id===editingId);
    if(idx>=0) acoes[idx] = {...acoes[idx], ...data};
    commitMsg = `update: aÃ§Ã£o "${data.titulo}"`;
  } else {
    acoes.push({id:nextId(acoes), ...data});
    commitMsg = `feat: nova aÃ§Ã£o "${data.titulo}"`;
  }
  closeModal('modal-acao');
  render();
  await persistAndSync(commitMsg);
}

async function deleteAcao(){
  if(!confirm('Excluir esta aÃ§Ã£o?')) return;
  const titulo = acoes.find(a=>a.id===editingId)?.titulo || 'aÃ§Ã£o';
  acoes = acoes.filter(a=>a.id!==editingId);
  closeModal('modal-acao');
  render();
  await persistAndSync(`delete: aÃ§Ã£o "${titulo}"`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSettings(){
  renderPessoasTable();
  renderImoveisCards();
  openModal('modal-settings');
}

function switchTab(tab){
  document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',['pessoas','imoveis'][i]===tab));
  document.getElementById('tab-pessoas').classList.toggle('active',tab==='pessoas');
  document.getElementById('tab-imoveis').classList.toggle('active',tab==='imoveis');
}

function renderPessoasTable(){
  document.getElementById('tbody-pessoas').innerHTML = pessoas.map((p,i)=>`
    <tr data-pidx="${i}">
      <td><div class="sigla-badge" style="background:${avatarColor(p.id)}">${sigla(p)}</div></td>
      <td><input type="text" value="${esc(p.nome||'')}" onchange="updatePessoa(${i},'nome',this.value)"/></td>
      <td><input type="text" value="${esc(p.sobrenome||'')}" onchange="updatePessoa(${i},'sobrenome',this.value)"/></td>
      <td><input type="text" value="${esc(p.email||'')}" onchange="updatePessoa(${i},'email',this.value)"/></td>
      <td><input type="text" value="${esc(p.celular||'')}" onchange="updatePessoa(${i},'celular',this.value)"/></td>
      <td><button class="btn-del-sm" onclick="removePessoa(${i})">ğŸ—‘ï¸</button></td>
    </tr>
  `).join('');
}

function updatePessoa(idx, field, val){
  pessoas[idx][field] = val;
  // re-render sigla cell
  const row = document.querySelector(`#tbody-pessoas tr[data-pidx="${idx}"]`);
  if(row) row.querySelector('.sigla-badge').textContent = sigla(pessoas[idx]);
}
function addPessoa(){
  pessoas.push({id:nextId(pessoas),nome:'',sobrenome:'',email:'',celular:''});
  renderPessoasTable();
}
function removePessoa(idx){
  pessoas.splice(idx,1);
  renderPessoasTable();
}

function renderImoveisCards(){
  document.getElementById('imoveis-list').innerHTML = imoveis.map((im,i)=>`
    <div class="imovel-card" data-iidx="${i}">
      <div class="imovel-header">
        <span class="imovel-title">ğŸ  ${esc(im.nome||'ImÃ³vel')}</span>
        <button class="btn-del-sm" onclick="removeImovel(${i})">ğŸ—‘ï¸</button>
      </div>
      <div class="imovel-grid">
        <div class="full"><label style="font-size:.72rem;color:#888">Nome</label><input type="text" value="${esc(im.nome||'')}" placeholder="Nome do imÃ³vel" onchange="updateImovel(${i},'nome',this.value)"/></div>
        <div><label style="font-size:.72rem;color:#888">CEP</label><input type="text" value="${esc(im.cep||'')}" placeholder="00000-000" onblur="fetchCEP(${i},this.value)" onchange="updateImovel(${i},'cep',this.value)"/></div>
        <div><label style="font-size:.72rem;color:#888">NÃºmero</label><input type="text" value="${esc(im.numero||'')}" placeholder="NÂº" onchange="updateImovel(${i},'numero',this.value)"/></div>
        <div class="full"><label style="font-size:.72rem;color:#888">Logradouro</label><input type="text" id="im-logr-${i}" value="${esc(im.logradouro||'')}" onchange="updateImovel(${i},'logradouro',this.value)"/></div>
        <div><label style="font-size:.72rem;color:#888">Complemento</label><input type="text" value="${esc(im.complemento||'')}" onchange="updateImovel(${i},'complemento',this.value)"/></div>
        <div><label style="font-size:.72rem;color:#888">Bairro</label><input type="text" id="im-bairro-${i}" value="${esc(im.bairro||'')}" onchange="updateImovel(${i},'bairro',this.value)"/></div>
        <div><label style="font-size:.72rem;color:#888">Cidade</label><input type="text" id="im-cidade-${i}" value="${esc(im.cidade||'')}" onchange="updateImovel(${i},'cidade',this.value)"/></div>
        <div><label style="font-size:.72rem;color:#888">Estado</label><input type="text" id="im-estado-${i}" value="${esc(im.estado||'')}" onchange="updateImovel(${i},'estado',this.value)"/></div>
      </div>
    </div>
  `).join('');
}

function updateImovel(idx, field, val){ imoveis[idx][field] = val; }
function addImovel(){
  imoveis.push({id:nextId(imoveis),nome:'Novo ImÃ³vel',cep:'',logradouro:'',numero:'',complemento:'',bairro:'',cidade:'',estado:''});
  renderImoveisCards();
}
function removeImovel(idx){ imoveis.splice(idx,1); renderImoveisCards(); }

async function fetchCEP(idx, cep){
  const clean = cep.replace(/\D/g,'');
  if(clean.length!==8) return;
  try{
    const data = await fetch(`https://viacep.com.br/ws/${clean}/json/`).then(r=>r.json());
    if(data.erro) return;
    updateImovel(idx,'logradouro',data.logradouro||'');
    updateImovel(idx,'bairro',data.bairro||'');
    updateImovel(idx,'cidade',data.localidade||'');
    updateImovel(idx,'estado',data.uf||'');
    const set = (id,v)=>{ const el=document.getElementById(id); if(el) el.value=v; };
    set(`im-logr-${idx}`,  data.logradouro||'');
    set(`im-bairro-${idx}`,data.bairro||'');
    set(`im-cidade-${idx}`,data.localidade||'');
    set(`im-estado-${idx}`,data.uf||'');
  }catch(e){}
}

async function saveSettings(){
  closeModal('modal-settings');
  render();
  await persistAndSync('update: pessoas e imÃ³veis');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function handleOverlayClick(e, id){ if(e.target.id===id) closeModal(id); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadData().then(()=>render());
</script>
</body>
</html>
