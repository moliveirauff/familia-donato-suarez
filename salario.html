<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Dashboard de Sal√°rio</title>
    <meta name="version" content="v1.13.2">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>
    <style>
        :root {
            --bg: #f7fafc;
            --text: #2d3748;
            --surface: #ffffff;
            --card-bg: var(--surface);
            --border: #e2e8f0;
            --text-muted: #718096;
            --subtext: var(--text-muted);
            --primary: #667eea;
            --primary-dark: #5568d3;
            --accent: #48bb78;
            --accent-dark: #38a169;
            --accent-light: #f0fff4;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --green: #48bb78;
            --yellow: #ed8936;
            --red: #f56565;
            --shadow: 0 1px 3px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.06);
        }
        body.dark-mode {
            --bg: #1a202c;
            --text: #f7fafc;
            --surface: #2d3748;
            --card-bg: var(--surface);
            --border: #4a5568;
            --text-muted: #cbd5e0;
            --subtext: var(--text-muted);
            --primary: #7f9cf5;
            --accent: #68d391;
            --accent-dark: #48bb78;
            --accent-light: #1c3a2a;
            --green: #68d391;
            --yellow: #f6ad55;
            --red: #fc8181;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s;
            padding: 10px 10px 60px 10px;
        }
        #theme-toggle {
            position: absolute; top: 12px; right: 12px;
            background: rgba(0,0,0,0.05); border: none; font-size: 1.2rem; cursor: pointer;
            padding: 8px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            z-index: 10; transition: background 0.2s;
        }
        body.dark-mode #theme-toggle { background: rgba(255,255,255,0.1); }
        .nav-link {
            text-decoration: none;
            color: var(--primary);
            font-size: 0.9rem;
            margin: 10px 0 0 4px;
            display: inline-block;
        }
        h1 {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 800;
            margin: 10px 44px 4px 44px;
            color: var(--text);
        }
        .page-subtitle {
            text-align: center;
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-bottom: 18px;
        }
        .card {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .chart-container { position: relative; height: 300px; width: 100%; }
        @media (min-width: 768px) {
            body { max-width: 960px; margin: 0 auto; padding: 16px 16px 60px 16px; }
            .chart-container { height: 380px; }
            .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            h1 { font-size: 1.75rem; }
        }
        .cc-kpi-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        @media (max-width: 599px) { .cc-kpi-grid { grid-template-columns: 1fr 1fr; } }
        .cc-kpi-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            box-shadow: var(--shadow);
        }
        .cc-kpi-label { font-size: 0.6rem; font-weight: 800; color: var(--subtext); text-transform: uppercase; margin-bottom: 4px; display: block; letter-spacing: 0.05em; }
        .cc-kpi-value { font-size: 1.05rem; font-weight: 800; color: var(--text); line-height: 1.2; }
        .cc-kpi-ratio { font-size: 0.65rem; color: var(--text-muted); margin-top: 2px; font-weight: 600; }
        .slider-section {
            background: var(--card-bg);
            padding: 25px 25px 15px 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }
        #range-slider { height: 6px; border: none; background: var(--border); }
        .noUi-connect { background: var(--accent); }
        .noUi-handle { 
            width: 22px !important; height: 22px !important; 
            border-radius: 50% !important; 
            right: -11px !important; top: -9px !important; 
            background: var(--accent) !important; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important; 
            border: 3px solid #fff !important; 
            cursor: pointer;
        }
        .noUi-handle:before, .noUi-handle:after { display: none; }
        .slider-labels { display: flex; justify-content: space-between; margin-top: 15px; font-size: 0.85rem; font-weight: 800; color: var(--accent); }
        .chart-header-center {
            text-align: center;
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 15px;
            display: block;
            width: 100%;
        }
        .nav-header-center {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        .nav-btn {
            background: var(--border);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text);
        }
        .nav-btn:hover { background: var(--accent); color: white; }
        .nav-title { font-size: 1rem; font-weight: 800; color: var(--text); min-width: 110px; text-align: center; }
    </style>
</head>
<body>
    <button id="theme-toggle" onclick="toggleTheme()">üåô</button>
    <a href="index.html" class="nav-link">‚Üê Voltar para In√≠cio</a>
    <h1>üí∞ Dashboard de Sal√°rio</h1>
    <p id="last-update" class="page-subtitle" style="display:none;"></p>

    <div id="tab1">
        <div class="cc-kpi-grid">
            <div class="cc-kpi-card">
                <span class="cc-kpi-label">Base Atual</span>
                <span class="cc-kpi-value" id="kpi-base-atual">-</span>
            </div>
            <div class="cc-kpi-card">
                <span class="cc-kpi-label">Bruto M√©dio</span>
                <span class="cc-kpi-value" id="kpi-bruto-avg">-</span>
                <div class="cc-kpi-ratio" id="kpi-bruto-ratio">-</div>
            </div>
            <div class="cc-kpi-card">
                <span class="cc-kpi-label">L√≠quido M√©dio</span>
                <span class="cc-kpi-value" id="kpi-liq-avg">-</span>
                <div class="cc-kpi-ratio" id="kpi-liq-ratio">-</div>
            </div>
            <div class="cc-kpi-card">
                <span class="cc-kpi-label">Bruto Total (12m)</span>
                <span class="cc-kpi-value" id="kpi-bruto-total">-</span>
            </div>
            <div class="cc-kpi-card">
                <span class="cc-kpi-label">CAGR (5 Anos)</span>
                <span class="cc-kpi-value" id="kpi-cagr-5y">-</span>
                <div class="cc-kpi-ratio" id="kpi-cagr-total">-</div>
            </div>
            <div class="cc-kpi-card">
                <span class="cc-kpi-label">Desconto M√©dio</span>
                <span class="cc-kpi-value" id="kpi-discount-avg">-</span>
            </div>
        </div>

        <div class="slider-section">
            <div id="range-slider"></div>
            <div class="slider-labels">
                <span id="slider-min-val">-</span>
                <span id="slider-max-val">-</span>
            </div>
        </div>

        <div class="card">
            <span class="chart-header-center">Total Sal√°rio Base por Ano</span>
            <div class="chart-container"><canvas id="cTotalBaseAno"></canvas></div>
        </div>

        <div class="grid-2">
            <div class="card">
                <span class="chart-header-center">Total Bruto por Ano</span>
                <div class="chart-container"><canvas id="cTotalBrutoAno"></canvas></div>
            </div>
            <div class="card">
                <span class="chart-header-center">Total L√≠quido por Ano</span>
                <div class="chart-container"><canvas id="cTotalLiqAno"></canvas></div>
            </div>
        </div>

        <div class="grid-2">
            <div class="card">
                <span class="chart-header-center">Carga de Descontos Anual</span>
                <div class="chart-container"><canvas id="cLinhaDescontos"></canvas></div>
            </div>
            <div class="card">
                <span class="chart-header-center">Composi√ß√£o de Descontos</span>
                <div class="nav-header-center">
                    <button class="nav-btn" onclick="navPizza(-1)">‚ùÆ</button>
                    <div class="nav-title" id="pie-year-title">-</div>
                    <button class="nav-btn" onclick="navPizza(1)">‚ùØ</button>
                </div>
                <div class="chart-container"><canvas id="cPizzaDescontos"></canvas></div>
            </div>
        </div>

        <div class="card">
            <span class="chart-header-center">Waterfall Mensal Detalhado</span>
            <div class="nav-header-center">
                <button class="nav-btn" onclick="navWaterfall(-1)">‚ùÆ</button>
                <div class="nav-title" id="wf-month-title">-</div>
                <button class="nav-btn" onclick="navWaterfall(1)">‚ùØ</button>
            </div>
            <div class="chart-container"><canvas id="cWaterfall"></canvas></div>
        </div>
    </div>

    <script>
        let contraChequeData = [];
        let charts = {};
        let wfIndex = 0;
        let pieYearIdx = 0;
        let slider = null;
        let sortedYears = [];

        function brl(v) {
            return 'R$ ' + Math.abs(v).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('theme-toggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            Chart.defaults.color = isDark ? '#cbd5e0' : '#666';
            Chart.defaults.borderColor = isDark ? '#4a5568' : '#e2e8f0';
            if (contraChequeData.length > 0) renderContraCheque();
        }

        async function loadContraCheque() {
            try {
                const res = await fetch('./data/contra_cheque.json?v=' + Date.now());
                contraChequeData = await res.json();
                const years = [...new Set(contraChequeData.map(d => '20'+d.mes_referencia.split('/')[1]))].sort();
                sortedYears = years;
                pieYearIdx = years.length - 1;
                wfIndex = contraChequeData.length - 1;
                initSlider();
                renderContraCheque();
            } catch (e) { console.error(e); }
        }

        function initSlider() {
            if (slider) return;
            const sliderEl = document.getElementById('range-slider');
            const years = sortedYears.map(y => parseInt(y));
            const min = Math.min(...years);
            const max = Math.max(...years);
            noUiSlider.create(sliderEl, {
                start: [min, max],
                connect: true,
                step: 1,
                range: { 'min': min, 'max': max },
                format: { to: v => Math.round(v), from: v => v }
            });
            slider = sliderEl.noUiSlider;
            slider.on('slide', (values) => {
                document.getElementById('slider-min-val').innerText = values[0];
                document.getElementById('slider-max-val').innerText = values[1];
            });
            slider.on('set', () => { renderContraCheque(); });
            document.getElementById('slider-min-val').innerText = min;
            document.getElementById('slider-max-val').innerText = max;
        }

        function getProjBase(yearData, curBase, isComplete) {
            if (isComplete) return yearData.reduce((s, d) => s + d.salario_base, 0);
            const months = yearData.length;
            const hasVariation = new Set(yearData.map(d => d.salario_base)).size > 1;
            let projectedTotal = yearData.reduce((s, d) => s + d.salario_base, 0);
            for (let m = months + 1; m <= 12; m++) {
                let base = curBase;
                if (!hasVariation && m >= 10) base = curBase * 1.05;
                projectedTotal += base;
            }
            return projectedTotal + (curBase * 1.3);
        }

        function renderContraCheque() {
            if (!contraChequeData.length) return;
            const range = slider ? slider.get() : [sortedYears[0], sortedYears[sortedYears.length-1]];
            const startYear = parseInt(range[0]);
            const endYear = parseInt(range[1]);
            const filtered = contraChequeData.filter(d => {
                const y = parseInt('20' + d.mes_referencia.split('/')[1]);
                return y >= startYear && y <= endYear;
            });
            const current = contraChequeData[contraChequeData.length - 1];
            const last12 = contraChequeData.slice(-12);
            const brutoAvg12 = last12.reduce((s, d) => s + d.salario_bruto, 0) / 12;
            const liqAvg12 = last12.reduce((s, d) => s + d.salario_liquido, 0) / 12;
            const baseAvg12 = last12.reduce((s, d) => s + d.salario_base, 0) / 12;
            const brutoTotal12 = last12.reduce((s, d) => s + d.salario_bruto, 0);
            const discAvg12 = (1 - (liqAvg12 / brutoAvg12)) * 100;
            const cagr = (start, end, years) => (Math.pow(end / start, 1 / years) - 1) * 100;
            const c5y = cagr(contraChequeData[Math.max(0, contraChequeData.length - 61)].salario_base, current.salario_base, 5);
            const cTotal = cagr(contraChequeData[0].salario_base, current.salario_base, contraChequeData.length / 12);
            document.getElementById('kpi-base-atual').innerText = brl(current.salario_base);
            document.getElementById('kpi-bruto-avg').innerText = brl(brutoAvg12);
            document.getElementById('kpi-bruto-ratio').innerText = `${(brutoAvg12 / baseAvg12).toFixed(2)}x (Bruto/Base)`;
            document.getElementById('kpi-liq-avg').innerText = brl(liqAvg12);
            document.getElementById('kpi-liq-ratio').innerText = `Ratio: ${(liqAvg12 / baseAvg12).toFixed(2)}x (L√≠q/Base)`;
            document.getElementById('kpi-bruto-total').innerText = brl(brutoTotal12);
            document.getElementById('kpi-cagr-5y').innerText = c5y.toFixed(1) + '%';
            document.getElementById('kpi-cagr-total').innerText = `Desde 2012: ${cTotal.toFixed(1)}%`;
            document.getElementById('kpi-discount-avg').innerText = discAvg12.toFixed(1) + '%';
            const yearsMap = {};
            contraChequeData.forEach(d => {
                const y = '20' + d.mes_referencia.split('/')[1];
                if (!yearsMap[y]) yearsMap[y] = [];
                yearsMap[y].push(d);
            });
            const ratioBruto = brutoAvg12 / baseAvg12;
            const ratioLiq = liqAvg12 / baseAvg12;
            const chartYears = Object.keys(yearsMap).filter(y => parseInt(y) >= startYear && parseInt(y) <= endYear).sort();
            const dataBase = [];
            const dataBrutoReal = [];
            const dataBrutoProj = [];
            const dataLiqReal = [];
            const dataLiqProj = [];
            const dataDescAnual = [];
            chartYears.forEach(y => {
                const yearData = yearsMap[y];
                const isComplete = yearData.length === 12;
                const baseProj = getProjBase(yearData, current.salario_base, isComplete);
                dataBase.push(baseProj);
                const realBruto = yearData.reduce((s, d) => s + d.salario_bruto, 0);
                const realLiq = yearData.reduce((s, d) => s + d.salario_liquido, 0);
                dataDescAnual.push((1 - (realLiq / realBruto)) * 100);
                if (isComplete) {
                    dataBrutoReal.push(realBruto); dataBrutoProj.push(0);
                    dataLiqReal.push(realLiq); dataLiqProj.push(0);
                } else {
                    const totalProjBruto = baseProj * ratioBruto;
                    const totalProjLiq = baseProj * ratioLiq;
                    dataBrutoReal.push(realBruto); dataBrutoProj.push(totalProjBruto - realBruto);
                    dataLiqReal.push(realLiq); dataLiqProj.push(totalProjLiq - realLiq);
                }
            });
            renderChart('cTotalBaseAno', 'bar', chartYears, [{ label: 'Total Base', data: dataBase, backgroundColor: '#667eea' }]);
            renderChart('cTotalBrutoAno', 'bar', chartYears, [
                { label: 'Realizado', data: dataBrutoReal, backgroundColor: '#3498db', stack: 'a' },
                { label: 'Projetado', data: dataBrutoProj, backgroundColor: 'rgba(52, 152, 219, 0.4)', stack: 'a' }
            ], true);
            renderChart('cTotalLiqAno', 'bar', chartYears, [
                { label: 'Realizado', data: dataLiqReal, backgroundColor: '#2ecc71', stack: 'a' },
                { label: 'Projetado', data: dataLiqProj, backgroundColor: 'rgba(46, 204, 113, 0.4)', stack: 'a' }
            ], true);
            renderChart('cLinhaDescontos', 'line', chartYears, [{ label: '% M√©dio Anual', data: dataDescAnual, borderColor: '#f56565', tension: 0.3, fill: false }]);
            updatePizza();
            updateWaterfall();
        }

        function navPizza(dir) {
            pieYearIdx = Math.max(0, Math.min(sortedYears.length - 1, pieYearIdx + dir));
            updatePizza();
        }

        function updatePizza() {
            const year = sortedYears[pieYearIdx];
            document.getElementById('pie-year-title').innerText = year;
            const yearData = contraChequeData.filter(d => '20' + d.mes_referencia.split('/')[1] === year);
            const sum = (field) => yearData.reduce((s, d) => s + (d.descontos[field] || 0), 0);
            const totals = [sum('inss'), sum('irrf'), sum('previdencia_privada'), sum('outros')];
            renderChart('cPizzaDescontos', 'pie', ['INSS', 'IRRF', 'Prev. Privada', 'Outros'], [{
                data: totals, backgroundColor: ['#ed8936', '#f56565', '#4299e1', '#a0aec0']
            }]);
        }

        function renderChart(id, type, labels, datasets, stacked = false) {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: type, data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: type !== 'bar', position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } },
                        tooltip: { callbacks: { label: ctx => ` ${ctx.dataset.label}: ${type === 'line' ? ctx.parsed.y.toFixed(1)+'%' : brl(ctx.parsed.y)}` } }
                    },
                    scales: type === 'pie' ? {} : {
                        x: { stacked, ticks: { font: { size: 9 } } },
                        y: { stacked, ticks: { callback: v => type === 'line' ? v+'%' : 'R$ '+(v/1000).toFixed(0)+'k' } }
                    }
                }
            });
        }

        function navWaterfall(dir) {
            wfIndex = Math.max(0, Math.min(contraChequeData.length - 1, wfIndex + dir));
            updateWaterfall();
        }

        function updateWaterfall() {
            const d = contraChequeData[wfIndex];
            document.getElementById('wf-month-title').innerText = d.mes_referencia;
            const ctx = document.getElementById('cWaterfall').getContext('2d');
            const brutoExtra = d.salario_bruto - d.salario_base;
            const labels = ['Base', 'Adic. Bruto', 'INSS', 'IRRF', 'Prev. Privada', 'Outros', 'L√≠quido'];
            const data = [
                [0, d.salario_base], [d.salario_base, d.salario_bruto],
                [d.salario_bruto - d.descontos.inss, d.salario_bruto],
                [d.salario_bruto - d.descontos.inss - d.descontos.irrf, d.salario_bruto - d.descontos.inss],
                [d.salario_bruto - d.descontos.inss - d.descontos.irrf - d.descontos.previdencia_privada, d.salario_bruto - d.descontos.inss - d.descontos.irrf],
                [d.salario_liquido, d.salario_liquido + d.descontos.outros], [0, d.salario_liquido]
            ];
            const colors = ['#667eea', brutoExtra >= 0 ? '#48bb78' : '#f56565', '#f56565', '#f56565', '#f56565', '#f56565', '#48bb78'];
            if (charts['cWaterfall']) charts['cWaterfall'].destroy();
            charts['cWaterfall'] = new Chart(ctx, {
                type: 'bar', data: { labels, datasets: [{ data, backgroundColor: colors, barPercentage: 0.8 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ` ${brl(Math.abs(ctx.raw[1] - ctx.raw[0]))}` } } },
                    scales: { y: { ticks: { callback: v => 'R$ '+(v/1000).toFixed(0)+'k' } } }
                }
            });
        }

        async function init() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
            }
            loadContraCheque();
        }
        init();
    </script>
</body>
</html>
